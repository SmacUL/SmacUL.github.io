<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>字幕音频视频生成器 | SmacUL&#39;s Blog</title>
    <meta name="description" content="你好">
    <link rel="icon" href="/assets/img/Logo.png">
    
    <link rel="preload" href="/assets/css/0.styles.e8ff0ee6.css" as="style"><link rel="preload" href="/assets/js/app.27d58fa7.js" as="script"><link rel="preload" href="/assets/js/2.f1f09924.js" as="script"><link rel="preload" href="/assets/js/33.b68ce17c.js" as="script"><link rel="prefetch" href="/assets/js/10.da04177b.js"><link rel="prefetch" href="/assets/js/11.33537db2.js"><link rel="prefetch" href="/assets/js/12.2c196981.js"><link rel="prefetch" href="/assets/js/13.501a5542.js"><link rel="prefetch" href="/assets/js/14.93a9b12d.js"><link rel="prefetch" href="/assets/js/15.7ddd6566.js"><link rel="prefetch" href="/assets/js/16.32ee58e2.js"><link rel="prefetch" href="/assets/js/17.c415498a.js"><link rel="prefetch" href="/assets/js/18.5ef64d19.js"><link rel="prefetch" href="/assets/js/19.521006c9.js"><link rel="prefetch" href="/assets/js/20.1aa33ed7.js"><link rel="prefetch" href="/assets/js/21.82b9d691.js"><link rel="prefetch" href="/assets/js/22.793f9d85.js"><link rel="prefetch" href="/assets/js/23.0ca70d66.js"><link rel="prefetch" href="/assets/js/24.d86f1591.js"><link rel="prefetch" href="/assets/js/25.2ce3a84b.js"><link rel="prefetch" href="/assets/js/26.12cdc3ac.js"><link rel="prefetch" href="/assets/js/27.7b341d36.js"><link rel="prefetch" href="/assets/js/28.61c57439.js"><link rel="prefetch" href="/assets/js/29.90d6873f.js"><link rel="prefetch" href="/assets/js/3.7db0d588.js"><link rel="prefetch" href="/assets/js/30.4f5e13f5.js"><link rel="prefetch" href="/assets/js/31.7ec86adf.js"><link rel="prefetch" href="/assets/js/32.0c179479.js"><link rel="prefetch" href="/assets/js/34.6d314a9c.js"><link rel="prefetch" href="/assets/js/35.15ecee78.js"><link rel="prefetch" href="/assets/js/36.d6998519.js"><link rel="prefetch" href="/assets/js/37.e84aeb89.js"><link rel="prefetch" href="/assets/js/38.8bd5bba9.js"><link rel="prefetch" href="/assets/js/39.ffd3bce6.js"><link rel="prefetch" href="/assets/js/4.9b31f553.js"><link rel="prefetch" href="/assets/js/40.1b57eaa8.js"><link rel="prefetch" href="/assets/js/41.ac6f9062.js"><link rel="prefetch" href="/assets/js/42.8854bf5a.js"><link rel="prefetch" href="/assets/js/43.91bf82a7.js"><link rel="prefetch" href="/assets/js/44.c35012af.js"><link rel="prefetch" href="/assets/js/45.07b8e581.js"><link rel="prefetch" href="/assets/js/46.02916103.js"><link rel="prefetch" href="/assets/js/47.f1be0d43.js"><link rel="prefetch" href="/assets/js/48.7f7c7f55.js"><link rel="prefetch" href="/assets/js/49.6692487b.js"><link rel="prefetch" href="/assets/js/5.23b29502.js"><link rel="prefetch" href="/assets/js/50.6c2f6d29.js"><link rel="prefetch" href="/assets/js/51.f7be7c31.js"><link rel="prefetch" href="/assets/js/52.b9dad83f.js"><link rel="prefetch" href="/assets/js/53.8f778f89.js"><link rel="prefetch" href="/assets/js/54.9853cbd5.js"><link rel="prefetch" href="/assets/js/55.f1dfad52.js"><link rel="prefetch" href="/assets/js/56.a89162ce.js"><link rel="prefetch" href="/assets/js/57.b1f1111f.js"><link rel="prefetch" href="/assets/js/58.08f753ab.js"><link rel="prefetch" href="/assets/js/59.e2ff4e09.js"><link rel="prefetch" href="/assets/js/6.ca86ed4c.js"><link rel="prefetch" href="/assets/js/60.14c1ce69.js"><link rel="prefetch" href="/assets/js/61.06a9c523.js"><link rel="prefetch" href="/assets/js/62.af6d0bf2.js"><link rel="prefetch" href="/assets/js/63.47139735.js"><link rel="prefetch" href="/assets/js/64.1b3689b6.js"><link rel="prefetch" href="/assets/js/65.c599d8e8.js"><link rel="prefetch" href="/assets/js/66.91648506.js"><link rel="prefetch" href="/assets/js/67.ecf7742c.js"><link rel="prefetch" href="/assets/js/68.b8769d15.js"><link rel="prefetch" href="/assets/js/69.e055ff05.js"><link rel="prefetch" href="/assets/js/7.9d170f74.js"><link rel="prefetch" href="/assets/js/70.065d9e72.js"><link rel="prefetch" href="/assets/js/71.840612b5.js"><link rel="prefetch" href="/assets/js/72.2a605e0c.js"><link rel="prefetch" href="/assets/js/73.3e54fae5.js"><link rel="prefetch" href="/assets/js/74.8e626e7b.js"><link rel="prefetch" href="/assets/js/75.c64b57c0.js"><link rel="prefetch" href="/assets/js/76.0e7007be.js"><link rel="prefetch" href="/assets/js/77.c8b770b0.js"><link rel="prefetch" href="/assets/js/78.d7da3c62.js"><link rel="prefetch" href="/assets/js/79.a78c6d63.js"><link rel="prefetch" href="/assets/js/8.3616387d.js"><link rel="prefetch" href="/assets/js/80.dda2cb25.js"><link rel="prefetch" href="/assets/js/81.2f232306.js"><link rel="prefetch" href="/assets/js/82.df6bca63.js"><link rel="prefetch" href="/assets/js/83.6251af59.js"><link rel="prefetch" href="/assets/js/84.d3eda27f.js"><link rel="prefetch" href="/assets/js/85.71180abd.js"><link rel="prefetch" href="/assets/js/86.3c5a5f86.js"><link rel="prefetch" href="/assets/js/87.12474af5.js"><link rel="prefetch" href="/assets/js/9.c04fa05e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e8ff0ee6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">SmacUL's Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/self/" class="nav-link">关于我</a></div><div class="nav-item"><a href="https://github.com/SmacUL" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/self/" class="nav-link">关于我</a></div><div class="nav-item"><a href="https://github.com/SmacUL" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/log/script_with_voice/" class="active sidebar-link">字幕音频视频生成器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/log/script_with_voice/#为什么会有这个东西" class="sidebar-link">为什么会有这个东西?</a></li><li class="sidebar-sub-header"><a href="/log/script_with_voice/#大概的思路" class="sidebar-link">大概的思路</a></li><li class="sidebar-sub-header"><a href="/log/script_with_voice/#音频" class="sidebar-link">音频</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/log/script_with_voice/#google-text-to-speech-api" class="sidebar-link">Google Text-To-Speech API</a></li><li class="sidebar-sub-header"><a href="/log/script_with_voice/#获取音频长度" class="sidebar-link">获取音频长度</a></li></ul></li><li class="sidebar-sub-header"><a href="/log/script_with_voice/#字幕" class="sidebar-link">字幕</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/log/script_with_voice/#生成字幕图片" class="sidebar-link">生成字幕图片</a></li><li class="sidebar-sub-header"><a href="/log/script_with_voice/#化图片为视频" class="sidebar-link">化图片为视频</a></li></ul></li><li class="sidebar-sub-header"><a href="/log/script_with_voice/#duang-合成-2" class="sidebar-link">Duang 合成</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/log/script_with_voice/#合成单句台词的音频与视频" class="sidebar-link">合成单句台词的音频与视频</a></li><li class="sidebar-sub-header"><a href="/log/script_with_voice/#合成所有音视频" class="sidebar-link">合成所有音视频</a></li></ul></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="字幕音频视频生成器"><a href="#字幕音频视频生成器" class="header-anchor">#</a> 字幕音频视频生成器</h1> <p>我将在下文中 BB 一个字幕音频视频的生成器的编写过程. 生成器读取台词后, 利用 Google Text-to-Speech 生成音频, 利用 PIL 以及 opencv 生成字幕视频, 最终输出所有台词的音视频. 像下面这样.</p> <p><img src="/note/img/2020-07-30-23-17-12.png" alt=""></p> <p>最初考虑是一次性代码, 写的比较急, 而且任务适配性不高, 做个参考, 看看就成, 希望能帮到你. <a href="https://github.com/SmacUL/ScrpitVideoCreator" target="_blank" rel="noopener noreferrer">GitHub 仓库<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="为什么会有这个东西"><a href="#为什么会有这个东西" class="header-anchor">#</a> 为什么会有这个东西?</h2> <p>万恶之源是老板的一个任务. 老板希望我能够为公司教学平台中的所有实验录制一段演示视频, 这些视频大概 5~15 分钟, 并且要有人工合成的配音, 还要有对应的字幕.</p> <p>最初的最初, 我采用纯手工的方式, 先编写剧本台词, 再利用钉钉直播录制视频, 然后使用讯飞一句一句地生成台词音频 (抠门, 没办法全部合成), 最后将所有视频资源导入到 Pr 中剪辑. 一开始我总是要花很多时间先找到指定的音频, 然后找准插入音频的位置, 然后再在音频的位置加上对应长度的字幕, 最后还要再将视频, 音频和字幕调整一下.</p> <p>如果, 如果我能用脚本, 利用预先编写好的台词 (本质上就是字幕), 帮我自动合成一段视频, 它包括了字幕音频以及对应长度的字幕视频. 这样, 我在 Pr 中实际处理的就是两段视频资源, 而不是一段视频资源和几十段音频. 剩下的事情就是对字幕视频进行裁切, 将片段位置放好即可.</p> <p>一开始一个 10 分钟左右的视频大概需要 4 小时, 现在被压缩到了 2 小时左右.</p> <h2 id="大概的思路"><a href="#大概的思路" class="header-anchor">#</a> 大概的思路</h2> <p>总体来说, 我先处理一句台词的视频与音频, 然后将所有台词视音频合成起来.</p> <h4 id="获取音频"><a href="#获取音频" class="header-anchor">#</a> 获取音频</h4> <p>不是我崇洋媚外, Google 的 API 甩了国内厂商八条街, 不管是读的像不像人, 还是念中文中的英文. Text-To-Speech 你值得拥有, 唯一蛋疼的就是需要信用卡.</p> <h4 id="生成字幕视频"><a href="#生成字幕视频" class="header-anchor">#</a> 生成字幕视频</h4> <p>我们都知道视频本质上可以是连续的图片. 我的想法也是先将文字写在背景图片上, 然后依据音频长度和每秒帧数计算图片数量, 合成指定长度的视频.</p> <h4 id="duang-合成"><a href="#duang-合成" class="header-anchor">#</a> Duang, 合成</h4> <p>将音频和视频合成在一起.</p> <h4 id="再-duang-最终的产物"><a href="#再-duang-最终的产物" class="header-anchor">#</a> 再 Duang, 最终的产物</h4> <p>按顺序将所有的台词视音频连在一起.</p> <h2 id="音频"><a href="#音频" class="header-anchor">#</a> 音频</h2> <h3 id="google-text-to-speech-api"><a href="#google-text-to-speech-api" class="header-anchor">#</a> Google Text-To-Speech API</h3> <p><a href="https://cloud.google.com/text-to-speech" target="_blank" rel="noopener noreferrer">官网<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>官网的<a href="https://cloud.google.com/text-to-speech/docs/quickstart-client-libraries" target="_blank" rel="noopener noreferrer">快速操作<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>已经写得很妙了, 准备好一张信用卡照做就成.</p> <p>这个 API 看起来和 MySQL 数据库的连接操作很像, 都需要先起一个客户端.</p> <div class="language-py line-numbers-mode"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-py"><code>client <span class="token operator">=</span> texttospeech<span class="token punctuation">.</span>TextToSpeechClient<span class="token punctuation">(</span><span class="token punctuation">)</span>
synthesis_input <span class="token operator">=</span> texttospeech<span class="token punctuation">.</span>SynthesisInput<span class="token punctuation">(</span>text<span class="token operator">=</span>script<span class="token punctuation">)</span>
voice <span class="token operator">=</span> texttospeech<span class="token punctuation">.</span>VoiceSelectionParams<span class="token punctuation">(</span>
    language_code<span class="token operator">=</span><span class="token string">&quot;cmn-CN&quot;</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">&quot;cmn-CN-Wavenet-A&quot;</span><span class="token punctuation">,</span> ssml_gender<span class="token operator">=</span>texttospeech<span class="token punctuation">.</span>SsmlVoiceGender<span class="token punctuation">.</span>NEUTRAL
<span class="token punctuation">)</span>
audio_config <span class="token operator">=</span> texttospeech<span class="token punctuation">.</span>AudioConfig<span class="token punctuation">(</span>
    audio_encoding<span class="token operator">=</span>texttospeech<span class="token punctuation">.</span>AudioEncoding<span class="token punctuation">.</span>MP3
<span class="token punctuation">)</span>
response <span class="token operator">=</span> client<span class="token punctuation">.</span>synthesize_speech<span class="token punctuation">(</span>
    <span class="token builtin">input</span><span class="token operator">=</span>synthesis_input<span class="token punctuation">,</span> voice<span class="token operator">=</span>voice<span class="token punctuation">,</span> audio_config<span class="token operator">=</span>audio_config
<span class="token punctuation">)</span>
<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>outputPath<span class="token punctuation">,</span> <span class="token string">&quot;wb&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> out<span class="token punctuation">:</span>
    out<span class="token punctuation">.</span>write<span class="token punctuation">(</span>response<span class="token punctuation">.</span>audio_content<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'音频已写入文件 '</span><span class="token punctuation">,</span> outputPath<span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>加黑的位置有一个参数 <code>name</code>, 它被设置成 <code>cmn-CN-Wavenet-A</code>, 使用 WaveNet 生成普通话音频, 这是 Google 的一项技术, 就是可以让机器话说的更像一个人. 反正我网上兜了一圈, 还没有哪个机器中文说的有她好的. 当然使用 WaveNet 生成音频价格更高.</p> <p>利用这段代码, 我们能够获得一段 mp3.</p> <div class="custom-block tip"><p class="custom-block-title">关于 API 的身份验证</p> <p>很重要的一点, 由于需要添加 <code>GOOGLE_APPLICATION_CREDENTIALS</code> 变量进行身份验证, 请使用添加有此变量的命令行窗口运行代码. 不要直接使用 IDE 或者 Code Runner 啥的.</p></div> <h3 id="获取音频长度"><a href="#获取音频长度" class="header-anchor">#</a> 获取音频长度</h3> <p>librosa 工具包可以完成这个任务.</p> <p><code>pip install librosa</code><br> <code>import librosa</code></p> <div class="language-py line-numbers-mode"><pre class="language-py"><code>duration <span class="token operator">=</span> librosa<span class="token punctuation">.</span>get_duration<span class="token punctuation">(</span>filename<span class="token operator">=</span>audioPath<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="字幕"><a href="#字幕" class="header-anchor">#</a> 字幕</h2> <h3 id="生成字幕图片"><a href="#生成字幕图片" class="header-anchor">#</a> 生成字幕图片</h3> <p>我需要的字幕尺寸为 1280px * 80px, 黑色背景, 白色的字, 字幕水平居中即可.</p> <p>老实说, 我没怎么看懂下面代发中的两个方法的操作, 我也是抄来的 😃. 总的来说, 就是他们就是用来计算字幕长度的.</p> <div class="language-py line-numbers-mode"><pre class="language-py"><code><span class="token keyword">def</span> <span class="token function">get_str_width</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token punctuation">:</span>
    width <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> c <span class="token keyword">in</span> string<span class="token punctuation">:</span>
        width <span class="token operator">+=</span> get_width<span class="token punctuation">(</span>c<span class="token punctuation">)</span>
    <span class="token keyword">return</span> width


<span class="token keyword">def</span> <span class="token function">get_width</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">:</span>
    widths <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">126</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">159</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">687</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">710</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">711</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">727</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">733</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">879</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1154</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1161</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token punctuation">(</span><span class="token number">4347</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">4447</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">7467</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">7521</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">8369</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">8426</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">9000</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">9002</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">11021</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token punctuation">(</span><span class="token number">12350</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">12351</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">12438</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">12442</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">19893</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">19967</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">55203</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">63743</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token punctuation">(</span><span class="token number">64106</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">65039</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">65059</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">65131</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">65279</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">65376</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">65500</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">65510</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token punctuation">(</span><span class="token number">120831</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">262141</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1114109</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    o <span class="token operator">=</span> <span class="token builtin">ord</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
    <span class="token keyword">if</span> o <span class="token operator">==</span> <span class="token number">0xe</span> <span class="token keyword">or</span> o <span class="token operator">==</span> <span class="token number">0xf</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token number">0</span>
    <span class="token keyword">for</span> num<span class="token punctuation">,</span> wid <span class="token keyword">in</span> widths<span class="token punctuation">:</span>
        <span class="token keyword">if</span> o <span class="token operator">&lt;=</span> num<span class="token punctuation">:</span>
            <span class="token keyword">return</span> wid
    <span class="token keyword">return</span> <span class="token number">1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>利用强大的 PIL 库, 我们可以实现很多 PS 的功能.</p> <p><code>pip install Pillow-PIL</code><br> <code>from PIL import ImageFont, ImageDraw, Image</code></p> <div class="language-py line-numbers-mode"><pre class="language-py"><code><span class="token comment"># 这里使用了微软雅黑作为字体的字体. </span>
font <span class="token operator">=</span> ImageFont<span class="token punctuation">.</span>truetype<span class="token punctuation">(</span><span class="token string">'./fonts/msyh.ttc'</span><span class="token punctuation">,</span> fontSize<span class="token punctuation">)</span>
<span class="token comment"># 创建一张指定长宽的黑色图片</span>
img <span class="token operator">=</span> Image<span class="token punctuation">.</span>new<span class="token punctuation">(</span><span class="token string">'RGB'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>imgW<span class="token punctuation">,</span> imgH<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
draw <span class="token operator">=</span> ImageDraw<span class="token punctuation">.</span>Draw<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
<span class="token comment"># 将白色文字写到图片中, get_str_width 方法在上文中介绍过</span>
<span class="token comment"># 竖直居中就偷懒不做了</span>
draw<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>imgW <span class="token operator">-</span> get_str_width<span class="token punctuation">(</span>script<span class="token punctuation">)</span> <span class="token operator">*</span> fontSize <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">)</span><span class="token punctuation">,</span> script<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> font<span class="token operator">=</span>font<span class="token punctuation">)</span>
img<span class="token punctuation">.</span>save<span class="token punctuation">(</span>outputPath<span class="token punctuation">,</span> <span class="token string">'png'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="化图片为视频"><a href="#化图片为视频" class="header-anchor">#</a> 化图片为视频</h3> <p>这事交给 opencv 来完成.</p> <p><code>pip install opencv-python</code><br> <code>import cv2</code></p> <div class="language-py line-numbers-mode"><pre class="language-py"><code><span class="token comment"># 'm', 'p', '4', 'v' 指定了输出 mp4 格式的视频</span>
video <span class="token operator">=</span> cv2<span class="token punctuation">.</span>VideoWriter<span class="token punctuation">(</span>outputPath<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>VideoWriter_fourcc<span class="token punctuation">(</span><span class="token string">'m'</span><span class="token punctuation">,</span> <span class="token string">'p'</span><span class="token punctuation">,</span> <span class="token string">'4'</span><span class="token punctuation">,</span> <span class="token string">'v'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fps<span class="token punctuation">,</span> size<span class="token punctuation">)</span>
<span class="token comment"># 读取字幕图片</span>
img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>imagePath<span class="token punctuation">)</span>
<span class="token comment"># 帧数 * 时间 = 图片总数</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>fps<span class="token operator">*</span>time<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    video<span class="token punctuation">.</span>write<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
video<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
cv2<span class="token punctuation">.</span>destroyAllWindows<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="duang-合成-2"><a href="#duang-合成-2" class="header-anchor">#</a> Duang 合成</h2> <h3 id="合成单句台词的音频与视频"><a href="#合成单句台词的音频与视频" class="header-anchor">#</a> 合成单句台词的音频与视频</h3> <p><code>pip install moviepy</code><br> <code>from moviepy.editor import *</code></p> <div class="language-py line-numbers-mode"><pre class="language-py"><code><span class="token comment"># videoPath 为视频文件的位置</span>
video <span class="token operator">=</span> VideoFileClip<span class="token punctuation">(</span>videoPath<span class="token punctuation">)</span>
<span class="token comment"># audioPath 为音频文件的位置</span>
audio <span class="token operator">=</span> AudioFileClip<span class="token punctuation">(</span>audioPath<span class="token punctuation">)</span>
video <span class="token operator">=</span> video<span class="token punctuation">.</span>set_audio<span class="token punctuation">(</span>audio<span class="token punctuation">)</span>
<span class="token comment"># clipPath 为输出的视频文件的位置</span>
<span class="token comment"># 我的 clipPath 指明了是 mp4 的文件, 不知道其他格式行不行</span>
video<span class="token punctuation">.</span>write_videofile<span class="token punctuation">(</span>clipPath<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="合成所有音视频"><a href="#合成所有音视频" class="header-anchor">#</a> 合成所有音视频</h3> <p><code>pip install moviepy</code><br> <code>from moviepy.editor import *</code></p> <div class="language-py line-numbers-mode"><pre class="language-py"><code>videos <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token comment"># 我在处理单句字幕音视频的时候, 输出的都是 0.mp4, 1.mp4 .</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">:</span>
    os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">'./clip'</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'.mp4'</span><span class="token punctuation">)</span>
    video <span class="token operator">=</span> VideoFileClip<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">'./clip'</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'.mp4'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    videos<span class="token punctuation">.</span>append<span class="token punctuation">(</span>video<span class="token punctuation">)</span>
<span class="token comment"># 合成列表中的音视频</span>
fileVideo <span class="token operator">=</span> concatenate_videoclips<span class="token punctuation">(</span>videos<span class="token punctuation">)</span>
<span class="token comment"># 生, fps 为帧数</span>
fileVideo<span class="token punctuation">.</span>to_videofile<span class="token punctuation">(</span>outputPath<span class="token punctuation">,</span> fps<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> remove_temp<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">7/30/2020, 11:43:12 PM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.27d58fa7.js" defer></script><script src="/assets/js/2.f1f09924.js" defer></script><script src="/assets/js/33.b68ce17c.js" defer></script>
  </body>
</html>
