<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>新闻数据爬虫 | SmacUL&#39;s Blog</title>
    <meta name="description" content="你好">
    <link rel="icon" href="/assets/img/Logo.png">
    
    <link rel="preload" href="/assets/css/0.styles.9c3f924d.css" as="style"><link rel="preload" href="/assets/js/app.56eb9740.js" as="script"><link rel="preload" href="/assets/js/2.f1f09924.js" as="script"><link rel="preload" href="/assets/js/21.a28254eb.js" as="script"><link rel="prefetch" href="/assets/js/10.a706685c.js"><link rel="prefetch" href="/assets/js/11.743677f0.js"><link rel="prefetch" href="/assets/js/12.4625b8d2.js"><link rel="prefetch" href="/assets/js/13.20e401c7.js"><link rel="prefetch" href="/assets/js/14.153521b1.js"><link rel="prefetch" href="/assets/js/15.32ddf537.js"><link rel="prefetch" href="/assets/js/16.8707e308.js"><link rel="prefetch" href="/assets/js/17.d60a894c.js"><link rel="prefetch" href="/assets/js/18.6860fd78.js"><link rel="prefetch" href="/assets/js/19.cc777474.js"><link rel="prefetch" href="/assets/js/20.0806bc83.js"><link rel="prefetch" href="/assets/js/22.3df70647.js"><link rel="prefetch" href="/assets/js/23.95141a80.js"><link rel="prefetch" href="/assets/js/24.749c63bc.js"><link rel="prefetch" href="/assets/js/25.0312ed2b.js"><link rel="prefetch" href="/assets/js/26.1bddc38c.js"><link rel="prefetch" href="/assets/js/27.ddec5ece.js"><link rel="prefetch" href="/assets/js/28.a88314e7.js"><link rel="prefetch" href="/assets/js/29.f8b857a3.js"><link rel="prefetch" href="/assets/js/3.2f317a91.js"><link rel="prefetch" href="/assets/js/30.834d8890.js"><link rel="prefetch" href="/assets/js/31.b6daea79.js"><link rel="prefetch" href="/assets/js/32.e3de8f14.js"><link rel="prefetch" href="/assets/js/33.8e0f1d38.js"><link rel="prefetch" href="/assets/js/34.b40cc1e0.js"><link rel="prefetch" href="/assets/js/35.69ddf520.js"><link rel="prefetch" href="/assets/js/36.7989110d.js"><link rel="prefetch" href="/assets/js/37.3ba480cb.js"><link rel="prefetch" href="/assets/js/38.ad318699.js"><link rel="prefetch" href="/assets/js/39.82666b88.js"><link rel="prefetch" href="/assets/js/4.9b31f553.js"><link rel="prefetch" href="/assets/js/40.69276d69.js"><link rel="prefetch" href="/assets/js/41.accb11b1.js"><link rel="prefetch" href="/assets/js/42.759d1c80.js"><link rel="prefetch" href="/assets/js/43.8605f6ca.js"><link rel="prefetch" href="/assets/js/44.0dd6f4e9.js"><link rel="prefetch" href="/assets/js/45.3e322946.js"><link rel="prefetch" href="/assets/js/46.2afde74c.js"><link rel="prefetch" href="/assets/js/47.adb2d2fe.js"><link rel="prefetch" href="/assets/js/48.88ae9d9d.js"><link rel="prefetch" href="/assets/js/49.fb25a6db.js"><link rel="prefetch" href="/assets/js/5.f8e87f20.js"><link rel="prefetch" href="/assets/js/50.7bb0af03.js"><link rel="prefetch" href="/assets/js/51.98801d64.js"><link rel="prefetch" href="/assets/js/52.7ade034b.js"><link rel="prefetch" href="/assets/js/53.a5f65923.js"><link rel="prefetch" href="/assets/js/54.e979d976.js"><link rel="prefetch" href="/assets/js/55.3d0d7c46.js"><link rel="prefetch" href="/assets/js/6.c6a75bfe.js"><link rel="prefetch" href="/assets/js/7.e0345d7a.js"><link rel="prefetch" href="/assets/js/8.27a5599c.js"><link rel="prefetch" href="/assets/js/9.a0d9b307.js">
    <link rel="stylesheet" href="/assets/css/0.styles.9c3f924d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">SmacUL's Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/self/" class="nav-link">About Me</a></div><div class="nav-item"><a href="https://github.com/SmacUL" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/self/" class="nav-link">About Me</a></div><div class="nav-item"><a href="https://github.com/SmacUL" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/log/新闻数据爬虫.html" class="active sidebar-link">新闻数据爬虫</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/log/新闻数据爬虫.html#谈谈历史" class="sidebar-link">谈谈历史</a></li><li class="sidebar-sub-header"><a href="/log/新闻数据爬虫.html#操作流程" class="sidebar-link">操作流程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/log/新闻数据爬虫.html#总览" class="sidebar-link">总览</a></li><li class="sidebar-sub-header"><a href="/log/新闻数据爬虫.html#大致流程" class="sidebar-link">大致流程</a></li></ul></li><li class="sidebar-sub-header"><a href="/log/新闻数据爬虫.html#详细点的分析" class="sidebar-link">详细点的分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/log/新闻数据爬虫.html#简单的推荐机制" class="sidebar-link">简单的推荐机制</a></li><li class="sidebar-sub-header"><a href="/log/新闻数据爬虫.html#具体的数据结构" class="sidebar-link">具体的数据结构</a></li></ul></li><li class="sidebar-sub-header"><a href="/log/新闻数据爬虫.html#系统" class="sidebar-link">系统</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/log/新闻数据爬虫.html#系统相关的数据库表" class="sidebar-link">系统相关的数据库表</a></li><li class="sidebar-sub-header"><a href="/log/新闻数据爬虫.html#系统结构" class="sidebar-link">系统结构</a></li><li class="sidebar-sub-header"><a href="/log/新闻数据爬虫.html#工作流程" class="sidebar-link">工作流程</a></li></ul></li><li class="sidebar-sub-header"><a href="/log/新闻数据爬虫.html#总结" class="sidebar-link">总结</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="新闻数据爬虫"><a href="#新闻数据爬虫" class="header-anchor">#</a> 新闻数据爬虫</h1> <h2 id="谈谈历史"><a href="#谈谈历史" class="header-anchor">#</a> 谈谈历史</h2> <p>这个玩意一开始是新闻推荐系统的一部分, 用来爬取今日头条的文章信息. 从它出生到现在, 已经经历过很多次的改版, 需求也发生了比较大的变化. 一开始我认为这个爬虫只要获取新闻数据及文章作者的相关数据就可以了, 但是后期仔细地看一了下数据, 既然是做推荐, 怎么能少了新闻的受众, 也就是普通用户. 于是我打算重写一遍这个爬虫.</p> <h2 id="操作流程"><a href="#操作流程" class="header-anchor">#</a> 操作流程</h2> <h3 id="总览"><a href="#总览" class="header-anchor">#</a> 总览</h3> <p>在个人水平的限制下, 我所知的爬取数据的手段有两种:</p> <ul><li>一是直接在渲染好的页面的 DOM 树下获取, 这个速度比较慢, 可以使用 <a href="https://selenium.dev/documentation/zh-cn/" target="_blank" rel="noopener noreferrer">Selenium<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 工具来完成</li> <li>另一种是组装请求头, 假装浏览器发送请求获取数据.</li></ul> <p>那么, 我们的这个爬虫需要的数据包括 文章, 文章的作者, 评论, 评论的作者, 回复, 回复的作者. 至于为什么不把其他的用户拉进来, 因为今日头条的用户数量过于庞大, 而且相互关联, 形成网状, 全部拉下来是不可能的. 而且相比于数据的数量, 我认为更重要的是数据的完整性和纯洁性. 这些数据被爬取下来后将被存储在一个 MySql 数据库中.</p> <p>考虑到时间成本, 只对文章内容采用在 DOM 树下爬取的方式 (文章内容没法使用请求), 其他都使用伪装请求的方式.</p> <p>我们可以从首页先获取今日头条文章的缩略信息, 每组缩略信息中应该包含 8~10 条新闻的链接. 像这样:</p> <p><img src="/note/img/2019-12-19-16-20-59.png" alt=""></p> <p>通过链接, 我们可以获得文章的内容, 这不难, 比较麻烦的是评论和回复的内容, 尤其是回复, 回复包括对评论的回复和对回复的回复. 底下的图就是评论回复的样式.</p> <p><img src="/note/img/2019-12-19-16-23-57.png" alt=""></p> <h3 id="大致流程"><a href="#大致流程" class="header-anchor">#</a> 大致流程</h3> <p>那么现在我们假设获取了这些链接, 并且以一篇文章为一个单位, 简单的想一想流程:</p> <ol><li>获取文章作者</li> <li>获取文章内容</li> <li>获取评论作者</li> <li>获取评论内容</li> <li>获取回复作者</li> <li>获取回复内容</li> <li>查看回复是对回复的回复还是对评论的回复</li></ol> <p>前面的步骤内容如果获取失败, 那么后面的内容也就没有处理的必要了. 同时评论和回复相关数据的获取, 在文章粒度下, 是需要循环处理的.</p> <p>总的来说, 这是一个数据处理的任务, 就暂时交给 python 处理了.</p> <h2 id="详细点的分析"><a href="#详细点的分析" class="header-anchor">#</a> 详细点的分析</h2> <p>我们要的是一个服务于推荐系统的爬虫, 那么需要从大致的推荐手段开始考虑, 而推荐的主要内容是文章, 主要受众是普通用户.</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>用户比较特殊, 包括能够写作的用户和普通用户.</p></div> <h3 id="简单的推荐机制"><a href="#简单的推荐机制" class="header-anchor">#</a> 简单的推荐机制</h3> <h4 id="普通用户的行为"><a href="#普通用户的行为" class="header-anchor">#</a> 普通用户的行为</h4> <ol><li>给文章点赞/点踩</li> <li>给文章写评论</li> <li>给评论写回复</li> <li>给回复写回复</li> <li>给评论点赞/点踩</li> <li>给回复点赞/点踩</li> <li>关注他人</li></ol> <p>普通用户的行为会直接影响文章 评论 回复 文章作者的受欢迎程度. 在数据库中, 文章 评论 回复三个表都添加了 score 字段, 他们的作用是判别对应内容的受欢迎程度.</p> <h4 id="个人偏好"><a href="#个人偏好" class="header-anchor">#</a> 个人偏好</h4> <p>个人偏好, 一部分是由用户自己设定的, 另一部分是由系统对用户行为分析之后决定的. 未来还会有一个专门的表用来记录用户对某一类特定文章的偏好程度, 不过这个表和现在的爬虫没有关系, 不应该先入为主地对获得的数据进行处理, 应该保证数据的纯洁性.</p> <h4 id="推荐小结"><a href="#推荐小结" class="header-anchor">#</a> 推荐小结</h4> <p>文章的受欢迎程度, 一些固定的推荐机制和用户个人的偏好设置将最终决定推荐的内容. 实际的推荐系统还会考虑长尾效应的影响, 这里不考虑.</p> <h3 id="具体的数据结构"><a href="#具体的数据结构" class="header-anchor">#</a> 具体的数据结构</h3> <p>下面的这些结构分别对应一张数据表, 具体的底下有. 为了方便爬虫获取与判断, 实际的数据表中会添加一些特殊的 id 字段. 另外考虑到后面的管理系统对网页内容的审核, 还需要添加与合法性相关的字段.</p> <h4 id="用户"><a href="#用户" class="header-anchor">#</a> 用户</h4> <p>除了基本的用户数据外, 要能够区分普通用户和写作用户, 也就是用户级别, 还包括用户关注的人数和用户的粉丝数量等. 用户表也是其他的表的基石.</p> <h4 id="文章"><a href="#文章" class="header-anchor">#</a> 文章</h4> <p>包括文章的标题, 内容, 描述内容, 点赞/点踩数量, 评论数量 (要依据实际获取到的评论数量), 作者的 id 信息, 文章类别和关键字等.</p> <h4 id="评论"><a href="#评论" class="header-anchor">#</a> 评论</h4> <p>评论的数据复杂度要小于文章, 可以看做是阉割版的文章数据. 今日头条中给出了每条评论的点赞数量, 这个数量应该被直接获取.</p> <h4 id="回复"><a href="#回复" class="header-anchor">#</a> 回复</h4> <p>回复表应该是整个数据库中外键最多的表, 它会和自己, 评论, 文章, 用户都创建关系. 和评论一样, 回复的点赞数量也会被直接获取.</p> <h2 id="系统"><a href="#系统" class="header-anchor">#</a> 系统</h2> <ul><li><a href="https://github.com/SmacUL/NewsRecommend/tree/master/crawler" target="_blank" rel="noopener noreferrer">源码<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/SmacUL/NewsRecommend/blob/master/NewsRecommend.sql" target="_blank" rel="noopener noreferrer">系统相关的数据库配置与表信息<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h3 id="系统相关的数据库表"><a href="#系统相关的数据库表" class="header-anchor">#</a> 系统相关的数据库表</h3> <p>就和上面说的一样, 我们需要考虑四个要素: 用户, 文章, 评论, 回复. 底下给出了四个表以及相关的注释信息</p> <h4 id="用户-2"><a href="#用户-2" class="header-anchor">#</a> 用户</h4> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> NewsRecommend<span class="token punctuation">.</span>Customers <span class="token punctuation">(</span>
    cus_id <span class="token keyword">INT</span> <span class="token keyword">UNSIGNED</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span>
    cus_name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    cus_pass <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">-- 用户的 url , 爬虫中用于识别用户</span>
    cus_url <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">''</span><span class="token punctuation">,</span>
    <span class="token comment">-- 用户头像的 url</span>
    cus_avatar_url <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">''</span><span class="token punctuation">,</span>
    <span class="token comment">-- 用户背景墙的图片 url</span>
    cus_background_url <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">''</span><span class="token punctuation">,</span>
    <span class="token comment">-- 用户的个人描述</span>
    cus_style <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">'这个人很懒, 什么都没写'</span><span class="token punctuation">,</span>
    <span class="token comment">-- cus_gender 为 0 时性别未知, 为 1 时为男, 为 -1 时为女</span>
    cus_gender <span class="token keyword">TINYINT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token comment">-- 用户的创建时间</span>
    cus_time <span class="token keyword">TIMESTAMP</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">ON</span> <span class="token keyword">UPDATE</span> <span class="token keyword">CURRENT_TIMESTAMP</span><span class="token punctuation">,</span>
    <span class="token comment">-- cus_type 为 0 时是普通用户, 为 1 时是可编辑用户</span>
    cus_type <span class="token keyword">TINYINT</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token comment">-- 此用户的关注的用户数量</span>
    cus_follow_num <span class="token keyword">int</span> <span class="token keyword">UNSIGNED</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token comment">-- 此用户的粉丝</span>
    cus_fan_num <span class="token keyword">int</span> <span class="token keyword">UNSIGNED</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">,</span> 
    <span class="token comment">-- 此用户的文章数量</span>
    cus_article_num <span class="token keyword">int</span> <span class="token keyword">UNSIGNED</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token comment">-- 用户评分</span>
    cus_scope <span class="token keyword">int</span> <span class="token keyword">UNSIGNED</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token comment">-- cus_legal 为 0 时待审核, 为 1 时合法, 为 -1 不合法</span>
    cus_legal <span class="token keyword">TINYINT</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">,</span>
	
    <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">(</span>cus_id<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h4 id="文章-新闻"><a href="#文章-新闻" class="header-anchor">#</a> 文章(新闻)</h4> <div class="language-SQL line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> NewsRecommend<span class="token punctuation">.</span>Articles <span class="token punctuation">(</span>
    art_id <span class="token keyword">INT</span> <span class="token keyword">UNSIGNED</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span>
    art_title <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">''</span><span class="token punctuation">,</span>
    art_content <span class="token keyword">TEXT</span><span class="token punctuation">,</span>
    <span class="token comment">-- 文章的 url , 在爬虫中分辨文章</span>
    art_url <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">''</span><span class="token punctuation">,</span>
    <span class="token comment">-- 文章的分类</span>
    art_class <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">'综合'</span><span class="token punctuation">,</span>
    <span class="token comment">-- 文章的标签 应该以 &amp; 分隔</span>
    art_tags <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">''</span><span class="token punctuation">,</span>
    <span class="token comment">-- 文章缩略图的信息</span>
    art_image_url <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">''</span><span class="token punctuation">,</span>
    <span class="token comment">-- 文章的点赞数量</span>
    art_like_num <span class="token keyword">INT</span> <span class="token keyword">UNSIGNED</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token comment">-- 文章的点踩数量</span>
    art_dislike_num <span class="token keyword">INT</span> <span class="token keyword">UNSIGNED</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">,</span>
    art_time <span class="token keyword">TIMESTAMP</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">ON</span> <span class="token keyword">UPDATE</span> <span class="token keyword">CURRENT_TIMESTAMP</span><span class="token punctuation">,</span>
    <span class="token comment">-- 文章的评论数量</span>
    art_comment_num <span class="token keyword">INT</span> <span class="token keyword">UNSIGNED</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token comment">-- 文章的分数</span>
	art_scope <span class="token keyword">int</span> <span class="token keyword">UNSIGNED</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">,</span>
    art_legal <span class="token keyword">tinyint</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">,</span>
    
    art_customer_id <span class="token keyword">INT</span> <span class="token keyword">UNSIGNED</span><span class="token punctuation">,</span>
    <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">(</span>art_id<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token keyword">foreign</span> <span class="token keyword">key</span><span class="token punctuation">(</span>art_customer_id<span class="token punctuation">)</span> <span class="token keyword">references</span> Customers<span class="token punctuation">(</span>cus_id<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h4 id="评论-2"><a href="#评论-2" class="header-anchor">#</a> 评论</h4> <div class="language-SQL line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> NewsRecommend<span class="token punctuation">.</span>Comments <span class="token punctuation">(</span>
    com_id <span class="token keyword">INT</span> <span class="token keyword">UNSIGNED</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span>
    com_content <span class="token keyword">TEXT</span><span class="token punctuation">,</span>
    com_time <span class="token keyword">TIMESTAMP</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">ON</span> <span class="token keyword">UPDATE</span> <span class="token keyword">CURRENT_TIMESTAMP</span><span class="token punctuation">,</span>
    com_like_num <span class="token keyword">INT</span> <span class="token keyword">UNSIGNED</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">,</span>
    com_dislike_num <span class="token keyword">INT</span> <span class="token keyword">UNSIGNED</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token comment">-- 评论的回复数量</span>
    com_reply_num <span class="token keyword">INT</span> <span class="token keyword">UNSIGNED</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token comment">-- 评论的分数</span>
	com_scope <span class="token keyword">int</span> <span class="token keyword">UNSIGNED</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">,</span>
    com_legal <span class="token keyword">tinyint</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token comment">-- 爬虫过程中的评论标识</span>
    com_identify_id <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">''</span><span class="token punctuation">,</span>
    
    com_customer_id <span class="token keyword">INT</span> <span class="token keyword">UNSIGNED</span><span class="token punctuation">,</span>
    com_article_id <span class="token keyword">INT</span> <span class="token keyword">UNSIGNED</span><span class="token punctuation">,</span> 
	<span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">(</span>com_id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">foreign</span> <span class="token keyword">key</span><span class="token punctuation">(</span>com_customer_id<span class="token punctuation">)</span> <span class="token keyword">references</span> Customers<span class="token punctuation">(</span>cus_id<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token keyword">foreign</span> <span class="token keyword">key</span><span class="token punctuation">(</span>com_article_id<span class="token punctuation">)</span> <span class="token keyword">references</span> Articles<span class="token punctuation">(</span>art_id<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h4 id="回复-2"><a href="#回复-2" class="header-anchor">#</a> 回复</h4> <div class="language-SQL line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> NewsRecommend<span class="token punctuation">.</span>Replys <span class="token punctuation">(</span>
    rep_id <span class="token keyword">INT</span> <span class="token keyword">UNSIGNED</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span>
    rep_content <span class="token keyword">TEXT</span><span class="token punctuation">,</span>
    <span class="token comment">-- 回复的类型, 0 是对评论的回复, 1 是对回复的回复</span>
    rep_type <span class="token keyword">tinyint</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">,</span> 
    rep_time <span class="token keyword">TIMESTAMP</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">ON</span> <span class="token keyword">UPDATE</span> <span class="token keyword">CURRENT_TIMESTAMP</span><span class="token punctuation">,</span>
    rep_like_num <span class="token keyword">INT</span> <span class="token keyword">UNSIGNED</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">,</span>
    rep_dislike_num <span class="token keyword">INT</span> <span class="token keyword">UNSIGNED</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token comment">-- 回复的回复数量</span>
    rep_reply_num <span class="token keyword">INT</span> <span class="token keyword">UNSIGNED</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token comment">-- 回复的分数</span>
	rep_scope <span class="token keyword">int</span> <span class="token keyword">UNSIGNED</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">,</span>
	rep_legal <span class="token keyword">tinyint</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">,</span>

    <span class="token comment">-- 爬虫过程中的评论标识</span>
    rep_identify_id <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">''</span><span class="token punctuation">,</span>

    rep_customer_id <span class="token keyword">INT</span> <span class="token keyword">UNSIGNED</span><span class="token punctuation">,</span>
    rep_article_id <span class="token keyword">INT</span> <span class="token keyword">UNSIGNED</span><span class="token punctuation">,</span>
    rep_comment_id <span class="token keyword">INT</span> <span class="token keyword">UNSIGNED</span><span class="token punctuation">,</span> 
    rep_reply_id <span class="token keyword">INT</span> <span class="token keyword">UNSIGNED</span><span class="token punctuation">,</span>
    <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">(</span>rep_id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">foreign</span> <span class="token keyword">key</span><span class="token punctuation">(</span>rep_customer_id<span class="token punctuation">)</span> <span class="token keyword">references</span> Customers<span class="token punctuation">(</span>cus_id<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token keyword">foreign</span> <span class="token keyword">key</span><span class="token punctuation">(</span>rep_article_id<span class="token punctuation">)</span> <span class="token keyword">references</span> Articles<span class="token punctuation">(</span>art_id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">foreign</span> <span class="token keyword">key</span><span class="token punctuation">(</span>rep_comment_id<span class="token punctuation">)</span> <span class="token keyword">references</span> Comments<span class="token punctuation">(</span>com_id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">foreign</span> <span class="token keyword">key</span><span class="token punctuation">(</span>rep_reply_id<span class="token punctuation">)</span> <span class="token keyword">references</span> Replys<span class="token punctuation">(</span>rep_id<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h3 id="系统结构"><a href="#系统结构" class="header-anchor">#</a> 系统结构</h3> <ul><li>process<br>
对应常见的 service , 处理一个小的流程</li> <li>dao<br>
处理与数据库相关的操作</li> <li>model<br>
类似 bean , 存放基本的数据类</li> <li>util<br>
一些公共的工具包</li> <li>properties<br>
存放基本的配置文件, 包括数据库, 数据获取范围, 请求信息等.</li> <li>Main.py<br>
万恶之源</li></ul> <h3 id="工作流程"><a href="#工作流程" class="header-anchor">#</a> 工作流程</h3> <p>从 Main.py 开始, 不像 Spring / SpringBoot 有现成的对象管理容器, 这个系统的对象依赖还是只能手工添加. 所以, 在正式工作前, 我们需要先检查 process dao 数据库连接对象之间的依赖关系, 并且确定运行范围.</p> <div class="language-Python line-numbers-mode"><pre class="language-python"><code>major <span class="token operator">=</span> Major<span class="token punctuation">(</span><span class="token punctuation">)</span>
major<span class="token punctuation">.</span>init_database<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">'properties'</span><span class="token punctuation">,</span> <span class="token string">'database.json'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
major<span class="token punctuation">.</span>init_dao<span class="token punctuation">(</span><span class="token punctuation">)</span>
major<span class="token punctuation">.</span>init_process<span class="token punctuation">(</span><span class="token punctuation">)</span>
major<span class="token punctuation">.</span>set_process_scope<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">'properties'</span><span class="token punctuation">,</span> <span class="token string">'scope.json'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
major<span class="token punctuation">.</span>major_process<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>其实这些步骤是没有分开写的必要的, 可以直接写到 Major 类中的 <code>__init__</code> 方法内, 这里只是个人喜好.</p></div> <p><code>major_process</code> 方法中就是一个完整的包含了总多 process 的流程. 数据先从 Main 到 process 再到 dao 最后前往数据库, 这之间可能需要 model 进行完整的数据对象的转运, 也可能需要 util 包中的工具支持.</p> <div class="language-Python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">for</span> data <span class="token keyword">in</span> news_data<span class="token punctuation">:</span>
    <span class="token comment"># 获取文章作者</span>
    art_customer_url <span class="token operator">=</span> self<span class="token punctuation">.</span>__cus_pro<span class="token punctuation">.</span>get_article_customer_url<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>__cus_pro<span class="token punctuation">.</span>is_customer_exist<span class="token punctuation">(</span>art_customer_url<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>__cus_pro<span class="token punctuation">.</span>insert_art_customer<span class="token punctuation">(</span>data<span class="token punctuation">,</span> art_customer_url<span class="token punctuation">)</span>
    art_customer_id <span class="token operator">=</span> self<span class="token punctuation">.</span>__cus_pro<span class="token punctuation">.</span>get_customer_id_by_url<span class="token punctuation">(</span>art_customer_url<span class="token punctuation">)</span>
    <span class="token keyword">if</span> art_customer_id <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">continue</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;文章作者处理完成\n&quot;</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>这是 <code>major_process</code> 方法中的一段, 用于获取文章作者的相关内容, 这就像是作文里面的自然段. 其他内容的获取基本上也是这个结构.</p> <ul><li>3 行用来获取文章作者个人中心的 url , 这是在爬虫阶段区分用户的字段;</li> <li>4 行会判断这个用户是否存在于数据库中, 如果不存在, 则执行 5 行内容;</li> <li>5 行用来获取这个用户的相关信息, 并且插入数据到数据库中;</li> <li>6 行会获取用户的 id , 这是在实际系统中用来区分用户的字段;</li> <li>7~8 行, 如果 6 行中的 id 没有获取, 可能是没有被正确插入, 总之是出现了异常, 那么后面一堆的数据都不需要获取了, 直接下一篇;</li></ul> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>今日头条的数据爬取难度比我想象中要大的多, 这个系统看起来, 尤其是 <code>major_process</code> 方法中定义的流程还是非常杂乱的, 也比较脆弱, 对异常和日志的管理就是灾难. 也许有一天, 在我深入了 Python 的语法, 同时了解更多的设计模式之后, 可以写出看起更好的代码.</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">12/19/2019, 6:07:53 PM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.56eb9740.js" defer></script><script src="/assets/js/2.f1f09924.js" defer></script><script src="/assets/js/21.a28254eb.js" defer></script>
  </body>
</html>
