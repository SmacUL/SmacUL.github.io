<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Public-Key Infrastructure Lab | SmacUL&#39;s Blog</title>
    <meta name="description" content="你好">
    <link rel="icon" href="/assets/img/Logo.png">
    
    <link rel="preload" href="/assets/css/0.styles.e8ff0ee6.css" as="style"><link rel="preload" href="/assets/js/app.27d58fa7.js" as="script"><link rel="preload" href="/assets/js/2.f1f09924.js" as="script"><link rel="preload" href="/assets/js/40.1b57eaa8.js" as="script"><link rel="prefetch" href="/assets/js/10.da04177b.js"><link rel="prefetch" href="/assets/js/11.33537db2.js"><link rel="prefetch" href="/assets/js/12.2c196981.js"><link rel="prefetch" href="/assets/js/13.501a5542.js"><link rel="prefetch" href="/assets/js/14.93a9b12d.js"><link rel="prefetch" href="/assets/js/15.7ddd6566.js"><link rel="prefetch" href="/assets/js/16.32ee58e2.js"><link rel="prefetch" href="/assets/js/17.c415498a.js"><link rel="prefetch" href="/assets/js/18.5ef64d19.js"><link rel="prefetch" href="/assets/js/19.521006c9.js"><link rel="prefetch" href="/assets/js/20.1aa33ed7.js"><link rel="prefetch" href="/assets/js/21.82b9d691.js"><link rel="prefetch" href="/assets/js/22.793f9d85.js"><link rel="prefetch" href="/assets/js/23.0ca70d66.js"><link rel="prefetch" href="/assets/js/24.d86f1591.js"><link rel="prefetch" href="/assets/js/25.2ce3a84b.js"><link rel="prefetch" href="/assets/js/26.12cdc3ac.js"><link rel="prefetch" href="/assets/js/27.7b341d36.js"><link rel="prefetch" href="/assets/js/28.61c57439.js"><link rel="prefetch" href="/assets/js/29.90d6873f.js"><link rel="prefetch" href="/assets/js/3.7db0d588.js"><link rel="prefetch" href="/assets/js/30.4f5e13f5.js"><link rel="prefetch" href="/assets/js/31.7ec86adf.js"><link rel="prefetch" href="/assets/js/32.0c179479.js"><link rel="prefetch" href="/assets/js/33.b68ce17c.js"><link rel="prefetch" href="/assets/js/34.6d314a9c.js"><link rel="prefetch" href="/assets/js/35.15ecee78.js"><link rel="prefetch" href="/assets/js/36.d6998519.js"><link rel="prefetch" href="/assets/js/37.e84aeb89.js"><link rel="prefetch" href="/assets/js/38.8bd5bba9.js"><link rel="prefetch" href="/assets/js/39.ffd3bce6.js"><link rel="prefetch" href="/assets/js/4.9b31f553.js"><link rel="prefetch" href="/assets/js/41.ac6f9062.js"><link rel="prefetch" href="/assets/js/42.8854bf5a.js"><link rel="prefetch" href="/assets/js/43.91bf82a7.js"><link rel="prefetch" href="/assets/js/44.c35012af.js"><link rel="prefetch" href="/assets/js/45.07b8e581.js"><link rel="prefetch" href="/assets/js/46.02916103.js"><link rel="prefetch" href="/assets/js/47.f1be0d43.js"><link rel="prefetch" href="/assets/js/48.7f7c7f55.js"><link rel="prefetch" href="/assets/js/49.6692487b.js"><link rel="prefetch" href="/assets/js/5.23b29502.js"><link rel="prefetch" href="/assets/js/50.6c2f6d29.js"><link rel="prefetch" href="/assets/js/51.f7be7c31.js"><link rel="prefetch" href="/assets/js/52.b9dad83f.js"><link rel="prefetch" href="/assets/js/53.8f778f89.js"><link rel="prefetch" href="/assets/js/54.9853cbd5.js"><link rel="prefetch" href="/assets/js/55.f1dfad52.js"><link rel="prefetch" href="/assets/js/56.a89162ce.js"><link rel="prefetch" href="/assets/js/57.b1f1111f.js"><link rel="prefetch" href="/assets/js/58.08f753ab.js"><link rel="prefetch" href="/assets/js/59.e2ff4e09.js"><link rel="prefetch" href="/assets/js/6.ca86ed4c.js"><link rel="prefetch" href="/assets/js/60.14c1ce69.js"><link rel="prefetch" href="/assets/js/61.06a9c523.js"><link rel="prefetch" href="/assets/js/62.af6d0bf2.js"><link rel="prefetch" href="/assets/js/63.47139735.js"><link rel="prefetch" href="/assets/js/64.1b3689b6.js"><link rel="prefetch" href="/assets/js/65.c599d8e8.js"><link rel="prefetch" href="/assets/js/66.91648506.js"><link rel="prefetch" href="/assets/js/67.ecf7742c.js"><link rel="prefetch" href="/assets/js/68.b8769d15.js"><link rel="prefetch" href="/assets/js/69.e055ff05.js"><link rel="prefetch" href="/assets/js/7.9d170f74.js"><link rel="prefetch" href="/assets/js/70.065d9e72.js"><link rel="prefetch" href="/assets/js/71.840612b5.js"><link rel="prefetch" href="/assets/js/72.2a605e0c.js"><link rel="prefetch" href="/assets/js/73.3e54fae5.js"><link rel="prefetch" href="/assets/js/74.8e626e7b.js"><link rel="prefetch" href="/assets/js/75.c64b57c0.js"><link rel="prefetch" href="/assets/js/76.0e7007be.js"><link rel="prefetch" href="/assets/js/77.c8b770b0.js"><link rel="prefetch" href="/assets/js/78.d7da3c62.js"><link rel="prefetch" href="/assets/js/79.a78c6d63.js"><link rel="prefetch" href="/assets/js/8.3616387d.js"><link rel="prefetch" href="/assets/js/80.dda2cb25.js"><link rel="prefetch" href="/assets/js/81.2f232306.js"><link rel="prefetch" href="/assets/js/82.df6bca63.js"><link rel="prefetch" href="/assets/js/83.6251af59.js"><link rel="prefetch" href="/assets/js/84.d3eda27f.js"><link rel="prefetch" href="/assets/js/85.71180abd.js"><link rel="prefetch" href="/assets/js/86.3c5a5f86.js"><link rel="prefetch" href="/assets/js/87.12474af5.js"><link rel="prefetch" href="/assets/js/9.c04fa05e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e8ff0ee6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">SmacUL's Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/self/" class="nav-link">关于我</a></div><div class="nav-item"><a href="https://github.com/SmacUL" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/self/" class="nav-link">关于我</a></div><div class="nav-item"><a href="https://github.com/SmacUL" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/log/seed_labs/" class="sidebar-link">Seed Labs</a></li><li><a href="/log/seed_labs/Cross-Site Scripting Attack.html" class="sidebar-link">Cross-Site Scripting Attack</a></li><li><a href="/log/seed_labs/SQL Injection Attack Lab.html" class="sidebar-link">SQL Injection Attack Lab</a></li><li><a href="/log/seed_labs/Buffer-Overflow Vulnerability Lab.html" class="sidebar-link">Buffer-Overflow Vulnerability Lab</a></li><li><a href="/log/seed_labs/Packet Sniffing and Spoofing Lab.html" class="sidebar-link">Packet Sniffing and Spoofing Lab</a></li><li><a href="/log/seed_labs/Public-Key Infrastructure Lab.html" class="active sidebar-link">Public-Key Infrastructure Lab</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/log/seed_labs/Public-Key Infrastructure Lab.html#pre-experiment" class="sidebar-link">Pre-Experiment</a></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Public-Key Infrastructure Lab.html#t1-becoming-a-certification-authority-ca" class="sidebar-link">T1 Becoming a Certification Authority (CA)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/log/seed_labs/Public-Key Infrastructure Lab.html#the-configuration-file" class="sidebar-link">The Configuration File</a></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Public-Key Infrastructure Lab.html#certificate-authority-ca" class="sidebar-link">Certificate Authority (CA)</a></li></ul></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Public-Key Infrastructure Lab.html#t2-creating-a-certification-for-seedpkilab2018-com" class="sidebar-link">T2 Creating a Certification for SEEDPKILab2018.com</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/log/seed_labs/Public-Key Infrastructure Lab.html#t1-1-generate-public-private-key-pair" class="sidebar-link">T1.1 Generate public/private key pair</a></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Public-Key Infrastructure Lab.html#t1-2-generate-a-certificate-signing-request-csr" class="sidebar-link">T1.2 Generate a Certificate Signing Request (CSR)</a></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Public-Key Infrastructure Lab.html#t1-3-generating-certificates" class="sidebar-link">T1.3 Generating Certificates</a></li></ul></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Public-Key Infrastructure Lab.html#t3-deploying-certificate-in-an-https-web-server" class="sidebar-link">T3 Deploying Certificate in an HTTPS Web Server</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/log/seed_labs/Public-Key Infrastructure Lab.html#t3-1-configuring-dns" class="sidebar-link">T3.1 Configuring DNS</a></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Public-Key Infrastructure Lab.html#t3-2-configuring-the-web-server" class="sidebar-link">T3.2 Configuring the web server</a></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Public-Key Infrastructure Lab.html#t3-3-getting-the-browser-to-accept-our-ca-certificate" class="sidebar-link">T3.3 Getting the browser to accept our CA Certificate</a></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Public-Key Infrastructure Lab.html#t3-4-testing-our-https-website" class="sidebar-link">T3.4 Testing our HTTPS website</a></li></ul></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Public-Key Infrastructure Lab.html#t4-deploying-certificate-in-an-apache-based-https-website" class="sidebar-link">T4 Deploying Certificate in an Apache-Based HTTPS Website</a></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Public-Key Infrastructure Lab.html#t5-launching-a-man-in-the-middle-attack" class="sidebar-link">T5 Launching a Man-In-The-Middle Attack</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/log/seed_labs/Public-Key Infrastructure Lab.html#t5-1-setting-up-malicious-websites" class="sidebar-link">T5.1 Setting up malicious websites</a></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Public-Key Infrastructure Lab.html#t5-2-becoming-the-man-in-the-middle" class="sidebar-link">T5.2 Becoming the man in the middle</a></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Public-Key Infrastructure Lab.html#t5-3-browse-the-target-website" class="sidebar-link">T5.3 Browse the target website</a></li></ul></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Public-Key Infrastructure Lab.html#t6-launching-a-man-in-the-middle-attack-with-a-compromised-ca" class="sidebar-link">T6 Launching a Man-In-The-Middle Attack with a Compromised CA</a></li></ul></li><li><a href="/log/seed_labs/Local DNS Attack Lab.html" class="sidebar-link">Local DNS Attack Lab</a></li><li><a href="/log/seed_labs/Remote DNS Cache Poisoning Attack Lab.html" class="sidebar-link">Remote DNS Cache Poisoning Attack Lab</a></li><li><a href="/log/seed_labs/Android Repackaging Attack Lab.html" class="sidebar-link">Android Repackaging Attack Lab</a></li><li><a href="/log/seed_labs/Return-to-libc Attack Lab.html" class="sidebar-link">Return-to-libc Attack Lab</a></li><li><a href="/log/seed_labs/Virtual Private Network Lab.html" class="sidebar-link">Virtual Private Network Lab</a></li><li><a href="/log/seed_labs/Heartbleed Attack Lab.html" class="sidebar-link">Heartbleed Attack Lab</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="public-key-infrastructure-lab"><a href="#public-key-infrastructure-lab" class="header-anchor">#</a> Public-Key Infrastructure Lab</h1> <h2 id="pre-experiment"><a href="#pre-experiment" class="header-anchor">#</a> Pre-Experiment</h2> <p>一个基础性的问题是没有一个简单的方式去验证公钥的所有者.
如何保证公钥确实属于 claimed 所有者.
Public Key Infrastructure PKI 是一种非常经典的解决方案.</p> <p>我们将在这个实验中理解 Public-Key-Infrastructure 能够得到信任的根源, 如果系统信任了这样的漏洞.</p> <p>几个主题:</p> <ul><li>公钥编码</li> <li>public key infrastructure</li> <li>CA 以及 根 CA</li> <li>X.509 和自我签名</li> <li>Apache HTTP and HTTPS</li> <li>man in the middle attacks? (中间人攻击?)</li></ul> <p>在这个实验中, 我们还将使用到 openssl 命令和库.</p> <p><a href="https://seedsecuritylabs.org/Labs_16.04/PDF/Crypto_PKI.pdf" target="_blank" rel="noopener noreferrer">实验指导<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="t1-becoming-a-certification-authority-ca"><a href="#t1-becoming-a-certification-authority-ca" class="header-anchor">#</a> T1 Becoming a Certification Authority (CA)</h2> <p>在这个实验中, 我们需要创建 digital certificates, 我们自己做自己的 CA. 然后使用这个 CA 来给别的什么东西提供验证服务.</p> <h3 id="the-configuration-file"><a href="#the-configuration-file" class="header-anchor">#</a> The Configuration File</h3> <p>有一个文件 <em>openssl.conf</em>.
这里有一个问题: 就是 OpenSSL 是什么.
需要现有 <em>openssl.conf</em> 文件, 然后使用 OpenSSL 生成 certificates.</p> <p>ATC 我们可能需要处理一下 openssl 这玩意</p> <p>openssl 一共有三个命令: ca, req, x509.
<code>/usr/lib/ssl/openssl.cnf</code> 可以提供这样的配置文件, 可以复制他.</p> <p>然后在 <em>openssl.cnf</em> 所在的目录下, 创建几个子目录与文件.</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>$ <span class="token function">mkdir</span> demoCA demoCA/certs demoCA/crl demoCA/newcerts
$ <span class="token builtin class-name">echo</span> <span class="token operator">&gt;</span> demoCA/index.txt
$ <span class="token builtin class-name">echo</span> <span class="token number">1000</span> <span class="token operator">&gt;</span> demoCA/serial
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">关于 index.txt 与 serial 文件的内容</p> <p><em>index.txt</em> 内容为空. 特别注意, 能够打开 <em>index.txt</em> 文件的软件 (例如 gedit) 一定要用 tab 替换成 backspace.<br>
serial 可以填入其他的数字, 他的功能应该就是个计数器.</p></div> <h3 id="certificate-authority-ca"><a href="#certificate-authority-ca" class="header-anchor">#</a> Certificate Authority (CA)</h3> <p>这一步好像是创建 Certifate Authority</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>$ openssl req -new -x509 -keyout ca.key -out ca.crt -config openssl.cnf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>上面的指令获得两个输出文件: <em>ca.key</em> (私钥证书)和 <em>ca.crt</em> (公钥证书)</p> <h2 id="t2-creating-a-certification-for-seedpkilab2018-com"><a href="#t2-creating-a-certification-for-seedpkilab2018-com" class="header-anchor">#</a> T2 Creating a Certification for SEEDPKILab2018.com</h2> <p>现在我们有能力给出 digital certificates. 第一个公司叫做 <em>SEEDPKILab2018.com</em>.</p> <h3 id="t1-1-generate-public-private-key-pair"><a href="#t1-1-generate-public-private-key-pair" class="header-anchor">#</a> T1.1 Generate public/private key pair</h3> <p>我们需要有公钥和私钥对.  RSA.</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>$ openssl genrsa -aes128 -out server.key <span class="token number">1024</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>使用 aes128 encryption algorithm. 秘钥存在在 <em>server.key</em>. 另一条指令可以将 <em>server.key</em> 转成文本, 方便阅读.</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>$ openssl rsa -in server.key -text
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>指令 <code>openssl rsa -in server.key -out server.key.unsecure</code> 可以获得免密的 server key.</p></div> <h3 id="t1-2-generate-a-certificate-signing-request-csr"><a href="#t1-2-generate-a-certificate-signing-request-csr" class="header-anchor">#</a> T1.2 Generate a Certificate Signing Request (CSR)</h3> <p>CSR 也就是证书签名申请? 包含了企业的公钥?
CSR 会被送给 CA, CA 将生成秘钥的证书.</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment"># 这一步中要在 common_name 一条中输入 seedpkilab2018.com 绑定站点, 其他内容可以不填</span>
$ openssl req -new -key server.key -out server.csr -config openssl.cnf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>依据描述, certificate signing request 和 certificate authority 是一对的.</p> <h3 id="t1-3-generating-certificates"><a href="#t1-3-generating-certificates" class="header-anchor">#</a> T1.3 Generating Certificates</h3> <p>CSR file 需要有 CA 的签名才能产出证书.
在实验最开始的时候, 我们就有了自己的 CA.</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>$ openssl ca -in server.csr -out server.crt -cert ca.crt -keyfile ca.key -config openssl.cnf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>实验指导中给出了 如果 CA 拒绝生成证书的解决方案.</p> <p><img src="/note/img/2020-02-23-11-23-57.png" alt=""></p> <h2 id="t3-deploying-certificate-in-an-https-web-server"><a href="#t3-deploying-certificate-in-an-https-web-server" class="header-anchor">#</a> T3 Deploying Certificate in an HTTPS Web Server</h2> <p>这一步, 我们将 public-key 用在网站上. 使用 openssl 内建的 web 服务器去建立一个 HTTPS 的站点.</p> <h3 id="t3-1-configuring-dns"><a href="#t3-1-configuring-dns" class="header-anchor">#</a> T3.1 Configuring DNS</h3> <p>配置 DNS, 修改 <code>/etc/hosts</code>, 配置 <code>127.0.0.1 SEEDPKILab2018.com</code></p> <h3 id="t3-2-configuring-the-web-server"><a href="#t3-2-configuring-the-web-server" class="header-anchor">#</a> T3.2 Configuring the web server</h3> <p>配置 web 服务器.</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>$ <span class="token function">cp</span> server.key server.pem
$ <span class="token function">cat</span> server.crt <span class="token operator">&gt;&gt;</span> server.pem
$ openssl s_server -cert server.pem -www
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>现在, 服务将会监听 4433 端口.
使用 <code>https://SEEDPKILab2018.com:4433/</code>
来访问.
不出意外的话, 我们会收到一份来自浏览器的错误信息. 大概是说当前的网站没有合法的证书.</p> <p><img src="/note/img/2020-02-23-11-21-21.png" alt=""></p> <h3 id="t3-3-getting-the-browser-to-accept-our-ca-certificate"><a href="#t3-3-getting-the-browser-to-accept-our-ca-certificate" class="header-anchor">#</a> T3.3 Getting the browser to accept our CA Certificate</h3> <p>让浏览器接受 CA 证书. 有两种方式:</p> <ol><li>请求 Mozilla 去包含我们的 CA 证书在 FireFox 软件, 用屁股想都知道这不可能.</li> <li>让浏览器加载 <em>ca.crt</em> (公钥证书) <code>Edit -&gt; Preference-&gt; Privacy &amp; Security -&gt; View Certificates</code></li></ol> <h3 id="t3-4-testing-our-https-website"><a href="#t3-4-testing-our-https-website" class="header-anchor">#</a> T3.4 Testing our HTTPS website</h3> <p>测试我们的 HTTPS 网站. 重新操作 Step2.</p> <p>然后我们需要重复接下来的任务:</p> <ol><li>仅仅修改 <em>server.pem</em> 中的一位, 重启服务器, 重载 URL, (请先备份 <em>server.pem</em>) 另外, 如果服务起不来, 可能是 <em>server.pem</em> 不该改的位置被改了. 并不会有什么影响.</li> <li>尝试使用 https://localhost:4433 , 我感觉应该会不行. 的确不行, 仍然会显示是一个没有认证过的网站, 不允许访问. 本地 CA 没有对 localhost 进行授权.</li></ol> <h2 id="t4-deploying-certificate-in-an-apache-based-https-website"><a href="#t4-deploying-certificate-in-an-apache-based-https-website" class="header-anchor">#</a> T4 Deploying Certificate in an Apache-Based HTTPS Website</h2> <p>在一个 Apache-Based HTTPS website 中使用证书. 在这个实验中, 我们建立了一个真实的 HTTPS web server based on Apache.</p> <p>实验指导给出了 example.com 的参考, 然后我们需要对 SEEDPKILab2018.com 也做一遍.</p> <h4 id="部署一个小项目"><a href="#部署一个小项目" class="header-anchor">#</a> 部署一个小项目</h4> <p>先在 Apache 的目录下部署一个项目:</p> <ol><li>在路径 <code>/var/www/</code> 添加 <code>pki</code> 文件夹</li> <li>在 <code>pki</code> 文件夹内添加 <code>index.html</code>, html 内容随意.</li></ol> <h4 id="使用-http-浏览项目"><a href="#使用-http-浏览项目" class="header-anchor">#</a> 使用 HTTP 浏览项目</h4> <p>修改 <code>/etc/apache2/site-available/000-default.conf</code>, 添加</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token operator">&lt;</span>VirtualHost *:8<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span>
    ServerName SEEDPKILab2018.com
    DocumentRoot /var/www/pki
<span class="token operator">&lt;</span>/VirtualHost<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>现在重启 apache2 的 service, 并访问 <code>http://seedpkilab2018.com</code> 应该可以看见 index.html 中内容.</p> <h4 id="使用-https-浏览项目"><a href="#使用-https-浏览项目" class="header-anchor">#</a> 使用 HTTPS 浏览项目</h4> <p>修改 <code>/etc/apache2/site-available/default-ssl.conf</code>, 添加</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token operator">&lt;</span>VirtualHost *:44<span class="token operator"><span class="token file-descriptor important">3</span>&gt;</span>
    ServerName SEEDPKILab2018.com
    DocumentRoot /var/www/pki
    DirectoryIndex index.html

    SSLEngine On
    SSLCertificateFile /home/seed/Desktop/server.pem
    SSLCertificateKeyFile /home/seed/Desktop/server.pem 
<span class="token operator">&lt;</span>/VirtualHost<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><div class="language-sh line-numbers-mode"><pre class="language-sh"><code>$ <span class="token function">sudo</span> apachectl configtest
$ <span class="token function">sudo</span> a2enmod ssl
$ <span class="token function">sudo</span> a2ensite default-ssl
$ <span class="token function">sudo</span> <span class="token function">service</span> apache2 restart
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>使用 HTTPS 协议访问 <code>https://seedpkilab2018.com</code> 应该再次可以看见 index.html 中内容.</p> <h2 id="t5-launching-a-man-in-the-middle-attack"><a href="#t5-launching-a-man-in-the-middle-attack" class="header-anchor">#</a> T5 Launching a Man-In-The-Middle Attack</h2> <p>这一步主要展示: PKI 如何打败中间人攻击.</p> <p>如果没有 PKI, 用户在访问 example.com 的时候就需要获取 server 的 public key.
Alice 将会生成一个 secert, 然后使用 server 的 public key 去编码这个 secert. 然后再发给 Server.</p> <p>攻击者可能拦截 Server 给出的 public key 然后替换成自己的 public key 再发给 用户. 如此攻击者是有能力读取用户发出的数据.</p> <p>这个实验的主要目的就是帮助学生理解 PKI 如何打败这样的中间人攻击. 在这个攻击中, 我们将会模拟一个这样的 MITM 攻击, 然后看 PKI 如何击败它.</p> <p>首先我们需要选择一个 website. 讲道理, example 是一个不错的选择, 但是这里更加建议使用一个现实的站点?</p> <p>ATC: 这里需要作出一个假设, 用户实际访问的是 example.com 这个 web server. 但是, 我们假装发动了一次 DNS 缓存毒化攻击, 将 hosts 修改为 那个什么 2018 的 网站 ip, 也就是攻击者的网站 IP. 这样就创建了 attacker 与 victim 之间的通信.</p> <h3 id="t5-1-setting-up-malicious-websites"><a href="#t5-1-setting-up-malicious-websites" class="header-anchor">#</a> T5.1 Setting up malicious websites</h3> <p>这里的操作会模仿 T4 中的内容.</p> <p>我们的目标是这样的: 当一个用户打算访问 example.com 的时候, 我们把他引到自己的 server, hosts 了一个假的 website for example.com. 然后他们可能在者之间写些什么东西.</p> <p>模仿 T4 中的操作, 创建一个 <code>www.apple.com</code> 的 ssl server.</p> <h3 id="t5-2-becoming-the-man-in-the-middle"><a href="#t5-2-becoming-the-man-in-the-middle" class="header-anchor">#</a> T5.2 Becoming the man in the middle</h3> <p>成为那个中间人. 可以攻击路由或者攻击 DNS. 这一步, 我们选择 DNS 攻击. 为了简化操作, 我们直接修改受害者的 <code>/etc/hosts</code>. 去模拟一个 DNS 缓存毒化攻击.
<code>&lt;IP_Address&gt; example.com</code>
这里的 IP_Address 应该是 malicious server 的 ip.</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token number">10.0</span>.2.14  www.apple.com
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="t5-3-browse-the-target-website"><a href="#t5-3-browse-the-target-website" class="header-anchor">#</a> T5.3 Browse the target website</h3> <p>重新浏览目标网站, 看看自己的浏览器说了什么.</p> <p>浏览器表示: &quot;警告: 面临潜在的安全风险.&quot; 没有任何 CA 对我们自己的 <code>www.apple.com</code> ssl server 颁发证书.</p> <h2 id="t6-launching-a-man-in-the-middle-attack-with-a-compromised-ca"><a href="#t6-launching-a-man-in-the-middle-attack-with-a-compromised-ca" class="header-anchor">#</a> T6 Launching a Man-In-The-Middle Attack with a Compromised CA</h2> <p>这里做出了一个假设, 就是我们的 CA 已经被人收买, 给 <code>www.apple.com</code> 创建 cert.</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">3/24/2020, 2:15:52 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/log/seed_labs/Packet Sniffing and Spoofing Lab.html" class="prev">Packet Sniffing and Spoofing Lab</a></span> <span class="next"><a href="/log/seed_labs/Local DNS Attack Lab.html">Local DNS Attack Lab</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.27d58fa7.js" defer></script><script src="/assets/js/2.f1f09924.js" defer></script><script src="/assets/js/40.1b57eaa8.js" defer></script>
  </body>
</html>
