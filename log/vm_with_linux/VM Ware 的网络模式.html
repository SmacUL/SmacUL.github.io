<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>VM Ware 的网络模式 | SmacUL&#39;s Blog</title>
    <meta name="description" content="你好">
    <link rel="icon" href="/assets/img/Logo.png">
    
    <link rel="preload" href="/assets/css/0.styles.e8ff0ee6.css" as="style"><link rel="preload" href="/assets/js/app.27d58fa7.js" as="script"><link rel="preload" href="/assets/js/2.f1f09924.js" as="script"><link rel="preload" href="/assets/js/48.7f7c7f55.js" as="script"><link rel="prefetch" href="/assets/js/10.da04177b.js"><link rel="prefetch" href="/assets/js/11.33537db2.js"><link rel="prefetch" href="/assets/js/12.2c196981.js"><link rel="prefetch" href="/assets/js/13.501a5542.js"><link rel="prefetch" href="/assets/js/14.93a9b12d.js"><link rel="prefetch" href="/assets/js/15.7ddd6566.js"><link rel="prefetch" href="/assets/js/16.32ee58e2.js"><link rel="prefetch" href="/assets/js/17.c415498a.js"><link rel="prefetch" href="/assets/js/18.5ef64d19.js"><link rel="prefetch" href="/assets/js/19.521006c9.js"><link rel="prefetch" href="/assets/js/20.1aa33ed7.js"><link rel="prefetch" href="/assets/js/21.82b9d691.js"><link rel="prefetch" href="/assets/js/22.793f9d85.js"><link rel="prefetch" href="/assets/js/23.0ca70d66.js"><link rel="prefetch" href="/assets/js/24.d86f1591.js"><link rel="prefetch" href="/assets/js/25.2ce3a84b.js"><link rel="prefetch" href="/assets/js/26.12cdc3ac.js"><link rel="prefetch" href="/assets/js/27.7b341d36.js"><link rel="prefetch" href="/assets/js/28.61c57439.js"><link rel="prefetch" href="/assets/js/29.90d6873f.js"><link rel="prefetch" href="/assets/js/3.7db0d588.js"><link rel="prefetch" href="/assets/js/30.4f5e13f5.js"><link rel="prefetch" href="/assets/js/31.7ec86adf.js"><link rel="prefetch" href="/assets/js/32.0c179479.js"><link rel="prefetch" href="/assets/js/33.b68ce17c.js"><link rel="prefetch" href="/assets/js/34.6d314a9c.js"><link rel="prefetch" href="/assets/js/35.15ecee78.js"><link rel="prefetch" href="/assets/js/36.d6998519.js"><link rel="prefetch" href="/assets/js/37.e84aeb89.js"><link rel="prefetch" href="/assets/js/38.8bd5bba9.js"><link rel="prefetch" href="/assets/js/39.ffd3bce6.js"><link rel="prefetch" href="/assets/js/4.9b31f553.js"><link rel="prefetch" href="/assets/js/40.1b57eaa8.js"><link rel="prefetch" href="/assets/js/41.ac6f9062.js"><link rel="prefetch" href="/assets/js/42.8854bf5a.js"><link rel="prefetch" href="/assets/js/43.91bf82a7.js"><link rel="prefetch" href="/assets/js/44.c35012af.js"><link rel="prefetch" href="/assets/js/45.07b8e581.js"><link rel="prefetch" href="/assets/js/46.02916103.js"><link rel="prefetch" href="/assets/js/47.f1be0d43.js"><link rel="prefetch" href="/assets/js/49.6692487b.js"><link rel="prefetch" href="/assets/js/5.23b29502.js"><link rel="prefetch" href="/assets/js/50.6c2f6d29.js"><link rel="prefetch" href="/assets/js/51.f7be7c31.js"><link rel="prefetch" href="/assets/js/52.b9dad83f.js"><link rel="prefetch" href="/assets/js/53.8f778f89.js"><link rel="prefetch" href="/assets/js/54.9853cbd5.js"><link rel="prefetch" href="/assets/js/55.f1dfad52.js"><link rel="prefetch" href="/assets/js/56.a89162ce.js"><link rel="prefetch" href="/assets/js/57.b1f1111f.js"><link rel="prefetch" href="/assets/js/58.08f753ab.js"><link rel="prefetch" href="/assets/js/59.e2ff4e09.js"><link rel="prefetch" href="/assets/js/6.ca86ed4c.js"><link rel="prefetch" href="/assets/js/60.14c1ce69.js"><link rel="prefetch" href="/assets/js/61.06a9c523.js"><link rel="prefetch" href="/assets/js/62.af6d0bf2.js"><link rel="prefetch" href="/assets/js/63.47139735.js"><link rel="prefetch" href="/assets/js/64.1b3689b6.js"><link rel="prefetch" href="/assets/js/65.c599d8e8.js"><link rel="prefetch" href="/assets/js/66.91648506.js"><link rel="prefetch" href="/assets/js/67.ecf7742c.js"><link rel="prefetch" href="/assets/js/68.b8769d15.js"><link rel="prefetch" href="/assets/js/69.e055ff05.js"><link rel="prefetch" href="/assets/js/7.9d170f74.js"><link rel="prefetch" href="/assets/js/70.065d9e72.js"><link rel="prefetch" href="/assets/js/71.840612b5.js"><link rel="prefetch" href="/assets/js/72.2a605e0c.js"><link rel="prefetch" href="/assets/js/73.3e54fae5.js"><link rel="prefetch" href="/assets/js/74.8e626e7b.js"><link rel="prefetch" href="/assets/js/75.c64b57c0.js"><link rel="prefetch" href="/assets/js/76.0e7007be.js"><link rel="prefetch" href="/assets/js/77.c8b770b0.js"><link rel="prefetch" href="/assets/js/78.d7da3c62.js"><link rel="prefetch" href="/assets/js/79.a78c6d63.js"><link rel="prefetch" href="/assets/js/8.3616387d.js"><link rel="prefetch" href="/assets/js/80.dda2cb25.js"><link rel="prefetch" href="/assets/js/81.2f232306.js"><link rel="prefetch" href="/assets/js/82.df6bca63.js"><link rel="prefetch" href="/assets/js/83.6251af59.js"><link rel="prefetch" href="/assets/js/84.d3eda27f.js"><link rel="prefetch" href="/assets/js/85.71180abd.js"><link rel="prefetch" href="/assets/js/86.3c5a5f86.js"><link rel="prefetch" href="/assets/js/87.12474af5.js"><link rel="prefetch" href="/assets/js/9.c04fa05e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e8ff0ee6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">SmacUL's Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/self/" class="nav-link">关于我</a></div><div class="nav-item"><a href="https://github.com/SmacUL" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/self/" class="nav-link">关于我</a></div><div class="nav-item"><a href="https://github.com/SmacUL" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/log/vm_with_linux/" class="sidebar-link">VM Ware 与 Linux 的故事</a></li><li><a href="/log/vm_with_linux/VM Ware 的网络模式.html" class="active sidebar-link">VM Ware 的网络模式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/log/vm_with_linux/VM Ware 的网络模式.html#网络模式" class="sidebar-link">网络模式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/log/vm_with_linux/VM Ware 的网络模式.html#桥接" class="sidebar-link">桥接</a></li><li class="sidebar-sub-header"><a href="/log/vm_with_linux/VM Ware 的网络模式.html#nat-模式" class="sidebar-link">NAT 模式</a></li><li class="sidebar-sub-header"><a href="/log/vm_with_linux/VM Ware 的网络模式.html#仅主机模式" class="sidebar-link">仅主机模式</a></li></ul></li><li class="sidebar-sub-header"><a href="/log/vm_with_linux/VM Ware 的网络模式.html#创建一个稍微复杂点的网络" class="sidebar-link">创建一个稍微复杂点的网络</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/log/vm_with_linux/VM Ware 的网络模式.html#故事背景" class="sidebar-link">故事背景</a></li><li class="sidebar-sub-header"><a href="/log/vm_with_linux/VM Ware 的网络模式.html#创建" class="sidebar-link">创建</a></li><li class="sidebar-sub-header"><a href="/log/vm_with_linux/VM Ware 的网络模式.html#效果" class="sidebar-link">效果</a></li><li class="sidebar-sub-header"><a href="/log/vm_with_linux/VM Ware 的网络模式.html#意外的情况" class="sidebar-link">意外的情况</a></li></ul></li><li class="sidebar-sub-header"><a href="/log/vm_with_linux/VM Ware 的网络模式.html#总结与参考" class="sidebar-link">总结与参考</a></li></ul></li><li><a href="/log/vm_with_linux/遇到的 CentOS 的网络问题.html" class="sidebar-link">遇到的 CentOS 的网络问题</a></li><li><a href="/log/vm_with_linux/CentOS7 安装 OpenVPN.html" class="sidebar-link">CentOS7 安装 OpenVPN</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="vm-ware-的网络模式"><a href="#vm-ware-的网络模式" class="header-anchor">#</a> VM Ware 的网络模式</h1> <p>本文主要介绍 VM 的三种网络模式: 桥接, NAT, 仅主机(Host-Only), 然后尝试创建一个包含内网的网络结构. 全文基于 Win-VM15 专业版.</p> <h2 id="网络模式"><a href="#网络模式" class="header-anchor">#</a> 网络模式</h2> <p>默认情况下 VM 针对它的三种网络模式提供了三种虚拟网络适配器: vmnet0, 处理桥接; vmnet1, 处理 Host-Only 网络模式; vmnet8 处理 NAT 模式. 如果我们使用 Win 系统中的 CMD 或是 Mac 中的 Terminal, 使用 <code>ifconfig</code> 或是 <code>ipconfig</code> 命令总能看到系统中拥有的各种适配器, 其中就能看到 vmnet1 和 vmnet8.</p> <p>现在先假设我们的宿主机的 IP 为 192.168.1.101. 现实中, 我们的路由器总是习惯开一个 192.168.1.**\24 的网段出来.</p> <h3 id="桥接"><a href="#桥接" class="header-anchor">#</a> 桥接</h3> <p>虚拟机将被分配一个网络中的独立 IP, 比如 192.168.1.102, 它与宿主机在同一个子网下. 在外网设备看来, 宿主机与虚拟机是平起平坐的. 宿主机与虚拟机之间可以相互 ping 通.</p> <p>如果我们从 VM 的角度看过去, VM 为虚拟机创建了一个虚拟网卡. 不要忘了宿主机中已经有了一个虚拟网络适配器: vmnet0, 这里 vmnet0 的作用与交换机类似. 虚拟机的虚拟网卡与宿主机的物理网卡可以看做是接入了 vmnet0 中. 这里涉及到的两张网卡与 vmnet0 都工作在 192.168.1.**\24 网段下.</p> <p><img src="/note/img/2020-08-01-23-03-06.png" alt=""></p> <p>桥接的方式用起来能让我们的虚拟机在网络中看起来更加真实. 我们甚至可以在主机 A 中通过 ssh 访问同网段下的主机 B 中的桥接模式的虚拟机. 但是, 桥接毛病也是有的, 需要占用宿主机所在的网段中的一个 IP. 如果 IP 资源紧张或是被限制申请使用, 桥接模式就不能很好地工作.</p> <h3 id="nat-模式"><a href="#nat-模式" class="header-anchor">#</a> NAT 模式</h3> <p>NAT: Network Address Translation. 在虚拟机想访问其他网络设备时, VM 会将虚拟系统的IP地址转换成宿主机的IP地址，从而达到访问其他主机及外网的目的。在外网看来, 宿主机挂记在主机下并伪装成主机, 连接外网.</p> <p>这种网络模式下, VM 会默默地做很多事情. 首先是创建提供 NAT 服务的虚拟设备, 宿主机的物理网卡在收发虚拟机的数据时都要利用这台 NAT 服务器. 接下来, VM 需要为虚拟机和物理机创建虚拟网卡, 并将两张虚拟网卡接入到虚拟网路适配器 VMnet8 中, 这里 VMnet8 开了一个子网出来, 同时还扮演网关的角色. 到这个时候, 宿主机已经有两张网卡, 它可以同时与两个不同网段下的设备通信, 例如 <code>192.168.1.**/24</code> 与 <code>192.168.200.**/24</code>.</p> <p><img src="/note/img/2020-08-01-23-03-36.png" alt=""></p> <p>简单且不专业地说, 如果位于 <code>192.168.200.**/24</code> 网段下的虚拟机打算发送数据给 Google.com, 当 IP 包通过虚拟机虚拟网卡来到宿主机, 宿主机利用 NAT 服务器更换 IP 包的源地址为 <code>192.168.1.101</code>, 最后通过物理网卡发送出去.</p> <h3 id="仅主机模式"><a href="#仅主机模式" class="header-anchor">#</a> 仅主机模式</h3> <p>虚拟机只与主机相连, 虚拟机与外网的通信共享主机的网卡. 简单地看, 仅主机模式就像 NAT 模式砍掉了 NAT 服务器. VMnet1 也开了一个子网, 同时充当网关的角色, 但是数据从虚拟机出来就只能在子网中流动 (本质上, 宿主机可以看做是子网中的成员).</p> <p><img src="/note/img/2020-08-01-23-04-01.png" alt=""></p> <p>这玩意在创建内网的时候贼好使.</p> <h2 id="创建一个稍微复杂点的网络"><a href="#创建一个稍微复杂点的网络" class="header-anchor">#</a> 创建一个稍微复杂点的网络</h2> <h3 id="故事背景"><a href="#故事背景" class="header-anchor">#</a> 故事背景</h3> <p>XX 公司的服务器们: 一台网站服务器, 向普通用户提供公司主页服务; 两台数据服务器, 为网站服务器提供支持. 公司为自家服务器们创建了一个网络, 要求普通用户能够访问网站服务器, 但是无法访问数据服务器; 而网站服务器与数据服务器之间可以相互访问. 如下图:</p> <p><img src="/note/img/2020-08-01-21-42-48.png" alt=""></p> <p>假设我们叫做张三. 我们尝试在 VM 中利用 CentOS 创建出这样的网络. 显然网站服务器比较特殊, 需要两张网卡同时连接两个网段. 为了简单起见, 我们认为网站服务器与张三的机子在同一个局域网下.</p> <h3 id="创建"><a href="#创建" class="header-anchor">#</a> 创建</h3> <p>虚拟机们使用的适配器:</p> <ul><li>数据服务器 1:<br>
host-only (vmnet1)</li> <li>数据服务器 2:<br>
host-only (vmnet1)</li> <li>网站服务器:<br>
桥接 (vmnet0) &amp;&amp; host-only (vmnet1)</li> <li>张三的机子:<br>
桥接 (vmnet0)</li></ul> <p>在虚拟机的设置中可以自由添加或修改网络适配器.</p> <h3 id="效果"><a href="#效果" class="header-anchor">#</a> 效果</h3> <p>虚拟机们的网卡状态 (每台机子都不一样):</p> <ul><li>数据服务器 1:<br>
ens33: 192.168.20.129/24</li> <li>数据服务器 2:<br>
ens33: 192.168.20.130/24</li> <li>网站服务器:<br>
ens33: 192.168.1.105/24 (vmnet0)<br>
ens37: 192.168.20.128/24 (vmnet1)</li> <li>张三的机子:<br>
ens33: 192.168.1.108/24</li></ul> <p>这里创建了两个网段: <code>192.168.20.**/24</code> 以及 <code>192.168.1.**/24</code> (宿主机也在这个网段下). 我们可以使用 ping 命令随意测试.</p> <p>其实吧, 再创建一个 vmnet2, 然后两个桥接的换成 vmnet2 也会有一样的效果, 就是宿主机会连不上.</p> <h3 id="意外的情况"><a href="#意外的情况" class="header-anchor">#</a> 意外的情况</h3> <p>在宿主机使用 WiFi 连接的情况下, 将虚拟机的网络状态从 NAT 切换为桥接状态时, 虚拟机的网络状态并不会立刻改变, 需要等一段时间. 网线连接时体验会好得多.</p> <p>如果在给虚拟机添加网络适配器后, 没有达到预期的效果, 检查一下 <code>systemctl status network.service</code> 看看有没有错误, 比如说 <code>failed to start LSB</code>. 可以尝试重启 NetworkManager <code>systemctl restart NetworkManager</code> 与 network.service <code>systemctl restart network.service</code>.</p> <h2 id="总结与参考"><a href="#总结与参考" class="header-anchor">#</a> 总结与参考</h2> <p>桥接能够让虚拟机和宿主平起平坐, 结构简单, 但是必然会占用内网 IP; 而 NAT 模式虽然复杂一些, 但是通过将虚拟机挂记到宿主机的方式, 不需要考虑内网 IP 的分配情况, 是一种更加通用的手段. Host-Only 则是创建自定义网络结构的神器.</p> <p>VM 也允许我们创建除三个模式适配器以外的适配器, vmnet2~vmnet7, 以及 vmnet9, 但是貌似网络模式只能选择 Host-Only. 所有的网络适配器可以在 VM 中的虚拟网络编辑器中进行修改.</p> <p><a href="https://www.cnblogs.com/sddai/p/9280119.html" target="_blank" rel="noopener noreferrer">戴思达-深入理解 VMware 虚拟机网络通信原理<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">11/4/2020, 8:13:01 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/log/vm_with_linux/" class="prev router-link-active">VM Ware 与 Linux 的故事</a></span> <span class="next"><a href="/log/vm_with_linux/遇到的 CentOS 的网络问题.html">遇到的 CentOS 的网络问题</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.27d58fa7.js" defer></script><script src="/assets/js/2.f1f09924.js" defer></script><script src="/assets/js/48.7f7c7f55.js" defer></script>
  </body>
</html>
