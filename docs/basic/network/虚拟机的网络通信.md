# 虚拟机的网络通信
::: warning
虚拟机的网络比我一开始想象的要复杂, 这里的内容更多针对 VMware. 
:::

如果思考一下, 不难得出, 通信的对象主要是宿主机, 虚拟机与各种外网设备. 那么通信也包括宿主与虚拟机之间, 虚拟机与外网之间, 宿主与外网之间. 在这个过程中, 虚拟机软件的作用是提供并分配必要的虚拟网络设备, 包括网卡\ 交换机\ NAT 服务器等. 

虚拟机通信方式包括桥接\ NAT 模式\ 仅主机模式. 

## 桥接
被分配了一个网络中的独立 IP , 与宿主机在同一个子网下. 在外网设备看来, 主机与虚拟机是平起平坐的. 

### 主要设备创建
- 虚拟交换机
- 虚拟机的虚拟网卡

### 通信规则

虚拟机被分配了虚拟网卡并接入虚拟交换机中, 虚拟网卡使虚拟机拥有一个可以使用的 IP. 同时, 宿主的物理网卡也会接入虚拟交换机, 而且物理网卡实际上承担了虚拟交换机与外网通信的任务. 这样, 在外网看来, 宿主就和虚拟机一样, 收发数据时都要经过虚拟交换机, 而宿主和虚拟机就像在一个局域网下, 可以相互通气. 

::: tip
局域网中, IP 资源有限, 往往会利用 DHCP 服务器来管理分配 IP. 
:::

## NAT 模式
Network Address Translation. 将虚拟系统的IP地址转换成宿主机的IP地址，从而借用宿主机访问其他主机及外网。在外网看来, 宿主机挂记在主机下并伪装成主机, 连接外网. 

### 主要设备创建
- 虚拟交换机
- 虚拟 NAT 服务器
- 虚拟机的虚拟网卡
- 宿主机的虚拟网卡
- NAT 服务器的虚拟网卡

### 通信规则

创建了虚拟网卡的都要接入交换机中. 这里宿主机同时拥有两张网卡. 

当虚拟机与宿主之间通信的时候, 宿主使用虚拟网卡, 他们的通信状态和桥接模式差别不大. 当虚拟想要和外网通信的时候, 虚拟机会通过交换机与 NAT 服务器通气, NAT 服务器会将虚拟机虚拟网卡的 ip 转化为宿主机物理网卡的 ip, 换句话说就是伪装成了物理机. 

## 仅主机模式
虚拟机只与主机相连, 虚拟机与外网的通信共享主机的网卡.

## 总结与参考

桥接能够让虚拟机和宿主平起平坐, 结构简单, 但是必然会占用内网 IP; 而 NAT 模式虽然复杂一些, 但是通过将虚拟机挂记到宿主机的方式, 不需要考虑内网 IP 的分配情况, 是一种更加通用的手段. 

[戴思达-深入理解 VMware 虚拟机网络通信原理](https://www.cnblogs.com/sddai/p/9280119.html)
