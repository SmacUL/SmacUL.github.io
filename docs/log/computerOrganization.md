# 3 系统总线

连接计算机系统内部各部件的一组公共信息传输线


## 总线的分类
- 片内总线  
    芯片内部的总线
- 系统总线  
  计算机系统各大部件之间的信息传输线
    - 数据总线  
        传输各个部件之间的数据信息（双向传输）
    - 地址总线  
        指出数据总线上的源数据或目的数据在主存单元的地址或I/O设备的地址（单向传输）
    - 控制总线  
        发出各种控制信号的传输线（对单一控制线而言是单向的，对控制线整体而言是双向的）
- 通信总线  
    用于计算机系统之间或者计算机系统与外部系统之间的通信

## 总线性能指标
- 总线宽度  
    数据总线的根数，用位（bit）表示
- 总线带宽  
    总线传输速率，单位兆字节每秒（MBps）  
    $$带宽（MB/s） = \frac{频率（MHz） × 宽度（b）}{字节长度（b）}$$
- 时钟同步/异步  
    总线上的数据与时钟同步工作的总线称为同步总线;  
    总线上的数据与时钟不同步工作的总线称为异步总线;
- 总线复用  
    一条信号线上分时传递两种信号   
- 信号线数  
    系统总线的线数（数据总线、地址总线、控制总线）
- 总线控制方式
- 其他指标

## 总线标准
- 为了方便在总线上更换、组合各类模块和设备，建立了统一的总线标准  
- 概念：系统与各模块、模块与模块之间的一个互连的标准界面  
    界面对两端的模块都是透明的（不可见）

## 主设备与从设备
- 主设备：对总线有控制功能的设备（这里的控制是不是不太稳妥？）
- 从设备：对总线没有控制功能，只能响应主设备的命令

## 总线判优控制
决定哪个主设备享有对总线的使用权
- 集中式  
    控制逻辑集中在一处（如在CPU)
    - 链式查询
        - 离总线最近的部件有最高的优先级（排队轮流）
        - 构造简单，容易扩充设备
        - 对故障敏感
    - 计数器定时查询  
        - 多了一组设备地址线
        - 设备优先级固定不变（但可以修改）
        - 由计数器来决定设备的总线使用权
        - 对电路故障不敏感
        - 控制比较复杂
    - 独立请求方式
        - 每台设备均有一组总线请求线和总线同意线
        - 总线控制部件中有一个排队电路决定使用权
        - 控制灵活
        - 构造复杂
- 分布式  
    控制逻辑在多个部件上

## 总线通信控制
控制总线的通信（总线优先级，操作时间等）
完成一次总线操作的时间  
总线周期的四个阶段：  
1. 申请分配阶段  
    决定下一时期的总线使用权
2. 寻址阶段  
    获取了使用权的主设备通过总线获得本次要访问的从模块的地址和命令，启动从模块
3. 传数阶段  
    主从模块之间进行数据交换，经数据总线流入目的模块
4. 结束阶段  
    主模块测出总线，让出总线使用权

总线通信控制的四种方式  
- 同步通信  
- 异步通信  
- 半同步通信  
- 分离式通信  

<br>

# 5 输入输出系统

## 接口
接口是两个系统或两个部件之间的交接部分  
可以是连接电路，也可以是软件的共同逻辑边界  
主机与外设之间的信息交换桥梁

## I/O端口
在IO接口中一些寄存器，用于存放状态、数据、控制信息，通常称这些寄存器为IO端口

## I/O接口的组成
- 数据线  
    I/O设备与主机之间数据代码的传送线
- 设备选择线  
    传送设备码
- 命令线  
    传输CPU向设备发出的各种命令信号
- 状态线  
    向主机报告I/O设备的信号线

## I/O接口的功能
- 传送数据的功能
- 选址功能
- 传送命令的功能
- 反应I/O设备状态的功能

## I/O接口的类型
- 按数据传输方式分
    - 并行接口
    - 串行接口
- 按功能选择的灵活性分
    - 可编程接口
    - 不可编程接口
- 按通用性分
    - 通用接口
    - 专用接口
- 按数据传送的控制方式分
    - 程序型接口
    - DMA（Direct Memory Access）接口


## I/O方式
- 程序查询方式  
    CPU通过执行查询程序来完成对外设的控制
    1. CPU读取状态端口中的状态信息
    2. 如果接口就绪，CPU通过数据端口传送新的数据
    3. CPU查询外设是否空闲
    4. 如果空闲，发送控制信息到命令端口
    5. 接口发送启动命令给外设
- 程序中断方式  
    1. CPU启动外设后切换到其他程序
    2. 外设与CPU并行工作
    3. 外设完成工作后发送中断请求
    4. CPU暂停当前程序，执行中断程序
    5. 外设在CPU执行中断程序时准备下一步工作
- DMA方式  
    DMA方式适合像磁盘这样的设备，需要与主存发生大量的、成批的数据交换
    1. CPU传送数据数量、数据块地址、数据传输方向、设备地址等参数给DMA控制器
    2. CPU发送命令给DMA，启动外设
    3. CPU转到其他程序
    4. 外设与CPU并行工作
    5. DMA控制器负责外设与主存之间的数据传输
    6. DMA控制器在必要时申请总线控制权传送数据
    7. 传送结束后，DMA控制器发送中断给CPU
    8. CPU善后

## I/O设备的编址方式
- 独立编址  
    I/O端口与主存地址分开编码，应为二者可能会出现相同的编号，所以需要专门的I/O指令来区分
- 统一编址  
    I/O端口与主存统一编址，无需专门的输入输出指令

<br>

# 7 指令系统

## 指令格式
指令一般由操作码和地址码构成  
操作码的长度可以是固定的，也可以是变化的  
操作码长度不固定会大大增加指令译码和分析的难度，所以通常使用扩展操作码技术  

| 操作码字段 | 寻址特征 | 形式地址A |
| -- | -- | -- |


例题7.1

## 指令寻址
- 顺序寻址  
    程序计数器PC不断加1，自动形成下一条指令的地址
- 跳跃寻址  
    利用转移类指令实现

## 数据寻址
指令的地址码格式  
操作码 + 寻址特征 + 形式地址A
- 立即寻址  
    形式地址A是操作数本身（又称为立即数）
    ```
    操作数 = 形式地址A  
    ```  
- 直接寻址  
    形式地址A是操作数的真实地址
    ```
    真实地址 = 形式地址A
    操作数 = 取值[真实地址]
    ```
- 隐含寻址  
    操作数的地址隐藏在操作码或者某个寄存器中  
- 间接寻址  
    形式地址A存放了操作数真实地址的地址 
    ```
    真实地址 = *形式地址A
    操作数 = *真实地址
    ``` 
    指令执行时间长，但可以扩大寻址范围  
- 寄存器寻址  
    形式地址A记录了操作数所在的寄存器的编号 
    ```
    寄存器编号 = 形式地址A
    操作数 = *寄存器编号
    ``` 
    不需要访问主存  
- 寄存器间接寻址  
    形式地址A记录了操作数真实地址所在的寄存器的编号  
    ```
    寄存器编号 = 形式地址A
    真实地址 = *寄存器编号
    操作数 = *真实地址
    ``` 
    比间接寻址更加高效
- 基址寻址  
    基址寻址需要有基址寄存器（记录一个固定的值）  
    操作数的真实地址是基址寄存器的值与形式地址A的值之和
    ```
    const 基址值 = *基址寄存器编号
    真实地址 = *(基址值 + 形式地址A)
    操作数 = *真实地址
    ```
    适合递归程序
- 变址寻址  
    变址和基址非常类似（但是形式地址的值是不可变的）  
    变址寻址需要有变址寄存器  
    操作数的真实地址是变址寄存器的值与形式地址A的值之和
    ```
    const 形式地址A
    变址值 = *变址寄存器编号
    真实地址 = *(变址值 + 形式地址A)
    操作数 = *真实地址
    ```
    适合创建数组与循环
- 相对寻址  
    相对寻址需要程序计数器PC帮组  
    操作数的真实地址是PC值与形式地址A值的和  
    ```
    真实地址 = PC值 + 形式地址A
    操作数 = *真实地址
    ```
    此处形式地址A的值可正可负，需要用补码表示  
    形式地址A又称为位移量A
    适合写浮动程序
- 堆栈寻址  
    喵喵喵？

## 指令格式设计
## RISC（Reduced Instruction Set Computer）
精简指令系统计算机  
- 采用简化的指令系统  
- 采用大量寄存器来减少访存次数
- 复杂的操作需要配合软件实现

## CISC（Complex Instruction Set Computer）
复杂指令系统计算机  
- 具有丰富的指令
- 一些复杂的操作直接通过指令实现







